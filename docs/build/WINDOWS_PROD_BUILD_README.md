# Windows Production Build

**Purpose**: Create optimized, distributable installers for Windows.

**Time**: ~7-12 minutes for full release build

**Prerequisites**: [WINDOWS_DEPENDENCIES_README.md](WINDOWS_DEPENDENCIES_README.md) completed

---

## Quick Start

```powershell
cd desktop
cargo tauri build
```

**Output**: Windows installers in:
```
desktop\src-tauri\target\release\bundle\
├── msi\
│   └── Blazor Agile Board_0.1.0_x64_en-US.msi    # MSI installer
└── nsis\
    └── Blazor Agile Board_0.1.0_x64-setup.exe    # NSIS installer
```

---

## Installer Types

### MSI Installer (Recommended for Enterprise)

**Format**: Microsoft Windows Installer (.msi)

**Pros**:
- ✅ Group Policy deployment
- ✅ System Center / Intune support
- ✅ Clean uninstall
- ✅ Corporate IT preferred
- ✅ Windows logo certification

**Cons**:
- ⚠️ Requires elevated permissions
- ⚠️ Larger file size (~20-30 MB)
- ⚠️ Slower install/uninstall

**Generated by default** with `cargo tauri build`

---

### NSIS Installer (Recommended for End Users)

**Format**: Nullsoft Scriptable Install System (.exe)

**Pros**:
- ✅ Smaller file size (~18-25 MB)
- ✅ Faster installation
- ✅ Custom UI and branding
- ✅ Per-user install (no admin required)

**Cons**:
- ⚠️ Less enterprise-friendly
- ⚠️ Manual uninstall process

**Generated by default** with `cargo tauri build`

---

### Portable Build (No Installer)

**Format**: Standalone .exe

**Pros**:
- ✅ No installation required
- ✅ Run from USB drive
- ✅ No registry changes
- ✅ Smallest distribution

**Cons**:
- ⚠️ Manual updates
- ⚠️ No Start Menu shortcuts
- ⚠️ Users must manage data directory

**Build command**:
```powershell
cargo build --release
```

**Output**: `desktop\src-tauri\target\release\blazor-agile-board.exe`

---

## Full Production Build Process

### 1. Pre-Build Checklist

```powershell
# Update version in Cargo.toml
cd desktop\src-tauri
# Edit Cargo.toml: version = "0.2.0"

# Update version in tauri.conf.json
# Edit tauri.conf.json: "version": "0.2.0"

# Commit version bump
git add Cargo.toml tauri.conf.json
git commit -m "chore: bump version to 0.2.0"
git tag v0.2.0
```

### 2. Clean Build Environment

```powershell
# Clean previous builds
cargo clean

# Clean frontend artifacts
cd ..\..\frontend
dotnet clean

cd ..\desktop
```

### 3. Run Tests

```powershell
# Backend tests
cd ..\backend
cargo test --workspace --release

# Frontend tests
cd ..\frontend
dotnet test --configuration Release

# All tests must pass before production build
```

### 4. Build Frontend (Release)

```powershell
cd frontend
dotnet publish ProjectManagement.Wasm `
    -c Release `
    -o ..\desktop\src-tauri\target\wwwroot
```

**This step**:
- Optimizes Blazor for production
- Minifies JavaScript
- Enables AOT compilation
- Bundles static assets

**Output**: ~2MB of optimized Blazor files in `target\wwwroot\`

### 5. Build Tauri (Release)

```powershell
cd ..\desktop
cargo tauri build
```

**This step** (takes ~7-12 minutes):
- Compiles Rust with optimizations (`--release`)
- Strips debug symbols
- Creates MSI installer
- Creates NSIS installer

**Expected output**:
```
    Compiling pm-core v0.1.0
    Compiling pm-db v0.1.0
    ...
    Finished release [optimized] target(s) in 9m 23s
    Building MSI installer...
    Building NSIS installer...
    Finished 2 bundles at:
        C:\path\to\desktop\src-tauri\target\release\bundle\msi\Blazor Agile Board_0.2.0_x64_en-US.msi
        C:\path\to\desktop\src-tauri\target\release\bundle\nsis\Blazor Agile Board_0.2.0_x64-setup.exe
```

---

## Build Artifacts

### MSI Installer

**Location**:
```
desktop\src-tauri\target\release\bundle\msi\
└── Blazor Agile Board_0.2.0_x64_en-US.msi
```

**Size**: ~20-30 MB

**Install Location**: `C:\Program Files\Blazor Agile Board\`

**Data Location**: `%APPDATA%\com.blazor-agile-board\.pm\`

**Test installation**:
```powershell
# Install (requires admin)
msiexec /i "Blazor Agile Board_0.2.0_x64_en-US.msi"

# Silent install
msiexec /i "Blazor Agile Board_0.2.0_x64_en-US.msi" /quiet

# Uninstall
msiexec /x "Blazor Agile Board_0.2.0_x64_en-US.msi"
```

---

### NSIS Installer

**Location**:
```
desktop\src-tauri\target\release\bundle\nsis\
└── Blazor Agile Board_0.2.0_x64-setup.exe
```

**Size**: ~18-25 MB

**Install Location**: `%LOCALAPPDATA%\Programs\Blazor Agile Board\` (per-user)

**Data Location**: `%APPDATA%\com.blazor-agile-board\.pm\`

**Test installation**:
```powershell
# Install (no admin required)
.\Blazor Agile Board_0.2.0_x64-setup.exe

# Silent install
.\Blazor Agile Board_0.2.0_x64-setup.exe /S

# Uninstall via Control Panel or
%LOCALAPPDATA%\Programs\Blazor Agile Board\Uninstall.exe
```

---

### Portable Executable

**Location**:
```
desktop\src-tauri\target\release\
└── blazor-agile-board.exe
```

**Size**: ~12-18 MB

**Data Location**: `.pm\` directory next to .exe

**Usage**: Copy .exe anywhere and run directly

---

## Code Signing

### Prerequisites

1. **Code Signing Certificate** (.pfx file or Azure Key Vault)
2. Certificate password
3. `signtool.exe` (included with Visual Studio Build Tools)

### Option A: Sign with PFX Certificate

**Configure** in `desktop\src-tauri\tauri.conf.json`:

```json
{
  "tauri": {
    "bundle": {
      "windows": {
        "certificateThumbprint": null,
        "digestAlgorithm": "sha256",
        "timestampUrl": "http://timestamp.digicert.com"
      }
    }
  }
}

```

**Sign after build**:
```powershell
# Sign MSI
signtool sign /f "path\to\certificate.pfx" /p "password" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "desktop\src-tauri\target\release\bundle\msi\Blazor Agile Board_0.2.0_x64_en-US.msi"

# Sign NSIS installer
signtool sign /f "path\to\certificate.pfx" /p "password" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "desktop\src-tauri\target\release\bundle\nsis\Blazor Agile Board_0.2.0_x64-setup.exe"
```

### Option B: Sign with Azure Key Vault

```powershell
# Install AzureSignTool
dotnet tool install --global AzureSignTool

# Sign installers
AzureSignTool sign `
    -kvu "https://your-vault.vault.azure.net/" `
    -kvi "client-id" `
    -kvs "client-secret" `
    -kvc "certificate-name" `
    -tr http://timestamp.digicert.com `
    -td sha256 `
    "desktop\src-tauri\target\release\bundle\msi\*.msi"
```

### Verify Signature

```powershell
# Check signature
signtool verify /pa "Blazor Agile Board_0.2.0_x64_en-US.msi"
```

**Expected output**: "Successfully verified"

**View signature details**:
- Right-click installer → Properties → Digital Signatures tab

---

## Optimization Tips

### Reduce Binary Size

**Edit** `desktop\src-tauri\Cargo.toml`:

```toml
[profile.release]
opt-level = "z"     # Optimize for size
lto = true          # Link-time optimization
codegen-units = 1   # Better optimization, slower build
strip = true        # Strip debug symbols
panic = "abort"     # Smaller panic handling
```

**Trade-offs**:
- ✅ ~30-40% smaller binary
- ⚠️ ~2-3x longer build time
- ⚠️ Slightly slower runtime (negligible for most apps)

### Faster Release Builds

**Edit** `desktop\src-tauri\Cargo.toml`:

```toml
[profile.release]
opt-level = 3       # Maximum performance
lto = "thin"        # Faster than "fat" LTO
codegen-units = 16  # Parallel codegen (faster build)
```

### Benchmark Binary Size

```powershell
# Before optimization
Get-Item "desktop\src-tauri\target\release\blazor-agile-board.exe" | Select-Object Length

# After optimization
cargo clean
# Apply size optimizations in Cargo.toml
cargo tauri build
Get-Item "desktop\src-tauri\target\release\blazor-agile-board.exe" | Select-Object Length
```

---

## Distribution

### GitHub Releases

```powershell
# Create release on GitHub
gh release create v0.2.0 `
    --title "v0.2.0" `
    --notes "Release notes here" `
    "desktop\src-tauri\target\release\bundle\msi\Blazor Agile Board_0.2.0_x64_en-US.msi" `
    "desktop\src-tauri\target\release\bundle\nsis\Blazor Agile Board_0.2.0_x64-setup.exe"
```

### Direct Download

1. Upload installers to CDN or file host
2. Provide download links:
   - MSI: `https://your-site.com/downloads/Blazor-Agile-Board-0.2.0.msi`
   - NSIS: `https://your-site.com/downloads/Blazor-Agile-Board-0.2.0-setup.exe`

### Microsoft Store

**Additional requirements**:
- Microsoft Partner Center account
- MSIX package (not MSI/NSIS)
- App certification

**Build MSIX**:
```powershell
# Add to tauri.conf.json bundle.targets
"targets": ["msi", "nsis", "appx"]

# Build
cargo tauri build
```

**See**: [Tauri Windows Store Guide](https://tauri.app/v1/guides/distribution/windows)

---

## Verification

### Test Installation (MSI)

```powershell
# Install (as Administrator)
msiexec /i "Blazor Agile Board_0.2.0_x64_en-US.msi" /l*v install.log

# Check installation
Test-Path "C:\Program Files\Blazor Agile Board\blazor-agile-board.exe"

# Launch app
Start-Process "C:\Program Files\Blazor Agile Board\blazor-agile-board.exe"

# Uninstall
msiexec /x "Blazor Agile Board_0.2.0_x64_en-US.msi"
```

### Test Installation (NSIS)

```powershell
# Install (no admin required)
Start-Process "Blazor Agile Board_0.2.0_x64-setup.exe" -Wait

# Check installation
Test-Path "$env:LOCALAPPDATA\Programs\Blazor Agile Board\blazor-agile-board.exe"

# Launch app
Start-Process "$env:LOCALAPPDATA\Programs\Blazor Agile Board\blazor-agile-board.exe"

# Uninstall via Programs and Features
```

### Verify Architecture

```powershell
# Check if 64-bit
dumpbin /headers "desktop\src-tauri\target\release\blazor-agile-board.exe" | findstr machine
```

**Expected**: `x64` or `AMD64`

### Verify Code Signature

```powershell
Get-AuthenticodeSignature "Blazor Agile Board_0.2.0_x64_en-US.msi"
```

**Check for**:
- Status: Valid
- SignerCertificate: Your organization
- TimeStamperCertificate: DigiCert or other TSA

---

## Troubleshooting

### "Windows protected your PC" SmartScreen warning

**Symptom**: Windows Defender blocks unsigned installer

**Solution**:
- Code sign the installer (see Code Signing section)
- **Workaround** (development only): "More info" → "Run anyway"

### MSI build fails with "candle.exe not found"

**Symptom**: WiX Toolset not installed

**Solution**:
```powershell
# Install WiX Toolset
winget install -e --id WiX.Toolset

# Or download from https://wixtoolset.org/
# Restart PowerShell after installation
```

### NSIS build fails

**Symptom**: NSIS not found

**Solution**:
```powershell
# Install NSIS
winget install -e --id NSIS.NSIS

# Or download from https://nsis.sourceforge.io/
# Restart PowerShell after installation
```

### "The system cannot find the path specified"

**Symptom**: Long path errors during build

**Solution** (run PowerShell as Administrator):
```powershell
New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force
```

Restart computer after enabling.

### Installer size is huge (>100 MB)

**Symptom**: Binary not optimized

**Solution**:
- Check `profile.release` optimizations in Cargo.toml
- Ensure `dotnet publish -c Release` (not Debug)
- Remove debug symbols: `strip = true` in Cargo.toml

### "Failed to install application"

**Symptom**: Installation fails on target machine

**Causes**:
1. Missing WebView2 Runtime
2. Insufficient permissions
3. Conflicting installation

**Solution**:
```powershell
# Install WebView2 Runtime first
# Download: https://developer.microsoft.com/en-us/microsoft-edge/webview2/

# Or bundle WebView2 in installer (increases size ~100 MB)
# Edit tauri.conf.json:
"windows": {
  "webviewInstallMode": {
    "type": "embedBootstrapper"
  }
}
```

---

## CI/CD Integration

### GitHub Actions (Example)

```yaml
name: Build Windows Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install dependencies
        run: |
          choco install nsis -y
          choco install wixtoolset -y

      - name: Build frontend
        run: |
          cd frontend
          dotnet publish ProjectManagement.Wasm -c Release -o ..\desktop\src-tauri\target\wwwroot

      - name: Build Tauri
        run: |
          cd desktop
          cargo tauri build

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: desktop\src-tauri\target\release\bundle\msi\*.msi

      - name: Upload NSIS
        uses: actions/upload-artifact@v4
        with:
          name: windows-nsis
          path: desktop\src-tauri\target\release\bundle\nsis\*.exe
```

---

## Next Steps

**Development workflow?** See [WINDOWS_DEV_BUILD_README.md](WINDOWS_DEV_BUILD_README.md)

**Manual testing?** See [..\TESTING.md](..\..\desktop\TESTING.md)

**macOS/Linux builds?** See platform-specific production build guides

---

**Last Updated**: 2026-01-23
