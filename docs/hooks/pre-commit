#!/bin/bash
# Pre-commit hook: Auto-export agile board data
#
# This hook runs before 'git commit' completes.
# If pm-server data exists, export it to data.json and stage it.

# Only run if .pm/data.db exists (project uses pm-server)
if [ ! -f .pm/data.db ]; then
    exit 0
fi

# Only run if pm CLI is installed
if ! command -v pm &>/dev/null; then
    echo "Warning: pm CLI not found, skipping data export"
    echo "Install with: curl -fsSL <url>/install.sh | bash"
    exit 0
fi

# Export data (quiet mode - only shows errors)
echo "Exporting agile board data..."
pm sync export --output .pm/data.json --quiet

# Check if export succeeded
if [ $? -ne 0 ]; then
    echo "Error: Failed to export data. Commit aborted."
    echo "Fix the issue or run: git commit --no-verify"
    exit 1
fi

# Stage the exported data
git add .pm/data.json

echo "âœ“ Exported and staged .pm/data.json"
exit 0
