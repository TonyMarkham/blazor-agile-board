# Session 121.1: Infrastructure

**Parent Plan**: `121-Session-Plan.md`
**Target**: ~25k tokens
**Prerequisites**: `just check-backend` passes, `just test-backend` passes

---

## Scope

This sub-session establishes the foundational infrastructure that 121.2 and 121.3 depend on:

1. **Workspace Metadata** — Centralize version/edition in root `Cargo.toml`
2. **`.pm/` Directory Layout** — Create `.pm/.gitignore` for selective git tracking
3. **Root `.gitignore` Cleanup** — Un-ignore `Cargo.lock` and `.pm/`, add `dist/`
4. **Justfile Migration** — Change config directory from `.server` to `.pm`
5. **Documentation Alignment** — Update all `.server` references to `.pm`

### Concepts Taught

- **Cargo workspace metadata inheritance** — `[workspace.package]` + `version.workspace = true`
- **Git ignore precedence** — How `.pm/.gitignore` overrides root `.gitignore` patterns
- **Binary project lockfile convention** — Why Rust binary projects commit `Cargo.lock`

---

## Prerequisites Check

```bash
just check-backend    # Should pass
just test-backend     # Should pass
```

---

## Implementation Order

### Step 1: Add `[workspace.package]` to Root Cargo.toml

**Concept: Cargo Workspace Metadata Inheritance**

Cargo workspaces support a `[workspace.package]` section that lets member crates inherit common metadata. Right now, `version = "0.1.0"` and `edition = "2024"` are duplicated in every member crate. When you bump the version for a release, you'd have to edit 9+ files. With `[workspace.package]`, member crates use `version.workspace = true` and the value is read from a single location.

This is the same pattern the project already uses for dependencies (`[workspace.dependencies]` + `{ workspace = true }`), now extended to package-level fields.

**File**: `Cargo.toml` (root)

Insert between line 13 (`resolver = "3"`) and line 15 (`[workspace.dependencies]`):

```toml
[workspace.package]
version = "0.1.0"
edition = "2024"
license = "MIT"
repository = "https://github.com/OWNER/blazor-agile-board"
```

Also fix the typo on line 70: change `# Workspae` to `# Workspace crates`.

**Verification**: `just check-backend`

---

### Step 2: Inherit Workspace Metadata in pm-cli

**Concept: The `.workspace = true` Syntax**

With `[workspace.package]` defined, member crates replace hardcoded values with `field.workspace = true`. Note the syntax difference from dependencies: dependencies use `{ workspace = true }` (inline table), while package fields use `field.workspace = true` (dotted key). The `description` field stays local because it's crate-specific.

**File**: `backend/crates/pm-cli/Cargo.toml`

Replace lines 1-4 of the `[package]` section:

**Before**:
```toml
[package]
name = "pm-cli"
version = "0.1.0"
edition = "2024"
```

**After**:
```toml
[package]
name = "pm-cli"
version.workspace = true
edition.workspace = true
license.workspace = true
repository.workspace = true
description = "CLI tool for Blazor Agile Board project management"
```

Everything else in the file stays the same (`[[bin]]`, `[dependencies]`, `[dev-dependencies]`).

**Verification**: `just check-rs-cli`

---

### Step 3: Inherit Workspace Metadata in pm-server

Same pattern as Step 2 for the main server binary.

**File**: `backend/pm-server/Cargo.toml`

Replace lines 1-4:

**Before**:
```toml
[package]
name = "pm-server"
version = "0.1.0"
edition = "2024"
```

**After**:
```toml
[package]
name = "pm-server"
version.workspace = true
edition.workspace = true
license.workspace = true
repository.workspace = true
description = "Backend server for Blazor Agile Board project management"
```

**Verification**: `just check-rs-server`

---

### Step 4: Inherit Workspace Metadata in pm-config

**Why pm-config specifically**: The port file writer at `backend/crates/pm-config/src/port_file/port_file_info.rs:82` uses the Rust macro `env!("CARGO_PKG_VERSION")` to stamp the server version into `server.json`. This macro reads the version from `Cargo.toml` at compile time. With workspace inheritance, it reads from root `[workspace.package]` — giving consistent versioning across all binaries without any code changes.

**File**: `backend/crates/pm-config/Cargo.toml`

Replace lines 1-4:

**Before**:
```toml
[package]
name = "pm-config"
version = "0.1.0"
edition = "2024"
```

**After**:
```toml
[package]
name = "pm-config"
version.workspace = true
edition.workspace = true
license.workspace = true
repository.workspace = true
description = "Configuration loading and validation for Blazor Agile Board"
```

**Verification**: `just check-rs-config`

---

### Step 5: Create `.pm/.gitignore`

**Concept: Git Ignore Precedence and Negation**

Git processes `.gitignore` files hierarchically. A `.gitignore` in a subdirectory has **higher precedence** than the root `.gitignore` for files within that subdirectory. This means `.pm/.gitignore` can override patterns from the root.

The root `.gitignore` has `*.db` on line 57, which would normally block `.pm/data.db` from being tracked. By placing `!data.db` in `.pm/.gitignore`, we negate that pattern specifically within the `.pm/` directory. The `!` prefix means "un-ignore this file."

**Important rule from git docs**: "It is not possible to re-include a file if a parent directory of that file is excluded." This is why Step 6 MUST remove `.pm/` from root `.gitignore` — if the directory itself is excluded, nothing inside it can be re-included regardless of what `.pm/.gitignore` says.

**File**: `.pm/.gitignore` (NEW)

```gitignore
# .pm/.gitignore
# ===============
# Runtime files that should NOT be committed.
# Files NOT listed here ARE tracked (data.db, config.toml).

# CRITICAL: Negate root .gitignore's *.db pattern for our database.
# Without this line, data.db would be ignored by the root *.db rule.
!data.db

# Installed binaries (downloaded via install.sh or built locally)
bin/

# SQLite WAL/SHM runtime files (recreated automatically on server start)
*.db-wal
*.db-shm

# Server discovery file (ephemeral — changes every server start)
server.json

# Process lock file (prevents duplicate server instances)
server.lock

# Server log files
logs/
log/

# Tauri desktop runtime data
tauri/
```

**Verification**:
```bash
git status
# Should show .pm/.gitignore as a new untracked file
```

---

### Step 6: Update Root `.gitignore`

**Concept: Binary Project Lockfile Convention**

The Rust community convention is:
- **Library crates**: Do NOT commit `Cargo.lock` (consumers resolve their own versions)
- **Binary projects**: DO commit `Cargo.lock` (ensures reproducible builds)

This project produces two binaries (`pm` and `pm-server`), so the lockfile should be committed. When someone clones the repo and runs `cargo build`, they get the exact same dependency versions that were tested.

**File**: `.gitignore`

Three changes:

1. **Line 3**: Remove `Cargo.lock`

2. **Lines 64-66**: Replace the `.pm/` and `.server` block:

**Before** (lines 64-66):
```gitignore
# Application data directory (desktop mode)
.pm/
.server
```

**After** (lines 64-65):
```gitignore
# Release distribution archives
dist/
```

3. After editing, generate a fresh lockfile:
```bash
cargo generate-lockfile
```

**Verification**:
```bash
git status
# Cargo.lock should appear as untracked (previously ignored)
# .pm/data.db should appear as untracked (no longer blanket-ignored)
# .pm/.gitignore should appear as untracked
```

---

### Step 7: Migrate Justfile from `.server` to `.pm`

**Concept: Single Source of Truth for Config Directory**

The justfile variable `config_dir` on line 7 controls where `just setup-config` creates the configuration directory and copies `config.example.toml`. The backend's `pm_config::Config::config_dir()` (at `backend/crates/pm-config/src/config.rs:82-90`) defaults to `<cwd>/.pm/` when `PM_CONFIG_DIR` is not set. The justfile must match this default so that `just setup-config` writes to the same directory the server reads from.

**File**: `justfile`

**Line 7** — change:
```just
config_dir := ".server"
```
to:
```just
config_dir := ".pm"
```

**Line 467** — change comment:
```just
# Copy example config to .server directory if it doesn't exist
```
to:
```just
# Copy example config to .pm directory if it doesn't exist
```

**Migration note for existing users**: If you have data in `.server/`, run:
```bash
cp .server/config.toml .pm/config.toml
cp .server/data.db .pm/data.db
```

**Verification**:
```bash
just setup-config
ls -la .pm/config.toml    # Should exist
```

---

### Step 8: Update `config.example.toml` Comments

**File**: `backend/config.example.toml`

Four comment changes (`.server/` -> `.pm/`):

- **Line 3**: `# Copy to .pm/config.toml in your working directory ...`
- **Line 52**: `# SQLite database file path (relative to .pm/ directory, default: "data.db")`
- **Line 74**: `# Path is relative to .pm/ directory and cannot contain '..'`
- **Line 92**: `# Log directory (relative to .pm/ directory, default: "log")`

**Verification**:
```bash
grep '\.server' backend/config.example.toml
# Should return NO results
```

---

### Step 9: Update `tauri.conf.json` Resource Path

**Concept: Tauri Resource Bundling**

Tauri bundles files into the application package at build time. The `resources` section in `tauri.conf.json` maps source paths (relative to the tauri project) to destination paths (relative to the app's resource directory). Since the config file now lives at `<repo>/.pm/config.toml` instead of `<repo>/.server/config.toml`, the source path must change.

The destination path `.server/config.toml` stays unchanged because that's Tauri's *internal* directory convention within its own app data — it's unrelated to the repo-level directory.

**File**: `desktop/src-tauri/tauri.conf.json`

**Line 52** — change:
```json
"../../.server/config.toml": ".server/config.toml",
```
to:
```json
"../../.pm/config.toml": ".server/config.toml",
```

**Verification**:
```bash
grep 'config.toml' desktop/src-tauri/tauri.conf.json
# Source side should reference .pm, destination side still .server
```

---

## Session 121.1 Completion Checklist

```bash
# Full verification sequence
just check-backend        # All Rust code compiles
just clippy-backend       # No clippy warnings
just test-backend         # All tests pass
just setup-config         # Creates .pm/config.toml from example

# Verify .gitignore changes
git status                # Should show:
                          #   new: .pm/.gitignore
                          #   new: .pm/data.db (previously hidden by root .gitignore)
                          #   new: Cargo.lock (previously ignored)
                          #   modified: .gitignore, justfile, Cargo.toml, etc.

# Verify version inheritance
cargo metadata --format-version 1 | python3 -c "
import json,sys
d=json.load(sys.stdin)
for p in d['packages']:
    if p['name'] in ('pm-cli','pm-server','pm-config'):
        print(f\"{p['name']}: {p['version']}\")
"
# All should show 0.1.0
```

### Files Created (1)
| File | Purpose |
|------|---------|
| `.pm/.gitignore` | Selective tracking: `data.db` + `config.toml` tracked, runtime files ignored |

### Files Modified (8)
| File | Change |
|------|--------|
| `Cargo.toml` (root) | Add `[workspace.package]`, fix typo |
| `backend/crates/pm-cli/Cargo.toml` | Inherit workspace metadata |
| `backend/pm-server/Cargo.toml` | Inherit workspace metadata |
| `backend/crates/pm-config/Cargo.toml` | Inherit workspace metadata |
| `.gitignore` | Remove `Cargo.lock`, `.pm/`, `.server`; add `dist/` |
| `justfile` | Change `config_dir` from `.server` to `.pm` |
| `backend/config.example.toml` | Update `.server/` references to `.pm/` in comments |
| `desktop/src-tauri/tauri.conf.json` | Update resource source path |

### Files Newly Git-Tracked (2)
| File | Purpose |
|------|---------|
| `Cargo.lock` | Reproducible builds for binary project |
| `.pm/data.db` | Shared project management database |

---

## Next Session

**Session 121.2** will implement:
- Tauri repo-awareness via `PM_CONFIG_DIR` environment variable
- `pm desktop` CLI subcommand for launching Tauri from repo context
- Updated `just dev` to pass `PM_CONFIG_DIR`
- Correct documentation in `CLAUDE_FUCKED_UP.md`
