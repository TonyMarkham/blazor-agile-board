# Session 121.3.2: Complete REST/CLI CRUD + Bulk Sync

Session 121.4 (data sync) requires export/import of ALL entity types, but the CLI Client only has CRUD for work items and comments. Projects are read-only. Sprints, dependencies, swim lanes, and time entries have zero REST endpoints, zero Client methods, and zero CLI commands. The export schema also omits dependencies and time entries entirely.

This session fills every gap: individual REST+CLI CRUD for each missing entity first (so DTOs exist), then bulk sync endpoints last (reusing those DTOs) to unblock 121.4.

---

## Sub-Session Breakdown

| Session | Scope | Est. Tokens | Depends On | Status |
|---------|-------|-------------|------------|--------|
| **[121.3.2.1](121.3.2.1-Session-Plan.md)** | Project Create/Update/Delete | ~25k | — | **Complete** |
| **[121.3.2.2](121.3.2.2-Session-Plan.md)** | Sprint CRUD | ~30k | — | **Complete** |
| **[121.3.2.3](121.3.2.3-Session-Plan.md)** | Dependency Create/Read/Delete | ~20k | — | **Complete** |
| **[121.3.2.4](121.3.2.4-Session-Plan.md)** | Swim Lane Read-Only (DTO + GET + CLI list) | ~10k | — | **Complete** |
| **[121.3.2.5](121.3.2.5-Session-Plan.md)** | Time Entry CRUD | ~25k | — | Pending |
| **[121.3.2.6](121.3.2.6-Session-Plan.md)** | Bulk Sync Endpoints (export/import) | ~30k | 121.3.2.1–5 | Pending |

Sub-sessions 121.3.2.1–5 are all independent and can be done in any order. **121.3.2.6 (bulk sync) must be last** — it reuses the DTOs created by 121.3.2.1–5 to avoid duplication.

Only **121.4** depends on **121.3.2.6** (bulk sync).

---

## Gap Analysis

| Entity | CLI Read | CLI Write | REST Endpoints | DB Repository | In Export Schema |
|--------|:--------:|:---------:|:--------------:|:-------------:|:----------------:|
| **Projects** | list, get | full | Full CRUD | Full CRUD | Yes |
| **Work Items** | full | full | Full CRUD | Full CRUD | Yes |
| **Comments** | list | full | Full CRUD | Full CRUD | Yes |
| **Sprints** | full | full | Full CRUD | Full CRUD | Yes |
| **Dependencies** | list | create, delete | 3 endpoints | Full CRUD | **MISSING** |
| **Swim Lanes** | -- | N/A (fixed config) | **None** | Full CRUD | Yes (empty `[]`) |
| **Time Entries** | -- | -- | **None** | Full CRUD | **MISSING** |

Every entity has a complete database repository in pm-db. The gap is exclusively at REST API + CLI Client + CLI commands layers.

---

## Session 121.3.2.1: Project Create/Update/Delete

**Files Created:**
- `pm-server/src/api/projects/create_project_request.rs` - Create request DTO
- `pm-server/src/api/projects/update_project_request.rs` - Update request DTO

**Files Modified:**
- `pm-server/src/api/projects/projects.rs` - Add 3 handler functions
- `pm-server/src/api/projects/mod.rs` - Declare new modules
- `pm-server/src/lib.rs` - Re-export new handlers/types
- `pm-server/src/routes.rs` - Register 3 routes
- `pm-cli/src/client/client.rs` - Add 3 client methods
- `pm-cli/src/project_commands.rs` - Add Create, Update, Delete variants
- `pm-cli/src/main.rs` - Wire new project commands

**Verification:** `just check-backend && just clippy-backend && just test-backend`

---

## Session 121.3.2.2: Sprint CRUD

**Files Created:**
- `pm-server/src/api/sprints/` - mod.rs, sprint_dto.rs, sprint_response.rs, sprint_list_response.rs, create_sprint_request.rs, update_sprint_request.rs, sprints.rs
- `pm-cli/src/sprint_commands.rs` - CLI command definitions

**Files Modified:**
- `pm-server/src/api/mod.rs` - Add sprints module
- `pm-server/src/lib.rs` - Re-exports
- `pm-server/src/routes.rs` - 5 routes
- `pm-cli/src/client/client.rs` - 5 client methods
- `pm-cli/src/commands.rs` - Add Sprint variant
- `pm-cli/src/main.rs` - Wire sprint commands

**Verification:** `just check-backend && just clippy-backend && just test-backend`

---

## Session 121.3.2.3: Dependency Create/Read/Delete

Also **extracts cycle detection** from `pm-ws` into `DependencyRepository::detect_cycle()` so both WebSocket and REST handlers use the same validation.

**Files Created:**
- `pm-server/src/api/dependencies/` - mod.rs, dependency_dto.rs, dependency_list_response.rs, create_dependency_request.rs, dependencies.rs
- `pm-cli/src/dependency_commands.rs` - CLI command definitions

**Files Modified:**
- `pm-db/src/repositories/dependency_repository.rs` - Add `detect_cycle()` method
- `pm-ws/src/handlers/dependency.rs` - Replace local function with `repo.detect_cycle()` call
- `pm-server/src/api/mod.rs` - Add dependencies module
- `pm-server/src/lib.rs` - Re-exports
- `pm-server/src/routes.rs` - 3 routes
- `pm-cli/src/client/client.rs` - 3 client methods
- `pm-cli/src/commands.rs` - Add Dependency variant
- `pm-cli/src/main.rs` - Wire dependency commands

**Verification:** `just check-backend && just clippy-backend && just test-backend`

---

## Session 121.3.2.4: Swim Lane Read-Only

Swim lanes are **fixed configuration** — no WebSocket handlers, no proto messages, no UI for CRUD. This session adds read-only support only: DTO (for bulk export), GET endpoint, CLI list command.

**Files Created:**
- `pm-server/src/api/swim_lanes/` - mod.rs, swim_lane_dto.rs, swim_lane_list_response.rs, swim_lanes.rs
- `pm-cli/src/swim_lane_commands.rs` - CLI command (list only)

**Files Modified:**
- `pm-server/src/api/mod.rs` - Add swim_lanes module
- `pm-server/src/lib.rs` - Re-exports
- `pm-server/src/routes.rs` - 1 route (GET only)
- `pm-cli/src/client/client.rs` - 1 client method
- `pm-cli/src/commands.rs` - Add SwimLane variant
- `pm-cli/src/main.rs` - Wire swim lane command

**Verification:** `just check-backend && just clippy-backend && just test-backend`

---

## Session 121.3.2.5: Time Entry CRUD

**Files Created:**
- `pm-server/src/api/time_entries/` - mod.rs, time_entry_dto.rs, time_entry_response.rs, time_entry_list_response.rs, create_time_entry_request.rs, update_time_entry_request.rs, time_entries.rs
- `pm-cli/src/time_entry_commands.rs` - CLI command definitions

**Files Modified:**
- `pm-server/src/api/mod.rs` - Add time_entries module
- `pm-server/src/lib.rs` - Re-exports
- `pm-server/src/routes.rs` - 5 routes
- `pm-cli/src/client/client.rs` - 5 client methods
- `pm-cli/src/commands.rs` - Add TimeEntry variant
- `pm-cli/src/main.rs` - Wire time entry commands

**Verification:** `just check-backend && just clippy-backend && just test-backend`

---

## Session 121.3.2.6: Bulk Sync Endpoints

**Why last**: Reuses `SprintDto`, `DependencyDto`, `SwimLaneDto`, `TimeEntryDto` from the entity modules created in 121.3.2.1–5. No duplicate `sync_dto.rs` needed.

**Files Created:**
- `pm-server/src/api/sync/mod.rs` - Module declarations
- `pm-server/src/api/sync/export_data.rs` - ExportData struct (all 7 entity arrays)
- `pm-server/src/api/sync/sync_handlers.rs` - sync_export and sync_import handlers

**Files Modified:**
- `pm-db/src/repositories/sprint_repository.rs` - Add `find_all()`
- `pm-db/src/repositories/swim_lane_repository.rs` - Add `find_all()`
- `pm-db/src/repositories/work_item_repository.rs` - Add `find_all()`
- `pm-db/src/repositories/comment_repository.rs` - Add `find_all()`
- `pm-db/src/repositories/dependency_repository.rs` - Add `find_all()`
- `pm-db/src/repositories/time_entry_repository.rs` - Add `find_all()`
- `pm-server/src/api/mod.rs` - Add sync module
- `pm-server/src/api/projects/project_dto.rs` - Add Deserialize derive
- `pm-server/src/api/comments/comment_dto.rs` - Add Deserialize derive
- `pm-server/src/api/work_items/work_item_dto.rs` - Add Deserialize derive
- `pm-server/src/api/sprints/sprint_dto.rs` - Add Deserialize derive
- `pm-server/src/api/dependencies/dependency_dto.rs` - Add Deserialize derive
- `pm-server/src/api/swim_lanes/swim_lane_dto.rs` - Add Deserialize derive
- `pm-server/src/api/time_entries/time_entry_dto.rs` - Add Deserialize derive
- `pm-server/src/lib.rs` - Re-export sync handlers
- `pm-server/src/routes.rs` - Register 2 routes
- `pm-cli/src/client/client.rs` - Add 2 client methods

**Verification:** `just check-backend && just clippy-backend && just test-backend`

---

## Pre-Implementation Checklist

Before starting **any** sub-session:

- [ ] `just check-backend` passes
- [ ] `just test-backend` passes
- [ ] `just check-rs-cli` passes

---

## Required: WebSocket Broadcasts + Activity Log

All REST mutation handlers (create/update/delete) in sessions 121.3.2.1–5 **MUST** broadcast via WebSocket and write activity log entries, exactly matching the established pattern in `pm-server/src/api/work_items/work_items.rs` and `pm-server/src/api/comments/comments.rs`.

The pattern for every mutation handler is:

1. **Create `ActivityLog` entry**: `ActivityLog::created("entity_type", entity_id, user_id)` / `::updated(...)` / `::deleted(...)`
2. **Transaction**: Write entity + activity log atomically (`tx.begin()` → entity op → `ActivityLogRepository::create()` → `tx.commit()`)
3. **Broadcast `ActivityLogCreated`** (non-fatal): `state.registry.broadcast_activity_log_created(project_id, work_item_id, sprint_id, message)` — wrapped in `if let Err(e)` with `log::warn!`
4. **Broadcast entity-specific event** (non-fatal): `state.registry.broadcast_to_project(project_id, message)` — wrapped in `if let Err(e)` with `log::warn!`

All response builders (`build_*_created_response`, `build_*_updated_response`, `build_*_deleted_response`) and `build_activity_log_created_event()` are already exported from `pm_ws`. The `ConnectionRegistry` is available via `state.registry` (from `AppState`).

**Entity types for ActivityLog**: `project`, `sprint`, `dependency`, `swim_lane`, `time_entry` (matching the entity type strings already used in `pm-core/src/models/activity_log.rs`).

Validation in handlers should use `sanitize_string()` (from `pm_ws`, XSS prevention) for user-supplied strings, and construct `ApiError::Validation` for invalid inputs. See `work_items.rs` for the complete reference pattern.

---

## Key Patterns to Follow

All existing patterns are in the work_items and comments handlers:

| Pattern | Reference File |
|---------|---------------|
| Handler structure | `pm-server/src/api/work_items/work_items.rs` |
| DTO with `From<CoreModel>` | `pm-server/src/api/projects/project_dto.rs` |
| Request struct | `pm-server/src/api/work_items/create_work_item_request.rs` |
| Response wrapper | `pm-server/src/api/work_items/work_item_response.rs` |
| Route registration | `pm-server/src/routes.rs` |
| Lib re-exports | `pm-server/src/lib.rs` |
| CLI Client methods | `pm-cli/src/client/client.rs` |
| CLI command enums | `pm-cli/src/commands.rs` |
| CLI command handlers | `pm-cli/src/work_item_commands.rs` |
| Input sanitization | `pm-ws/src/handlers/work_item.rs:576` (`sanitize_string`) |
| Validation errors | `pm-server/src/api/error.rs` (`ApiError::Validation`) |

---

## Files Summary

### Create (~31 files)

| Sub-Session | Files Created |
|-------------|---------------|
| 121.3.2.1 | 2 files (project request DTOs) |
| 121.3.2.2 | 8 files (sprint module + CLI) |
| 121.3.2.3 | 6 files (dependency module + CLI) |
| 121.3.2.4 | 5 files (swim lane read-only: DTO, list response, handler, mod, CLI) |
| 121.3.2.5 | 8 files (time entry module + CLI) |
| 121.3.2.6 | 3 files (sync module — no sync_dto.rs, reuses entity DTOs) |

### Modify (121.3.2.6 repository additions)

121.3.2.6 adds `find_all()` to 6 repositories (Sprint, SwimLane, WorkItem, Comment, Dependency, TimeEntry) to enable bulk export without N+1 queries. `ProjectRepository` already has `find_all()`.

### Modify (shared files touched by multiple sub-sessions)

| File | Changed By |
|------|------------|
| `pm-server/src/api/mod.rs` | 121.3.2.2-121.3.2.6 |
| `pm-server/src/lib.rs` | All sub-sessions |
| `pm-server/src/routes.rs` | All sub-sessions |
| `pm-cli/src/client/client.rs` | All sub-sessions |
| `pm-cli/src/commands.rs` | 121.3.2.2-121.3.2.5 |
| `pm-cli/src/main.rs` | 121.3.2.1-121.3.2.5 |

---

## Final Verification

After all six sub-sessions are complete:

```bash
just check-backend
just clippy-backend
just test-backend

# Verify all CLI commands exist
cargo run -p pm-cli -- --help
cargo run -p pm-cli -- project --help
cargo run -p pm-cli -- sprint --help
cargo run -p pm-cli -- dependency --help
cargo run -p pm-cli -- swim-lane --help   # list only (read-only, fixed config)
cargo run -p pm-cli -- time-entry --help

# Verify sync endpoints
cargo run -p pm-server &
curl http://localhost:8080/api/v1/sync/export | jq 'keys'
# Should show: comments, dependencies, exported_at, exported_by, projects, schema_version, sprints, swim_lanes, time_entries, work_items
```
