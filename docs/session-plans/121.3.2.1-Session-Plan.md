# Session 121.3.2.1: Project Create/Update/Delete

**Parent Plan**: [121.3.2-Session-Plan.md](121.3.2-Session-Plan.md)
**Target**: ~25k tokens
**Prerequisites**: `just check-backend && just test-backend && just check-rs-cli` all pass

---

## Scope

Projects currently have read-only REST endpoints (`GET /api/v1/projects`, `GET /api/v1/projects/{id}`) and read-only CLI commands (`project list`, `project get`). The DB repository (`ProjectRepository`) already has full CRUD. This session adds:

1. **Request DTOs** - `CreateProjectRequest` and `UpdateProjectRequest`
2. **Handlers** - 3 new handler functions (create, update, delete)
3. **Routes** - 3 new routes
4. **CLI Client** - 3 new client methods
5. **CLI Commands** - Create, Update, Delete variants for ProjectCommands

**Core model fields** (`pm-core/src/models/project.rs`): `id`, `title`, `description`, `key`, `status` (ProjectStatus: Active/Archived), `version`, `created_at`, `updated_at`, `created_by`, `updated_by`, `deleted_at`, `next_work_item_number`

---

## Implementation Order

### Step 1: Create Request DTOs

**Create**: `backend/pm-server/src/api/projects/create_project_request.rs`

Follow pattern from `create_work_item_request.rs`.

```rust
use serde::Deserialize;

#[derive(Debug, Deserialize)]
pub struct CreateProjectRequest {
    /// Project title (required)
    pub title: String,
    /// Unique short key, e.g., "PROJ" (required)
    pub key: String,
    /// Optional description
    #[serde(default)]
    pub description: Option<String>,
}
```

**Create**: `backend/pm-server/src/api/projects/update_project_request.rs`

```rust
use serde::Deserialize;

#[derive(Debug, Deserialize)]
pub struct UpdateProjectRequest {
    #[serde(default)]
    pub title: Option<String>,
    #[serde(default)]
    pub description: Option<String>,
    /// Status: "active" or "archived"
    #[serde(default)]
    pub status: Option<String>,
    /// Required for optimistic locking
    pub expected_version: i32,
}
```

---

### Step 2: Add Handler Functions

**File**: `backend/pm-server/src/api/projects/projects.rs`

Add three handlers following the pattern from `work_items.rs`:

**`POST /api/v1/projects`** — `create_project`
- Parse `CreateProjectRequest`
- Sanitize title: `let title = sanitize_string(&req.title).trim()` — return `ApiError::Validation` if empty
- Sanitize key: `let key = req.key.trim().to_uppercase()` — return `ApiError::Validation` if empty
- Check key uniqueness: `ProjectRepository::find_by_key(&key)` — return `ApiError::Conflict` if exists
- Create `Project::new(title, key, user_id)`, set description if provided
- Call `ProjectRepository::create()`
- Return `ProjectResponse`

**`PUT /api/v1/projects/{id}`** — `update_project`
- Parse UUID from path, parse `UpdateProjectRequest`
- Load existing project via `find_by_id()` — return 404 if not found
- Check version matches `expected_version` (optimistic locking) — return `ApiError::Conflict` if mismatch
- Apply optional field updates (sanitize title/description with `sanitize_string()`, validate status string)
- Call `ProjectRepository::update()`
- Return `ProjectResponse`

**`DELETE /api/v1/projects/{id}`** — `delete_project`
- Parse UUID from path
- Load existing project via `find_by_id()` — return 404 if not found
- Call `ProjectRepository::delete()` (soft delete)
- Return `DeleteResponse`

**Note**: These REST endpoints are for CLI/sync tooling only — no WebSocket broadcasts. Real-time updates for projects remain exclusive to the WebSocket protocol handlers. See parent plan architectural note.

Add necessary imports: `CreateProjectRequest`, `UpdateProjectRequest`, `UserId`, `DeleteResponse`, `sanitize_string` (from `pm_ws`).

---

### Step 3: Update Module Declarations

**File**: `backend/pm-server/src/api/projects/mod.rs`

Add:
```rust
pub(crate) mod create_project_request;
pub(crate) mod update_project_request;
```

---

### Step 4: Update Re-exports

**File**: `backend/pm-server/src/lib.rs`

Add to the projects re-export section:
```rust
create_project_request::CreateProjectRequest,
update_project_request::UpdateProjectRequest,
projects::{create_project, update_project, delete_project},
```

(Existing re-exports: `get_project, list_projects`)

---

### Step 5: Register Routes

**File**: `backend/pm-server/src/routes.rs`

Add to `build_router()` in the Projects section:
```rust
.route("/api/v1/projects", post(create_project))
.route("/api/v1/projects/{id}", put(update_project))
.route("/api/v1/projects/{id}", delete(delete_project))
```

Update the import at top to include `create_project, update_project, delete_project`.

**Verification**: `just check-rs-server`

---

### Step 6: Add CLI Client Methods

**File**: `backend/crates/pm-cli/src/client/client.rs`

Add to the Project Operations section:

```rust
/// Create a new project
pub async fn create_project(
    &self,
    title: &str,
    key: &str,
    description: Option<&str>,
) -> CliClientResult<Value> {
    #[derive(Serialize)]
    struct CreateRequest<'a> {
        title: &'a str,
        key: &'a str,
        #[serde(skip_serializing_if = "Option::is_none")]
        description: Option<&'a str>,
    }

    let body = CreateRequest { title, key, description };
    let req = self.request(Method::POST, "/api/v1/projects").json(&body);
    self.execute(req).await
}

/// Update a project
pub async fn update_project(
    &self,
    id: &str,
    title: Option<&str>,
    description: Option<&str>,
    status: Option<&str>,
    expected_version: i32,
) -> CliClientResult<Value> {
    #[derive(Serialize)]
    struct UpdateRequest<'a> {
        #[serde(skip_serializing_if = "Option::is_none")]
        title: Option<&'a str>,
        #[serde(skip_serializing_if = "Option::is_none")]
        description: Option<&'a str>,
        #[serde(skip_serializing_if = "Option::is_none")]
        status: Option<&'a str>,
        expected_version: i32,
    }

    let body = UpdateRequest { title, description, status, expected_version };
    let req = self
        .request(Method::PUT, &format!("/api/v1/projects/{}", id))
        .json(&body);
    self.execute(req).await
}

/// Delete a project
pub async fn delete_project(&self, id: &str) -> CliClientResult<Value> {
    let req = self.request(Method::DELETE, &format!("/api/v1/projects/{}", id));
    self.execute(req).await
}
```

---

### Step 7: Add CLI Commands

**File**: `backend/crates/pm-cli/src/project_commands.rs`

Add three new variants to `ProjectCommands` enum:

```rust
#[derive(Subcommand)]
pub enum ProjectCommands {
    /// List all projects
    List,
    /// Get a project by ID
    Get { id: String },
    /// Create a new project
    Create {
        /// Project title
        #[arg(long)]
        title: String,
        /// Unique project key (e.g., "PROJ")
        #[arg(long)]
        key: String,
        /// Optional description
        #[arg(long)]
        description: Option<String>,
    },
    /// Update a project
    Update {
        /// Project ID (UUID)
        id: String,
        #[arg(long)]
        title: Option<String>,
        #[arg(long)]
        description: Option<String>,
        /// Status: active or archived
        #[arg(long, value_parser = ["active", "archived"])]
        status: Option<String>,
        /// Expected version (required for optimistic locking)
        #[arg(long)]
        version: i32,
    },
    /// Delete a project
    Delete {
        /// Project ID (UUID)
        id: String,
    },
}
```

---

### Step 8: Wire Commands in main.rs

**File**: `backend/crates/pm-cli/src/main.rs`

Update the `Commands::Project { action }` match arm to handle new variants:

```rust
Commands::Project { action } => match action {
    ProjectCommands::List => client.list_projects().await,
    ProjectCommands::Get { id } => client.get_project(&id).await,
    ProjectCommands::Create { title, key, description } => {
        client.create_project(&title, &key, description.as_deref()).await
    }
    ProjectCommands::Update { id, title, description, status, version } => {
        client
            .update_project(&id, title.as_deref(), description.as_deref(), status.as_deref(), version)
            .await
    }
    ProjectCommands::Delete { id } => client.delete_project(&id).await,
},
```

**Verification**: `just check-rs-cli`

---

## Completion Checklist

After completing all steps:

- [ ] `just check-backend` passes
- [ ] `just clippy-backend` passes
- [ ] `just test-backend` passes
- [ ] `just check-rs-cli` passes

### Files Created (2)
- `backend/pm-server/src/api/projects/create_project_request.rs`
- `backend/pm-server/src/api/projects/update_project_request.rs`

### Files Modified (7)
- `backend/pm-server/src/api/projects/projects.rs` — add 3 handler functions
- `backend/pm-server/src/api/projects/mod.rs` — declare new modules
- `backend/pm-server/src/lib.rs` — re-export new handlers/types
- `backend/pm-server/src/routes.rs` — register 3 routes
- `backend/crates/pm-cli/src/client/client.rs` — add 3 client methods
- `backend/crates/pm-cli/src/project_commands.rs` — add Create, Update, Delete variants
- `backend/crates/pm-cli/src/main.rs` — wire new project commands

---

## Next Session

**Session 121.3.2.2** adds Sprint CRUD (REST + CLI).
