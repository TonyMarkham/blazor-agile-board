# Session 121.3.2.4: Swim Lane Read-Only Support

**Parent Plan**: [121.3.2-Session-Plan.md](121.3.2-Session-Plan.md)
**Target**: ~10k tokens
**Prerequisites**: `just check-backend && just test-backend && just check-rs-cli` all pass

---

## Scope

Swim lanes are **fixed configuration** — created by migrations, identical across all projects. There are no WebSocket handlers, no proto messages, and no UI for swim lane CRUD. Users move work items between lanes by changing `work_item.status`.

This session adds **read-only** support only:

1. **SwimLaneDto** — Needed by 121.3.2.6 (bulk export)
2. **GET endpoint** — List swim lanes for a project
3. **CLI command** — `swim-lane list <project_id>`

No create/update/delete. No broadcasts. No activity log.

**Core model fields** (`pm-core/src/models/swim_lane.rs`): `id`, `project_id`, `name`, `status_value`, `position`, `is_default`, `created_at`, `updated_at`, `deleted_at`

Note: No `created_by`/`updated_by`, no `version`. Has `is_default` flag.

**New REST endpoint**:

| Method | Path | Handler |
|--------|------|---------|
| `GET` | `/api/v1/projects/{project_id}/swim-lanes` | `list_swim_lanes` |

---

## Implementation Order

### Step 1: Create Swim Lane DTO

**Create**: `backend/pm-server/src/api/swim_lanes/swim_lane_dto.rs`

```rust
use pm_core::SwimLane;
use serde::Serialize;

#[derive(Debug, Serialize)]
pub struct SwimLaneDto {
    pub id: String,
    pub project_id: String,
    pub name: String,
    pub status_value: String,
    pub position: i32,
    pub is_default: bool,
    pub created_at: i64,
    pub updated_at: i64,
}

impl From<SwimLane> for SwimLaneDto {
    fn from(sl: SwimLane) -> Self {
        Self {
            id: sl.id.to_string(),
            project_id: sl.project_id.to_string(),
            name: sl.name,
            status_value: sl.status_value,
            position: sl.position,
            is_default: sl.is_default,
            created_at: sl.created_at.timestamp(),
            updated_at: sl.updated_at.timestamp(),
        }
    }
}
```

---

### Step 2: Create Response Wrapper

**Create**: `backend/pm-server/src/api/swim_lanes/swim_lane_list_response.rs`

```rust
use crate::SwimLaneDto;
use serde::Serialize;

#[derive(Debug, Serialize)]
pub struct SwimLaneListResponse {
    pub swim_lanes: Vec<SwimLaneDto>,
}
```

---

### Step 3: Create Handler Function

**Create**: `backend/pm-server/src/api/swim_lanes/swim_lanes.rs`

**`list_swim_lanes`** (`GET /api/v1/projects/{project_id}/swim-lanes`):
- Parse project_id UUID from path
- `SwimLaneRepository::find_by_project(project_id)` — ordered by position
- Return `SwimLaneListResponse`

---

### Step 4: Create Module File

**Create**: `backend/pm-server/src/api/swim_lanes/mod.rs`

```rust
pub(crate) mod swim_lane_dto;
pub(crate) mod swim_lane_list_response;
#[allow(clippy::module_inception)]
pub(crate) mod swim_lanes;
```

---

### Step 5: Update API Module + Re-exports + Routes

**File**: `backend/pm-server/src/api/mod.rs`

Add: `pub(crate) mod swim_lanes;`

**File**: `backend/pm-server/src/lib.rs`

Add re-exports:
```rust
swim_lanes::{
    swim_lane_dto::SwimLaneDto,
    swim_lane_list_response::SwimLaneListResponse,
    swim_lanes::list_swim_lanes,
},
```

**File**: `backend/pm-server/src/routes.rs`

Add to `build_router()`:
```rust
// REST API v1 - Swim Lanes (read-only, fixed configuration)
.route("/api/v1/projects/{project_id}/swim-lanes", get(list_swim_lanes))
```

Update imports at top of `routes.rs`.

**Verification**: `just check-rs-server`

---

### Step 6: Add CLI Client Method

**File**: `backend/crates/pm-cli/src/client/client.rs`

Add a Swim Lane Operations section:

```rust
// =========================================================================
// Swim Lane Operations (read-only — swim lanes are fixed configuration)
// =========================================================================

pub async fn list_swim_lanes(&self, project_id: &str) -> CliClientResult<Value> {
    let req = self.request(
        Method::GET,
        &format!("/api/v1/projects/{}/swim-lanes", project_id),
    );
    self.execute(req).await
}
```

---

### Step 7: Add CLI Command

**Create**: `backend/crates/pm-cli/src/swim_lane_commands.rs`

```rust
use clap::Subcommand;

#[derive(Subcommand)]
pub enum SwimLaneCommands {
    /// List swim lanes for a project (ordered by position)
    List {
        /// Project ID (UUID)
        project_id: String,
    },
}
```

---

### Step 8: Wire Swim Lane Commands

**File**: `backend/crates/pm-cli/src/commands.rs`

Add:
```rust
/// Swim lane operations (read-only)
SwimLane {
    #[command(subcommand)]
    action: SwimLaneCommands,
},
```

Add import: `use crate::swim_lane_commands::SwimLaneCommands;`

**File**: `backend/crates/pm-cli/src/main.rs`

Add `mod swim_lane_commands;` and import `SwimLaneCommands`.

Add match arm:
```rust
Commands::SwimLane { action } => match action {
    SwimLaneCommands::List { project_id } => client.list_swim_lanes(&project_id).await,
},
```

**Verification**: `just check-rs-cli`

---

## Completion Checklist

After completing all steps:

- [ ] `just check-backend` passes
- [ ] `just clippy-backend` passes
- [ ] `just test-backend` passes
- [ ] `just check-rs-cli` passes

### Files Created (4)
- `backend/pm-server/src/api/swim_lanes/mod.rs`
- `backend/pm-server/src/api/swim_lanes/swim_lane_dto.rs`
- `backend/pm-server/src/api/swim_lanes/swim_lane_list_response.rs`
- `backend/pm-server/src/api/swim_lanes/swim_lanes.rs`
- `backend/crates/pm-cli/src/swim_lane_commands.rs`

### Files Modified (5)
- `backend/pm-server/src/api/mod.rs` — add `swim_lanes` module
- `backend/pm-server/src/lib.rs` — re-export swim lane types/handler
- `backend/pm-server/src/routes.rs` — register 1 route
- `backend/crates/pm-cli/src/client/client.rs` — add 1 client method
- `backend/crates/pm-cli/src/commands.rs` — add SwimLane variant
- `backend/crates/pm-cli/src/main.rs` — add `mod swim_lane_commands`, wire command

---

## Next Session

**Session 121.3.2.5** adds Time Entry CRUD (REST + CLI).
