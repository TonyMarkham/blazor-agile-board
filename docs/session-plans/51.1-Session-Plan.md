# Session 51.1: AppState + Test Helpers

**Parent Plan**: [51-Session-Plan.md](51-Session-Plan.md)
**Target**: ~20-25k tokens
**Prerequisites**: Session 50 complete, all tests passing

---

## Scope

This session adds `ICommentStore` to the centralized `AppState` and updates all test helpers that create `AppState` instances:

1. **AppState Enhancement** - Add ICommentStore property and event subscription
2. **Test Helper Updates** - Update PageIntegrationTests and SharedComponentTests mocks

---

## Learning Objectives

After completing this session, you will understand:

- **Dependency Injection patterns** - How to add a new dependency to an existing class
- **Centralized state management** - Why all stores flow through AppState
- **Test mock setup** - How to create mock dependencies for component tests
- **Event subscription patterns** - Cascading state change notifications

---

## Prerequisites Check

Before starting, verify Session 50 is complete:

```bash
just test-frontend  # Should pass with 615 tests
```

Verify these types exist:
- `ICommentStore` interface in `ProjectManagement.Core/Interfaces/`
- `CommentStore` implementation in `ProjectManagement.Services/State/`

---

## Implementation Order

### Step 1: Add ICommentStore to AppState

**File**: `frontend/ProjectManagement.Services/State/AppState.cs`

The current `AppState` constructor has parameters for `IWebSocketClient`, `IWorkItemStore`, `ISprintStore`, `IProjectStore`, and `ILogger<AppState>`. We need to add `ICommentStore`.

**Find the constructor (around line 28):**
```csharp
public AppState(
    IWebSocketClient client,
    IWorkItemStore workItems,
    ISprintStore sprints,
    IProjectStore projects,
    ILogger<AppState> logger)
```

**Replace with:**
```csharp
public AppState(
    IWebSocketClient client,
    IWorkItemStore workItems,
    ISprintStore sprints,
    IProjectStore projects,
    ICommentStore comments,
    ILogger<AppState> logger)
```

**Add the property (after line 53, with other store properties):**
```csharp
public ICommentStore Comments { get; }
```

**Initialize in constructor body (after `Projects = projects;`):**
```csharp
Comments = comments;
```

**Subscribe to changes (after `projects.OnChanged += () => OnStateChanged?.Invoke();`):**
```csharp
comments.OnChanged += () => OnStateChanged?.Invoke();
```

**Dispose (after the other disposables in Dispose method):**
```csharp
if (Comments is IDisposable commentsDisposable)
    commentsDisposable.Dispose();
```

**Add using statement at top if not present:**
```csharp
using ProjectManagement.Core.Interfaces;
```

**Verification**: `just build-frontend` (will fail tests until Step 2)

---

### Step 2: Update PageIntegrationTests

**File**: `frontend/ProjectManagement.Components.Tests/Pages/PageIntegrationTests.cs`

The test file creates `AppState` with mocked dependencies. We need to add the `ICommentStore` mock.

**Add using statement at top:**
```csharp
using ProjectManagement.Core.Models;
```

**Find the field declarations section and add:**
```csharp
private readonly Mock<ICommentStore> _commentStoreMock;
```

**In the constructor, after other mock initializations, add:**
```csharp
_commentStoreMock = new Mock<ICommentStore>();
_commentStoreMock.Setup(c => c.GetComments(It.IsAny<Guid>()))
    .Returns(new List<Comment>());
```

**Find where AppState is instantiated and update:**

Current (approximately):
```csharp
_appState = new AppState(
    mockClient.Object,
    _workItemStoreMock.Object,
    _sprintStoreMock.Object,
    _projectStoreMock.Object,
    Mock.Of<Microsoft.Extensions.Logging.ILogger<AppState>>());
```

Replace with:
```csharp
_appState = new AppState(
    mockClient.Object,
    _workItemStoreMock.Object,
    _sprintStoreMock.Object,
    _projectStoreMock.Object,
    _commentStoreMock.Object,
    Mock.Of<Microsoft.Extensions.Logging.ILogger<AppState>>());
```

**Register the mock in Services (after other AddSingleton calls):**
```csharp
Services.AddSingleton<ICommentStore>(_commentStoreMock.Object);
```

**Verification**: `just build-cs-components`

---

### Step 3: Update SharedComponentTests

**File**: `frontend/ProjectManagement.Components.Tests/Shared/SharedComponentTests.cs`

This file has a helper method `CreateMockAppState` that needs updating.

**Find the `CreateMockAppState` method (around line 34):**
```csharp
private AppState CreateMockAppState(ConnectionState state)
{
    var mockClient = new Mock<IWebSocketClient>();
    mockClient.Setup(c => c.State).Returns(state);
    mockClient.Setup(c => c.Health).Returns(Mock.Of<IConnectionHealth>());

    var mockWorkItemStore = new Mock<IWorkItemStore>();
    var mockSprintStore = new Mock<ISprintStore>();
    var mockProjectStore = new Mock<IProjectStore>();
    var mockLogger = NullLogger<AppState>.Instance;

    return new AppState(
        mockClient.Object,
        mockWorkItemStore.Object,
        mockSprintStore.Object,
        mockProjectStore.Object,
        mockLogger);
}
```

**Replace with:**
```csharp
private AppState CreateMockAppState(ConnectionState state)
{
    var mockClient = new Mock<IWebSocketClient>();
    mockClient.Setup(c => c.State).Returns(state);
    mockClient.Setup(c => c.Health).Returns(Mock.Of<IConnectionHealth>());

    var mockWorkItemStore = new Mock<IWorkItemStore>();
    var mockSprintStore = new Mock<ISprintStore>();
    var mockProjectStore = new Mock<IProjectStore>();
    var mockCommentStore = new Mock<ICommentStore>();
    var mockLogger = NullLogger<AppState>.Instance;

    return new AppState(
        mockClient.Object,
        mockWorkItemStore.Object,
        mockSprintStore.Object,
        mockProjectStore.Object,
        mockCommentStore.Object,
        mockLogger);
}
```

**Verification**: `just build-cs-components`

---

### Step 4: Run Full Test Suite

```bash
just test-frontend
```

All 615 tests should pass. The new `ICommentStore` parameter is provided by DI at runtime (already registered in Program.cs line 76) and by mocks in tests.

---

## Session 51.1 Completion Checklist

After completing all steps:

- [ ] `just build-frontend` passes
- [ ] `just test-frontend` passes (all 615 tests)
- [ ] AppState has `Comments` property
- [ ] PageIntegrationTests has `_commentStoreMock`
- [ ] SharedComponentTests `CreateMockAppState` includes ICommentStore

### Files Modified (3)

| File | Change |
|------|--------|
| `ProjectManagement.Services/State/AppState.cs` | Add ICommentStore parameter and property |
| `ProjectManagement.Components.Tests/Pages/PageIntegrationTests.cs` | Add _commentStoreMock field and setup |
| `ProjectManagement.Components.Tests/Shared/SharedComponentTests.cs` | Update CreateMockAppState method |

---

## Key Concepts Explained

### Why Add ICommentStore to AppState?

The `AppState` class serves as a centralized facade for all application state. While `ICommentStore` is already registered in DI and could be injected directly into components, adding it to `AppState` provides:

1. **Consistency** - All state access follows the same pattern (`AppState.WorkItems`, `AppState.Sprints`, `AppState.Comments`)
2. **Unified change notifications** - `OnStateChanged` fires when any store changes
3. **Simplified component code** - Components only need to inject `AppState`, not multiple stores
4. **Easier testing** - Mock one `AppState` instead of multiple stores

### Event Subscription Pattern

```csharp
comments.OnChanged += () => OnStateChanged?.Invoke();
```

This line creates a cascading notification:
1. When CommentStore changes internally, it raises `OnChanged`
2. AppState's subscription catches this and raises `OnStateChanged`
3. Components subscribed to `AppState.OnStateChanged` re-render

This pattern ensures UI components stay synchronized with any state change.

---

## Next Session

**Session 51.2** will implement:
- Sprints tab in ProjectDetail.razor
- Comments section in WorkItemDetail.razor
- Active sprints count in Home.razor
- Integration tests for new UI
