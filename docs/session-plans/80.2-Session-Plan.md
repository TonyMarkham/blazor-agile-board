# Session 80.2: DependencyRow Component + Tests

**Parent Plan**: `80-Session-Plan-Teaching.md`
**Target**: ~35-45k tokens
**Prerequisites**: Session 80.1 complete

---

## Scope

Create the smallest reusable UI unit (`DependencyRow`) and verify it with bUnit tests.

1. **DependencyRow component**
2. **Pending state and a11y labels**
3. **Unit tests for rendering and disablement**

---

## Teaching Goals

- Build a focused component with explicit dependencies.
- Use store state to drive UI affordances.
- Write minimal but high-value bUnit tests.

---

## Verified Contracts (Current Repo State)

These are **confirmed present** and should be used as-is:

### Dependency Store
- **Interface**: `frontend/ProjectManagement.Core/Interfaces/IDependencyStore.cs`
  - `IReadOnlyList<Dependency> GetBlocking(Guid workItemId)`
  - `IReadOnlyList<Dependency> GetBlocked(Guid workItemId)`
  - `bool IsPending(Guid dependencyId)`
  - `Task CreateAsync(CreateDependencyRequest request, CancellationToken ct = default)`
  - `Task DeleteAsync(Guid dependencyId, CancellationToken ct = default)`
  - `Task RefreshAsync(Guid workItemId, CancellationToken ct = default)`
  - `event Action? OnChanged`
- **Implementation**: `frontend/ProjectManagement.Services/State/DependencyStore.cs`

### Work Item Access
- **Store**: `frontend/ProjectManagement.Core/Interfaces/IWorkItemStore.cs`
  - `WorkItem? GetById(Guid id)`
  - `IReadOnlyList<WorkItem> GetByProject(Guid projectId)`
- **ViewModel Factory**: `frontend/ProjectManagement.Core/ViewModels/ViewModelFactory.cs`
  - `WorkItemViewModel Create(WorkItem item)`
  - `IReadOnlyList<WorkItemViewModel> CreateMany(IEnumerable<WorkItem> items)`

### Dependency Model
- **Type**: `frontend/ProjectManagement.Core/Models/Dependency.cs`
  - `Guid Id`, `Guid BlockingItemId`, `Guid BlockedItemId`
  - `DependencyType Type`

---

## Known Gaps / Decisions (Resolved Here)

These are **explicitly missing** in the repo and must be handled explicitly in this plan:

1. **No `WorkItemLookup` type alias exists.**
   - Use a delegate parameter with **exact signature**:
     `Func<Guid, WorkItemViewModel?> WorkItemLookup`

2. **No existing Dependency component tests.**
   - Create new test file:
     `frontend/ProjectManagement.Components.Tests/Dependencies/DependencyRowTests.cs`

3. **DependencyRow component does not exist yet.**
   - Create new file:
     `frontend/ProjectManagement.Components/Dependencies/DependencyRow.razor`

---

## Implementation Order

### Step 1: Create DependencyRow

**File**: `frontend/ProjectManagement.Components/Dependencies/DependencyRow.razor`

**Required Parameters** (must be `[Parameter, EditorRequired]`):
- `Dependency Dependency`
- `Guid CurrentWorkItemId`
- `Func<Guid, WorkItemViewModel?> WorkItemLookup`
- `EventCallback<Guid> OnRemove`

**Key behaviors (must implement all):**
- Derive **OtherItemId** based on `CurrentWorkItemId`:
  - If `Dependency.BlockingItemId == CurrentWorkItemId` → other is `BlockedItemId`
  - Else → other is `BlockingItemId`
- **DisplayTitle** from lookup:
  - `WorkItemLookup(OtherItemId)?.Title` or fallback to `OtherItemId.ToString()[..8]`
- **TypeLabel** and **TypeCss**:
  - `Blocks` → label `"Blocks"`, css class `"blocks"`
  - `RelatesTo` → label `"Relates"`, css class `"relates"`
- **Pending state**:
  - `IsPending` from `IDependencyStore.IsPending(Dependency.Id)`
  - Apply `pending` class to root and `aria-busy="true"` when pending
  - Disable delete button when pending
- **Accessibility**:
  - Delete button must include `aria-label` with item title

**Required markup structure** (must match CSS in `dependencies.css`):
- Root: `<div class="dependency-item ...">`
- Title: `<span class="item-title">...`
- Type badge: `<span class="dep-type ...">...`
- Delete button class: `delete-btn`

Reference snippet in `docs/session-plans/80-Session-Plan-Initial.md` (Step 3).

---

### Step 2: Add Unit Tests

**File**: `frontend/ProjectManagement.Components.Tests/Dependencies/DependencyRowTests.cs`

**Test setup pattern** (match existing tests):
- Inherit from `BunitContext`
- Register Radzen services:
  - `DialogService`, `NotificationService`, `TooltipService`, `ContextMenuService`
- Set `JSInterop.Mode = JSRuntimeMode.Loose`

**Tests to implement (all required):**
1. **Pending state disables delete button**
   - Stub `IDependencyStore.IsPending` to `true`
   - Render component and assert delete button is disabled

2. **Title fallback when lookup is missing**
   - Provide `WorkItemLookup` that returns `null`
   - Assert markup contains `OtherItemId.ToString()[..8]`

3. **Type label changes for Blocks vs Relates**
   - Render one `DependencyType.Blocks`, assert `Blocks` and `dep-type blocks`
   - Render one `DependencyType.RelatesTo`, assert `Relates` and `dep-type relates`

**Test stubs:**
- Use `Substitute.For<IDependencyStore>()` for the store
- Provide `WorkItemLookup` as a simple lambda
- Use `EventCallback.Factory.Create<Guid>(this, _ => { })` for `OnRemove`

---

## Completion Checklist

- [ ] `DependencyRow` renders correctly for both types
- [ ] Pending state disables delete
- [ ] bUnit tests added and pass
- [ ] `just build-cs-components` passes
- [ ] `just test-cs-components` passes

---

## Next Session

**Session 80.3** builds `AddDependencyDialog` with accessibility and validation handling.
