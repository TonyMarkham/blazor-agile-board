# Session 42.4: Startup UI Components

**Parent Plan**: `42-Session-Plan-Overview.md`
**Prerequisite**: Session 42.3 completed
**Target**: ~40-45k tokens

---

## Teaching Focus

This session teaches:
- **State-driven UI** - UI reflects app state, not direct manipulation
- **Blazor component patterns** - Parameters, callbacks, lifecycle
- **CSS styling** - Modern gradient, animations, responsive design
- **Accessibility** - ARIA attributes, keyboard navigation, reduced motion

---

## Scope

1. **App.razor** - State machine integration
2. **StartupScreen** - Progress indication during initialization
3. **UserRegistrationScreen** - First-launch registration form
4. **ErrorScreen** - Error recovery UI

---

## Prerequisites Check

Before starting, verify Sessions 42.1-42.3 are complete:

```bash
dotnet build frontend/ProjectManagement.sln
ls frontend/ProjectManagement.Services/Desktop/TauriService.cs
ls frontend/ProjectManagement.Core/State/AppStartupState.cs
```

---

## Implementation Order

### Step 1: Rewrite App.razor with State Machine

**File**: `frontend/ProjectManagement.Wasm/App.razor`

```razor
@using ProjectManagement.Core.State
@using ProjectManagement.Core.Models
@using ProjectManagement.Services.Desktop
@using ProjectManagement.Services.State
@using ProjectManagement.Components.Desktop
@implements IAsyncDisposable
@inject IDesktopConfigService DesktopConfig
@inject UserIdentityService UserIdentityService
@inject AppState AppState
@inject ILogger<App> Logger

@switch (StartupState)
{
    case AppStartupState.Initializing:
    case AppStartupState.WaitingForServer:
    case AppStartupState.CheckingIdentity:
    case AppStartupState.ConnectingWebSocket:
        <StartupScreen
            State="StartupState"
            StatusMessage="@StatusMessage"
            OnRetry="OnRetryAsync" />
        break;

    case AppStartupState.NeedsRegistration:
        <UserRegistrationScreen
            OnUserCreated="OnUserRegisteredAsync"
            OnError="OnRegistrationError" />
        break;

    case AppStartupState.Error:
        <ErrorScreen
            Title="@ErrorTitle"
            Message="@ErrorMessage"
            OnRetry="OnRetryAsync" />
        break;

    case AppStartupState.Reconnecting:
        <StartupScreen
            State="StartupState"
            StatusMessage="@StatusMessage"
            OnRetry="OnRetryAsync" />
        break;

    case AppStartupState.Ready:
        <Router AppAssembly="@typeof(App).Assembly">
            <Found Context="routeData">
                <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
            </Found>
            <NotFound>
                <PageTitle>Not found</PageTitle>
                <LayoutView Layout="@typeof(MainLayout)">
                    <p role="alert">Sorry, there's nothing at this address.</p>
                </LayoutView>
            </NotFound>
        </Router>
        break;
}

@code {
    // Timeout configuration
    private static readonly TimeSpan ServerStartupTimeout = TimeSpan.FromSeconds(30);

    // Status messages
    private const string StatusInitializing = "Initializing...";
    private const string StatusStartingServer = "Starting server...";
    private const string StatusLoadingProfile = "Loading your profile...";
    private const string StatusConnectingWorkspace = "Connecting to workspace...";
    private const string StatusReconnecting = "Reconnecting...";

    // Error titles
    private const string ErrorTitleDefault = "Error";
    private const string ErrorTitleStartupFailed = "Startup Failed";
    private const string ErrorTitleServerTimeout = "Server Timeout";
    private const string ErrorTitleServerError = "Server Error";
    private const string ErrorTitleProfileError = "Profile Error";
    private const string ErrorTitleRegistrationFailed = "Registration Failed";
    private const string ErrorTitleConnectionFailed = "Connection Failed";

    // Error messages
    private const string ErrorMessageUnexpected = "An unexpected error occurred. Please try again.";
    private const string ErrorMessageServerTimeout = "The server took too long to start. Please try again.";
    private const string ErrorMessageProfileLoad = "Could not load your profile. Please try again.";
    private const string ErrorMessageConnectionFailed = "Could not connect to workspace. Please try again.";
    private const string ErrorMessageNetworkFailed = "Could not establish connection. Please check your network and try again.";

    private AppStartupState StartupState = AppStartupState.Initializing;
    private string StatusMessage = StatusInitializing;
    private string ErrorTitle = ErrorTitleDefault;
    private string? ErrorMessage;
    private UserIdentity? CurrentUser;
    private bool IsDesktopMode;
    private CancellationTokenSource? _cts;
    private IDisposable? _connectionStateSubscription;

    protected override async Task OnInitializedAsync()
    {
        _cts = new CancellationTokenSource();

        try
        {
            await RunStartupSequenceAsync(_cts.Token);
        }
        catch (OperationCanceledException)
        {
            Logger.LogInformation("Startup cancelled");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Fatal error during startup");
            TransitionTo(AppStartupState.Error);
            ErrorTitle = ErrorTitleStartupFailed;
            ErrorMessage = ErrorMessageUnexpected;
        }
    }

    private async Task RunStartupSequenceAsync(CancellationToken ct)
    {
        // Step 1: Detect desktop mode
        try
        {
            IsDesktopMode = await DesktopConfig.IsDesktopModeAsync();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to detect desktop mode, assuming web");
            IsDesktopMode = false;
        }

        if (!IsDesktopMode)
        {
            // Web mode - skip desktop startup
            TransitionTo(AppStartupState.Ready);
            return;
        }

        // Step 2: Wait for server
        TransitionTo(AppStartupState.WaitingForServer);
        StatusMessage = StatusStartingServer;
        await InvokeAsync(StateHasChanged);

        try
        {
            await DesktopConfig.WaitForServerAsync(ServerStartupTimeout, ct);
        }
        catch (TimeoutException)
        {
            Logger.LogError("Server startup timed out");
            TransitionTo(AppStartupState.Error);
            ErrorTitle = ErrorTitleServerTimeout;
            ErrorMessage = ErrorMessageServerTimeout;
            return;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Server startup failed");
            TransitionTo(AppStartupState.Error);
            ErrorTitle = ErrorTitleServerError;
            ErrorMessage = ex.Message;
            return;
        }

        // Step 3: Check for existing user identity
        TransitionTo(AppStartupState.CheckingIdentity);
        StatusMessage = StatusLoadingProfile;
        await InvokeAsync(StateHasChanged);

        try
        {
            CurrentUser = await UserIdentityService.GetCurrentUserAsync(ct);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load user identity");
            TransitionTo(AppStartupState.Error);
            ErrorTitle = ErrorTitleProfileError;
            ErrorMessage = ErrorMessageProfileLoad;
            return;
        }

        if (CurrentUser == null)
        {
            // First launch - need registration
            TransitionTo(AppStartupState.NeedsRegistration);
            await InvokeAsync(StateHasChanged);
            return;
        }

        // Step 4: Connect WebSocket
        await ConnectWithUserAsync(CurrentUser, ct);
    }

    private async Task OnUserRegisteredAsync(UserIdentity user)
    {
        CurrentUser = user;
        _cts ??= new CancellationTokenSource();

        try
        {
            await ConnectWithUserAsync(user, _cts.Token);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to connect after registration");
            TransitionTo(AppStartupState.Error);
            ErrorTitle = ErrorTitleConnectionFailed;
            ErrorMessage = ErrorMessageConnectionFailed;
        }
    }

    private void OnRegistrationError(string error)
    {
        TransitionTo(AppStartupState.Error);
        ErrorTitle = ErrorTitleRegistrationFailed;
        ErrorMessage = error;
    }

    private async Task ConnectWithUserAsync(UserIdentity user, CancellationToken ct)
    {
        TransitionTo(AppStartupState.ConnectingWebSocket);
        StatusMessage = StatusConnectingWorkspace;
        await InvokeAsync(StateHasChanged);

        try
        {
            // Set user before connecting
            AppState.SetCurrentUser(user);

            // Subscribe to connection state changes
            _connectionStateSubscription?.Dispose();
            _connectionStateSubscription = AppState.OnConnectionStateChanged(OnConnectionStateChanged);

            await AppState.InitializeAsync(ct);

            TransitionTo(AppStartupState.Ready);
            Logger.LogInformation("Startup complete for user {UserId}", user.Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "WebSocket connection failed");
            TransitionTo(AppStartupState.Error);
            ErrorTitle = ErrorTitleConnectionFailed;
            ErrorMessage = ErrorMessageNetworkFailed;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async void OnConnectionStateChanged(ConnectionState state)
    {
        if (state == ConnectionState.Disconnected && StartupState == AppStartupState.Ready)
        {
            Logger.LogWarning("WebSocket disconnected, attempting reconnect");
            TransitionTo(AppStartupState.Reconnecting);
            StatusMessage = StatusReconnecting;
            await InvokeAsync(StateHasChanged);
        }
        else if (state == ConnectionState.Connected && StartupState == AppStartupState.Reconnecting)
        {
            Logger.LogInformation("WebSocket reconnected");
            TransitionTo(AppStartupState.Ready);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnRetryAsync()
    {
        TransitionTo(AppStartupState.Initializing);
        ErrorMessage = "";
        ErrorTitle = ErrorTitleDefault;
        StatusMessage = StatusInitializing;

        _cts?.Cancel();
        _cts?.Dispose();
        _cts = new CancellationTokenSource();

        await InvokeAsync(StateHasChanged);
        await RunStartupSequenceAsync(_cts.Token);
    }

    private void TransitionTo(AppStartupState newState)
    {
        if (StartupState == newState) return;

        if (!AppStartupStateTransitions.CanTransition(StartupState, newState))
        {
            Logger.LogWarning("Invalid state transition from {From} to {To}, forcing",
                StartupState, newState);
        }

        Logger.LogDebug("State transition: {From} → {To}", StartupState, newState);
        StartupState = newState;
    }

    public async ValueTask DisposeAsync()
    {
        _connectionStateSubscription?.Dispose();
        _cts?.Cancel();
        _cts?.Dispose();
    }
}
```

---

### Step 2: Create StartupScreen Component

**Create**: `frontend/ProjectManagement.Components/Desktop/StartupScreen.razor`

```razor
@using ProjectManagement.Core.State
@inject ILogger<StartupScreen> Logger

<div class="startup-screen" role="status" aria-live="polite">
    <div class="startup-content">
        <div class="app-logo" aria-hidden="true">
            <svg class="logo-icon" viewBox="0 0 24 24" width="64" height="64">
                <path fill="currentColor" d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
            </svg>
        </div>

        <h1 class="app-title">Project Manager</h1>

        @if (!HasError)
        {
            <div class="progress-section">
                <div class="spinner" aria-hidden="true">
                    <div class="spinner-ring"></div>
                </div>

                <p class="status-message" id="status-message">@StatusMessage</p>
                <p class="status-detail">@GetStateDetail()</p>

                <div class="progress-bar" role="progressbar"
                     aria-valuenow="@GetProgressPercent()"
                     aria-valuemin="0"
                     aria-valuemax="100"
                     aria-labelledby="status-message">
                    <div class="progress-fill" style="width: @(GetProgressPercent())%"></div>
                </div>
            </div>
        }
        else
        {
            <div class="error-section" role="alert">
                <div class="error-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" width="48" height="48">
                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                </div>
                <p class="error-message">@ErrorMessage</p>

                <div class="error-actions">
                    <button class="btn btn-primary"
                            @onclick="OnRetryClick"
                            @onkeydown="OnRetryKeyDown"
                            aria-label="Retry starting the application">
                        <svg class="btn-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                            <path fill="currentColor" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        </svg>
                        Retry
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    // Progress percentages for each state
    private const int ProgressInitializing = 10;
    private const int ProgressWaitingForServer = 30;
    private const int ProgressCheckingIdentity = 50;
    private const int ProgressConnectingWebSocket = 70;
    private const int ProgressReconnecting = 50;
    private const int ProgressReady = 100;
    private const int ProgressDefault = 0;

    // State detail messages
    private const string DetailInitializing = "Detecting environment...";
    private const string DetailWaitingForServer = "This may take a few seconds on first launch";
    private const string DetailCheckingIdentity = "Loading your profile...";
    private const string DetailConnectingWebSocket = "Establishing real-time connection...";
    private const string DetailReconnecting = "Connection lost, attempting to reconnect...";

    // Keyboard keys
    private const string KeyEnter = "Enter";
    private const string KeySpace = " ";

    [Parameter] public AppStartupState State { get; set; }
    [Parameter] public string StatusMessage { get; set; } = "";
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public EventCallback OnRetry { get; set; }

    private bool HasError => !string.IsNullOrEmpty(ErrorMessage);

    private string GetStateDetail() => State switch
    {
        AppStartupState.Initializing => DetailInitializing,
        AppStartupState.WaitingForServer => DetailWaitingForServer,
        AppStartupState.CheckingIdentity => DetailCheckingIdentity,
        AppStartupState.ConnectingWebSocket => DetailConnectingWebSocket,
        AppStartupState.Reconnecting => DetailReconnecting,
        _ => ""
    };

    private int GetProgressPercent() => State switch
    {
        AppStartupState.Initializing => ProgressInitializing,
        AppStartupState.WaitingForServer => ProgressWaitingForServer,
        AppStartupState.CheckingIdentity => ProgressCheckingIdentity,
        AppStartupState.ConnectingWebSocket => ProgressConnectingWebSocket,
        AppStartupState.Reconnecting => ProgressReconnecting,
        AppStartupState.Ready => ProgressReady,
        _ => ProgressDefault
    };

    private async Task OnRetryClick()
    {
        await OnRetry.InvokeAsync();
    }

    private async Task OnRetryKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == KeyEnter || e.Key == KeySpace)
        {
            await OnRetry.InvokeAsync();
        }
    }
}
```

**Create**: `frontend/ProjectManagement.Components/Desktop/StartupScreen.razor.css`

```css
.startup-screen {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 1rem;
}

.startup-content {
    text-align: center;
    padding: 3rem;
    background: rgba(255, 255, 255, 0.98);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    min-width: 380px;
    max-width: 480px;
}

.app-logo {
    margin-bottom: 1.5rem;
    color: #667eea;
}

.app-title {
    font-size: 1.75rem;
    font-weight: 600;
    color: #1a1a2e;
    margin: 0 0 2rem 0;
}

.progress-section {
    padding: 1rem 0;
}

.spinner {
    margin: 0 auto 1.5rem;
    width: 48px;
    height: 48px;
}

.spinner-ring {
    width: 100%;
    height: 100%;
    border: 4px solid #e0e0e0;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.status-message {
    font-size: 1.125rem;
    font-weight: 500;
    color: #333;
    margin: 0 0 0.5rem 0;
}

.status-detail {
    font-size: 0.875rem;
    color: #666;
    margin: 0 0 1.5rem 0;
}

.progress-bar {
    height: 4px;
    background: #e0e0e0;
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 2px;
    transition: width 0.3s ease;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 500;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

/* Accessibility: Reduced motion */
@media (prefers-reduced-motion: reduce) {
    .spinner-ring {
        animation: none;
        border-top-color: #667eea;
        border-right-color: #667eea;
    }

    .progress-fill {
        transition: none;
    }
}

/* High contrast mode */
@media (prefers-contrast: high) {
    .startup-content {
        border: 2px solid #000;
    }

    .btn-primary {
        background: #000;
    }
}
```

---

### Step 3: Create UserRegistrationScreen Component

**Create**: `frontend/ProjectManagement.Components/Desktop/UserRegistrationScreen.razor`

```razor
@using ProjectManagement.Core.Models
@using ProjectManagement.Core.Validation
@inject UserIdentityService UserService
@inject ILogger<UserRegistrationScreen> Logger

<div class="registration-screen">
    <div class="registration-content" role="form" aria-labelledby="reg-title">
        <div class="app-logo" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="64" height="64">
                <path fill="currentColor" d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </div>

        <h1 id="reg-title" class="title">Welcome to Project Manager</h1>
        <p class="subtitle">Let's set up your workspace</p>

        <div class="form-section">
            <div class="form-group">
                <label for="name-input" class="form-label">
                    Your Name
                    <span class="optional-badge">(optional)</span>
                </label>
                <input
                    id="name-input"
                    type="text"
                    class="form-input @(NameError != null ? "input-error" : "")"
                    placeholder="Enter your name"
                    maxlength="@RegistrationValidator.MaxNameLength"
                    @bind="Name"
                    @bind:event="oninput"
                    @onfocus="ClearNameError"
                    aria-describedby="@(NameError != null ? "name-error" : null)"
                    aria-invalid="@(NameError != null)" />
                @if (NameError != null)
                {
                    <p id="name-error" class="field-error" role="alert">@NameError</p>
                }
            </div>

            <div class="form-group">
                <label for="email-input" class="form-label">
                    Email
                    <span class="optional-badge">(optional)</span>
                </label>
                <input
                    id="email-input"
                    type="email"
                    class="form-input @(EmailError != null ? "input-error" : "")"
                    placeholder="you@example.com"
                    maxlength="@RegistrationValidator.MaxEmailLength"
                    @bind="Email"
                    @bind:event="oninput"
                    @onfocus="ClearEmailError"
                    aria-describedby="@(EmailError != null ? "email-error" : null)"
                    aria-invalid="@(EmailError != null)" />
                @if (EmailError != null)
                {
                    <p id="email-error" class="field-error" role="alert">@EmailError</p>
                }
            </div>

            @if (GeneralError != null)
            {
                <div class="general-error" role="alert">
                    <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                        <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <span>@GeneralError</span>
                </div>
            }

            <button
                type="button"
                class="btn btn-primary btn-submit"
                @onclick="OnGetStartedAsync"
                disabled="@IsCreating"
                aria-busy="@IsCreating">
                @if (IsCreating)
                {
                    <span class="btn-spinner" aria-hidden="true"></span>
                    <span>Creating...</span>
                }
                else
                {
                    <span>Get Started</span>
                    <svg class="btn-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                        <path fill="currentColor" d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
                    </svg>
                }
            </button>
        </div>

        <p class="privacy-note">
            <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                <path fill="currentColor" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            Your information stays on this device and is never sent to external servers.
        </p>
    </div>
</div>

@code {
    // Error messages
    private const string ErrorSomethingWentWrong = "Something went wrong. Please try again.";

    // Validation field identifiers
    private const string FieldName = "Name";
    private const string FieldEmail = "email";

    [Parameter] public EventCallback<UserIdentity> OnUserCreated { get; set; }
    [Parameter] public EventCallback<string> OnError { get; set; }

    private string? Name;
    private string? Email;
    private bool IsCreating;
    private string? NameError;
    private string? EmailError;
    private string? GeneralError;

    private void ClearNameError() => NameError = null;
    private void ClearEmailError() => EmailError = null;

    private bool ValidateForm()
    {
        var validation = RegistrationValidator.Validate(Name, Email);

        if (validation.IsValid)
        {
            NameError = null;
            EmailError = null;
            return true;
        }

        foreach (var error in validation.Errors)
        {
            if (error.Contains(FieldName, StringComparison.OrdinalIgnoreCase))
                NameError = error;
            else if (error.Contains(FieldEmail, StringComparison.OrdinalIgnoreCase))
                EmailError = error;
        }

        return false;
    }

    private async Task OnGetStartedAsync()
    {
        if (IsCreating) return;

        GeneralError = null;

        if (!ValidateForm())
        {
            return;
        }

        IsCreating = true;
        StateHasChanged();

        try
        {
            var user = await UserService.CreateNewUserAsync(Name, Email);
            Logger.LogInformation("User registered: {UserId}", user.Id);
            await OnUserCreated.InvokeAsync(user);
        }
        catch (ArgumentException ex)
        {
            Logger.LogWarning(ex, "Validation error during registration");
            GeneralError = ex.Message;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create user");
            GeneralError = ErrorSomethingWentWrong;
            await OnError.InvokeAsync(GeneralError);
        }
        finally
        {
            IsCreating = false;
            StateHasChanged();
        }
    }
}
```

**Create**: `frontend/ProjectManagement.Components/Desktop/UserRegistrationScreen.razor.css`

```css
.registration-screen {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 1rem;
}

.registration-content {
    text-align: center;
    padding: 3rem;
    background: rgba(255, 255, 255, 0.98);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    width: 100%;
    max-width: 420px;
}

.app-logo {
    color: #667eea;
    margin-bottom: 1rem;
}

.title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1a1a2e;
    margin: 0 0 0.5rem 0;
}

.subtitle {
    font-size: 1rem;
    color: #666;
    margin: 0 0 2rem 0;
}

.form-section {
    text-align: left;
}

.form-group {
    margin-bottom: 1.25rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #333;
    margin-bottom: 0.5rem;
}

.optional-badge {
    font-weight: 400;
    color: #888;
    margin-left: 0.25rem;
}

.form-input {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
}

.form-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

.form-input.input-error {
    border-color: #dc3545;
}

.form-input.input-error:focus {
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
}

.field-error {
    font-size: 0.8125rem;
    color: #dc3545;
    margin: 0.375rem 0 0 0;
}

.general-error {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #fff5f5;
    border: 1px solid #fed7d7;
    border-radius: 8px;
    color: #c53030;
    font-size: 0.875rem;
    margin-bottom: 1.25rem;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
    font-weight: 500;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.btn:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-submit {
    width: 100%;
    margin-top: 0.5rem;
    justify-content: center;
}

.btn-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

.privacy-note {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: #888;
    margin: 1.5rem 0 0 0;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (prefers-reduced-motion: reduce) {
    .btn-spinner {
        animation: none;
        border-top-color: transparent;
        border-right-color: white;
    }
}
```

---

### Step 4: Create ErrorScreen Component

**Create**: `frontend/ProjectManagement.Components/Desktop/ErrorScreen.razor`

```razor
<div class="error-screen" role="alert" aria-live="assertive">
    <div class="error-content">
        <div class="error-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="80" height="80">
                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
        </div>

        <h1 class="error-title">@Title</h1>
        <p class="error-message">@Message</p>

        @if (IsRetryable)
        {
            <div class="error-actions">
                <button class="btn btn-primary" @onclick="OnRetryClick">
                    <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                        <path fill="currentColor" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Try Again
                </button>
            </div>
        }
    </div>
</div>

@code {
    // Default values
    private const string DefaultErrorTitle = "Something went wrong";

    [Parameter] public string Title { get; set; } = DefaultErrorTitle;
    [Parameter] public string Message { get; set; } = "";
    [Parameter] public bool IsRetryable { get; set; } = true;
    [Parameter] public EventCallback OnRetry { get; set; }

    private async Task OnRetryClick() => await OnRetry.InvokeAsync();
}
```

**Create**: `frontend/ProjectManagement.Components/Desktop/ErrorScreen.razor.css`

```css
.error-screen {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 1rem;
}

.error-content {
    text-align: center;
    padding: 3rem;
    background: rgba(255, 255, 255, 0.98);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    max-width: 480px;
}

.error-icon {
    color: #dc3545;
    margin-bottom: 1.5rem;
}

.error-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1a1a2e;
    margin: 0 0 1rem 0;
}

.error-message {
    font-size: 1rem;
    color: #666;
    margin: 0 0 2rem 0;
    line-height: 1.5;
}

.error-actions {
    display: flex;
    justify-content: center;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 2rem;
    font-size: 1rem;
    font-weight: 500;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}
```

---

## Session 42.4 Completion Checklist

After completing all steps:

- [x] `dotnet build frontend/ProjectManagement.sln` passes
- [x] App shows startup screen when launched
- [x] First launch shows registration screen
- [x] Error shows retry button
- [x] Keyboard navigation works (Tab, Enter, Space)
- [x] Reduced motion setting respected

### Files Created (6)
- `frontend/ProjectManagement.Components/Desktop/StartupScreen.razor`
- `frontend/ProjectManagement.Components/Desktop/StartupScreen.razor.css`
- `frontend/ProjectManagement.Components/Desktop/UserRegistrationScreen.razor`
- `frontend/ProjectManagement.Components/Desktop/UserRegistrationScreen.razor.css`
- `frontend/ProjectManagement.Components/Desktop/ErrorScreen.razor`
- `frontend/ProjectManagement.Components/Desktop/ErrorScreen.razor.css`

### Files Modified (1)
- `frontend/ProjectManagement.Wasm/App.razor`

---

## Key Concepts Learned

1. **State-Driven UI** - `@switch (StartupState)` renders different components based on state
2. **ARIA Attributes** - `role="alert"`, `aria-live`, `aria-invalid` for accessibility
3. **CSS Scoping** - `.razor.css` files scope styles to the component
4. **Reduced Motion** - `@media (prefers-reduced-motion: reduce)` for accessibility
5. **Double-Click Prevention** - `disabled="@IsCreating"` prevents multiple submissions

---

## Next Session

**Session 42.5** will implement:
- Build scripts (dev.sh, dev.ps1, build.sh, build.ps1)
- GitHub Actions CI/CD workflow
- Unit tests for UserIdentityService
- Manual testing checklist (TESTING.md)

---

## Session 42.4 Completion Notes

**Status**: ✅ Complete (158k tokens consumed)

### All Planned Deliverables Completed

**Files Created (6/6):**
- ✅ `frontend/ProjectManagement.Components/Desktop/StartupScreen.razor`
- ✅ `frontend/ProjectManagement.Components/Desktop/StartupScreen.razor.css`
- ✅ `frontend/ProjectManagement.Components/Desktop/UserRegistrationScreen.razor`
- ✅ `frontend/ProjectManagement.Components/Desktop/UserRegistrationScreen.razor.css`
- ✅ `frontend/ProjectManagement.Components/Desktop/ErrorScreen.razor`
- ✅ `frontend/ProjectManagement.Components/Desktop/ErrorScreen.razor.css`

**Files Modified (1/1):**
- ✅ `frontend/ProjectManagement.Wasm/App.razor` - State machine integration

### Critical Bug Fixes Beyond Session Scope

The following issues were **NOT** in the session plan but required fixing for functionality:

#### 1. Tauri IPC Serialization (Rust Backend)
**File**: `desktop/src-tauri/src/server/server_state.rs`
**Fix**: Added `serde::Serialize` to ServerState enum
**Why**: Tauri couldn't emit Rust state as JSON to frontend
**Impact**: Frontend state change events now work

#### 2. Race Condition/Deadlock (Rust Backend)
**File**: `desktop/src-tauri/src/lib.rs:105-138`
**Fix**: Extract state data before emitting instead of querying manager during state change
**Why**: Event handler deadlocked trying to acquire locks held by startup sequence
**Impact**: App no longer hangs on startup screen

#### 3. Missing is_healthy Field (Rust Backend)
**File**: `desktop/src-tauri/src/commands.rs:101-103`
**Fix**: Calculate and include `is_healthy` in ServerStatus struct
**Why**: Frontend couldn't determine if server was truly ready
**Impact**: State machine properly transitions to Ready

#### 4. User Identity Persistence (Rust Backend)
**File**: `backend/crates/pm-ws/src/app_state.rs:114-150`
**Fix**: Read `user_id` from WebSocket query params instead of hardcoded config value
**Why**: User ID changed between sessions, breaking project ownership
**Impact**: Projects remain accessible after app restart (core bug resolved)

#### 5. Code Duplication Cleanup (Rust Backend)
**Files**: `desktop/src-tauri/src/commands.rs` and `lib.rs`
**Fix**: Extracted `build_server_status()` helper function
**Why**: Same ServerStatus construction logic duplicated in two places
**Impact**: DRY principle restored, ~40 lines of duplication removed

#### 6. Missing DI Dependencies (C# Frontend)
**File**: `frontend/ProjectManagement.Wasm/Program.cs:16`
**Fix**: Registered TauriService before IDesktopConfigService
**Why**: DI resolution failed at runtime
**Impact**: Services properly injected

#### 7. Validation Error Handling (C# Frontend)
**File**: `UserRegistrationScreen.razor:137-140`
**Fix**: Use `error.Field.Equals()` and `error.Message` instead of `error.Contains()`
**Why**: Wrong API on ValidationError record
**Impact**: Validation errors display correctly

#### 8. JavaScript Event Listener (Frontend)
**File**: `frontend/ProjectManagement.Wasm/wwwroot/index.html:48-61`
**Fix**: Added `setupTauriListener` function for Tauri event subscriptions
**Why**: Frontend couldn't subscribe to Rust backend events
**Impact**: Real-time server state updates work

### Minor Deviations from Plan

1. **App.razor uses `IDisposable` instead of `IAsyncDisposable`**
   - Session plan: Line 52 `@implements IAsyncDisposable`
   - Actual: Line 7 `@implements IDisposable`
   - **Impact**: None - simpler synchronous disposal is sufficient

2. **Subscription method name differs**
   - Session plan: `AppState.OnConnectionStateChanged(callback)` (line 276)
   - Actual: `AppState.SubscribeToConnectionStateChanged(callback)` (line 231)
   - **Impact**: None - more descriptive name follows C# conventions

### Verification Results

✅ All completion checklist items verified:
- Build clean with 0 warnings, 0 errors
- Startup screen displays with progress
- Registration screen shows on first launch
- Error screen with retry button functions correctly
- Keyboard navigation works (Tab, Enter, Space)
- Reduced motion media query respected

✅ **Core bug resolved**: User can create project → close app → reopen → project remains accessible

### Code Quality Assessment

**Production Grade**: ✅ Yes
**Bandaid Count**: 1 (resolved with `build_server_status()` helper)
**Test Coverage**: All existing tests passing
**Accessibility**: ARIA attributes, keyboard nav, reduced motion support included

### Lessons Learned

1. **Session plans should include runtime integration testing** - Many bugs only surfaced when actually running the app
2. **Rust async lock contention is subtle** - State change handlers must not query the manager that emitted the change
3. **WebSocket user_id passing was incomplete** - Backend infrastructure existed but wasn't connected
4. **Token budgets for "UI only" sessions are underestimated** - 42.4 consumed 158k (3.5x estimate) due to runtime debugging
