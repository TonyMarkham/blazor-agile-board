# Session 51.2: UI Integration + Tests ✅

**Parent Plan**: [51-Session-Plan.md](51-Session-Plan.md)
**Prerequisite**: Session 51.1 completed
**Target**: ~35-40k tokens
**Status**: Complete (2026-01-27)

---

## Scope

This session integrates Sprint and Comment components into the main UI pages:

1. **ProjectDetail Sprints Tab** - Full sprint management with CRUD operations
2. **WorkItemDetail Comments** - Comment thread using CommentList component
3. **Home Active Sprints** - Real-time count of active sprints
4. **Integration Tests** - Test the new UI integrations

---

## Learning Objectives

After completing this session, you will understand:

- **Blazor tab navigation** - Adding tabs with state-driven visibility
- **Component composition** - Embedding reusable components (SprintCard, CommentList)
- **Dialog patterns** - Opening Radzen dialogs with parameters and callbacks
- **Event subscription lifecycle** - Subscribe in OnInitialized, unsubscribe in Dispose
- **Integration testing** - Testing page components with mocked services

---

## Prerequisites Check

Before starting, verify Session 51.1 is complete:

```bash
just test-frontend  # Should pass with 390 tests (37 Core + 76 Services + 277 Components)
```

Verify `AppState` has the `Comments` property:
```csharp
// In AppState.cs
public ICommentStore Comments { get; }
```

---

## Implementation Order

### Step 1: Add Sprints Tab to ProjectDetail

**File**: `frontend/ProjectManagement.Wasm/Pages/ProjectDetail.razor`

This is the largest change. We're adding a third tab alongside "List" and "Board".

#### 1.1 Add Using Statement

At the top of the file, add:
```razor
@using ProjectManagement.Components.Sprints
@using ProjectManagement.Core.Models
```

#### 1.2 Add Tab Button

Find the tab buttons section (around line 57-68). After the "Board" tab button, add:

```razor
<button class="view-tab @(_activeView == "sprints" ? "active" : "")"
        @onclick="@(() => _activeView = "sprints")">
    <RadzenIcon Icon="timer" />
    Sprints
</button>
```

#### 1.3 Add Sprints View Section

Find where the view sections are rendered (after the Board view, around line 80). Add:

```razor
else if (_activeView == "sprints")
{
    <div class="content-card">
        <div class="content-card-header">
            <h2 class="content-card-title">Sprints</h2>
            <LoadingButton Text="New Sprint" Icon="add"
                           ConnectionState="@_connectionState"
                           OnClick="@ShowCreateSprintDialog" />
        </div>

        @if (_loadingSprints)
        {
            <div class="p-4">
                <RadzenProgressBar Mode="ProgressBarMode.Indeterminate" />
            </div>
        }
        else if (!_sprints.Any())
        {
            <div class="p-4">
                <EmptyState Icon="timer" Title="No Sprints"
                            Description="Create your first sprint to start planning work."
                            ActionText="Create Sprint"
                            OnAction="@ShowCreateSprintDialog" />
            </div>
        }
        else
        {
            <RadzenStack Gap="1rem" class="p-3">
                @foreach (var sprint in _sprints.OrderByDescending(s => s.StartDate))
                {
                    <SprintCard Sprint="@sprint"
                                ShowProgress="true"
                                TotalItems="@GetSprintItemCount(sprint.Id)"
                                CompletedItems="@GetSprintCompletedCount(sprint.Id)"
                                CanStart="@(sprint.Status == SprintStatus.Planned && _connectionState == ConnectionState.Connected)"
                                CanComplete="@(sprint.Status == SprintStatus.Active && _connectionState == ConnectionState.Connected)"
                                CanEdit="@(_connectionState == ConnectionState.Connected)"
                                CanDelete="@(sprint.Status == SprintStatus.Planned && _connectionState == ConnectionState.Connected)"
                                OnEditClick="@(() => ShowEditSprintDialog(sprint))"
                                OnDeleteClick="@(() => HandleDeleteSprint(sprint))"
                                OnStartClick="@(() => HandleStartSprint(sprint))"
                                OnCompleteClick="@(() => HandleCompleteSprint(sprint))" />
                }
            </RadzenStack>
        }
    </div>
}
```

#### 1.4 Add Code Section Fields and Methods

In the `@code` section, add the following fields:

```csharp
private List<Sprint> _sprints = new();
private bool _loadingSprints = true;
```

Add helper methods for sprint item counts:

```csharp
private int GetSprintItemCount(Guid sprintId) =>
    AppState.WorkItems.GetByProject(ProjectId)
        .Count(w => w.SprintId == sprintId && w.DeletedAt == null);

private int GetSprintCompletedCount(Guid sprintId) =>
    AppState.WorkItems.GetByProject(ProjectId)
        .Count(w => w.SprintId == sprintId && w.Status == "done" && w.DeletedAt == null);
```

Add the refresh method:

```csharp
private async Task RefreshSprints()
{
    _loadingSprints = true;
    StateHasChanged();

    try
    {
        _sprints = AppState.Sprints.GetByProject(ProjectId).ToList();
    }
    finally
    {
        _loadingSprints = false;
        StateHasChanged();
    }
}
```

Add dialog methods:

```csharp
private async Task ShowCreateSprintDialog()
{
    await DialogService.OpenAsync<SprintDialog>("Create Sprint",
        new Dictionary<string, object>
        {
            { "ProjectId", ProjectId },
            { "OnCreate", EventCallback.Factory.Create<CreateSprintRequest>(this, HandleCreateSprint) },
            { "OnCancel", EventCallback.Factory.Create(this, () => DialogService.Close()) }
        },
        new DialogOptions { Width = "500px" });
}

private async Task ShowEditSprintDialog(Sprint sprint)
{
    await DialogService.OpenAsync<SprintDialog>("Edit Sprint",
        new Dictionary<string, object>
        {
            { "Sprint", sprint },
            { "ProjectId", ProjectId },
            { "OnUpdate", EventCallback.Factory.Create<UpdateSprintRequest>(this, HandleUpdateSprint) },
            { "OnCancel", EventCallback.Factory.Create(this, () => DialogService.Close()) }
        },
        new DialogOptions { Width = "500px" });
}
```

Add CRUD handlers:

```csharp
private async Task HandleCreateSprint(CreateSprintRequest request)
{
    try
    {
        await AppState.Sprints.CreateAsync(request);
        DialogService.Close();
        NotificationService.Notify(NotificationSeverity.Success, "Created", "Sprint created");
    }
    catch (Exception ex)
    {
        NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
    }
}

private async Task HandleUpdateSprint(UpdateSprintRequest request)
{
    try
    {
        await AppState.Sprints.UpdateAsync(request);
        DialogService.Close();
        NotificationService.Notify(NotificationSeverity.Success, "Updated", "Sprint updated");
    }
    catch (Exception ex)
    {
        NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
    }
}

private async Task HandleDeleteSprint(Sprint sprint)
{
    var confirmed = await DialogService.Confirm(
        $"Delete sprint \"{sprint.Name}\"?", "Delete Sprint",
        new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });
    if (confirmed == true)
    {
        try
        {
            await AppState.Sprints.DeleteAsync(sprint.Id);
            NotificationService.Notify(NotificationSeverity.Success, "Deleted", "Sprint deleted");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
    }
}

private async Task HandleStartSprint(Sprint sprint)
{
    try
    {
        await AppState.Sprints.StartSprintAsync(sprint.Id, sprint.Version);
        NotificationService.Notify(NotificationSeverity.Success, "Started", $"Sprint \"{sprint.Name}\" is now active");
    }
    catch (Exception ex)
    {
        NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
    }
}

private async Task HandleCompleteSprint(Sprint sprint)
{
    var confirmed = await DialogService.Confirm(
        $"Complete sprint \"{sprint.Name}\"?", "Complete Sprint",
        new ConfirmOptions { OkButtonText = "Complete", CancelButtonText = "Cancel" });
    if (confirmed == true)
    {
        try
        {
            await AppState.Sprints.CompleteSprintAsync(sprint.Id, sprint.Version);
            NotificationService.Notify(NotificationSeverity.Success, "Completed", "Sprint completed");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
    }
}
```

#### 1.5 Update LoadProjectAsync

Find `LoadProjectAsync` and add after loading project data:

```csharp
// After await AppState.LoadProjectAsync(ProjectId);
await RefreshSprints();
```

#### 1.6 Update HandleStateChanged

Find `HandleStateChanged` and update to refresh sprints:

```csharp
private void HandleStateChanged()
{
    _project = AppState.Projects.GetById(ProjectId);
    _sprints = AppState.Sprints.GetByProject(ProjectId).ToList();
    InvokeAsync(StateHasChanged);
}
```

**Verification**: `just build-frontend`

---

### Step 2: Add Comments Section to WorkItemDetail

**File**: `frontend/ProjectManagement.Wasm/Pages/WorkItemDetail.razor`

#### 2.1 Add Using Statement

At the top of the file, add:
```razor
@using ProjectManagement.Components.Comments
```

#### 2.2 Add Comments Section Markup

Find the main content area (after the Child Items section, around line 107). Add:

```razor
@* Comments Section *@
<div class="content-card mt-4">
    <div class="content-card-header">
        <h2 class="content-card-title">Comments</h2>
    </div>
    <CommentList WorkItemId="@WorkItemId"
                 CurrentUserId="@_currentUserId"
                 UserNameResolver="@ResolveUserName" />
</div>
```

#### 2.3 Add Code Section

Add field:
```csharp
private Guid _currentUserId;
```

In `OnInitialized()` or `OnInitializedAsync()`, add:
```csharp
_currentUserId = AppState.CurrentUser?.Id ?? Guid.Empty;
```

Add the user name resolver method:
```csharp
private string ResolveUserName(Guid userId) => userId.ToString()[..8];
```

**Note**: The `ResolveUserName` returns a truncated GUID. In a production system, you would integrate with a user service to return actual names.

**Verification**: `just build-frontend`

---

### Step 3: Fix Active Sprints Count on Home

**File**: `frontend/ProjectManagement.Wasm/Pages/Home.razor`

#### 3.1 Subscribe to Sprint Changes

In `OnInitializedAsync()`, after other subscriptions, add:
```csharp
AppState.Sprints.OnChanged += OnSprintsChanged;
```

#### 3.2 Replace Hardcoded Stats

Find where `_activeSprints` is set to 0 (around line 145):
```csharp
_activeSprints = 0;
```

Replace with:
```csharp
_activeSprints = CalculateActiveSprints();
```

#### 3.3 Add Helper Methods

Add these methods to the code section:

```csharp
private int CalculateActiveSprints()
{
    var count = 0;
    foreach (var project in _projects)
    {
        if (AppState.Sprints.GetActiveSprint(project.Id) != null)
            count++;
    }
    return count;
}

private void OnSprintsChanged()
{
    _activeSprints = CalculateActiveSprints();
    InvokeAsync(StateHasChanged);
}
```

#### 3.4 Unsubscribe in Dispose

In the `Dispose()` method, add:
```csharp
AppState.Sprints.OnChanged -= OnSprintsChanged;
```

**Verification**: `just build-frontend`

---

### Step 4: Add Integration Tests

**File**: `frontend/ProjectManagement.Components.Tests/Pages/PageIntegrationTests.cs`

#### 4.1 Add Using Statements

At the top of the file, add:
```csharp
using ProjectManagement.Components.Sprints;
using ProjectManagement.Components.Comments;
```

#### 4.2 Add Sprint Tab Tests

Add the following test region after the existing tests:

```csharp
#region ProjectDetail Sprint Tab Tests

[Fact]
public async Task ProjectDetailPage_RendersSprintsTab()
{
    // Arrange
    var projectId = Guid.NewGuid();
    var project = new Project
    {
        Id = projectId,
        Name = "Test Project",
        Description = "Test Description",
        Version = 1,
        CreatedAt = DateTime.UtcNow,
        UpdatedAt = DateTime.UtcNow,
        CreatedBy = Guid.NewGuid(),
        UpdatedBy = Guid.NewGuid()
    };
    _projectStoreMock.Setup(s => s.GetById(projectId)).Returns(project);
    _workItemStoreMock.Setup(s => s.GetByProject(projectId)).Returns(Array.Empty<WorkItem>());
    _sprintStoreMock.Setup(s => s.GetByProject(projectId)).Returns(Array.Empty<Sprint>());

    // Act
    var cut = Render<ProjectDetail>(parameters => parameters
        .Add(p => p.ProjectId, projectId));

    // Assert
    await cut.WaitForAssertionAsync(() =>
    {
        cut.Markup.Should().Contain("Sprints");
    }, timeout: TimeSpan.FromSeconds(5));
}

[Fact]
public async Task ProjectDetailPage_ShowsEmptyState_WhenNoSprints()
{
    // Arrange
    var projectId = Guid.NewGuid();
    var project = new Project
    {
        Id = projectId,
        Name = "Test Project",
        Description = "Test Description",
        Version = 1,
        CreatedAt = DateTime.UtcNow,
        UpdatedAt = DateTime.UtcNow,
        CreatedBy = Guid.NewGuid(),
        UpdatedBy = Guid.NewGuid()
    };
    _projectStoreMock.Setup(s => s.GetById(projectId)).Returns(project);
    _workItemStoreMock.Setup(s => s.GetByProject(projectId)).Returns(Array.Empty<WorkItem>());
    _sprintStoreMock.Setup(s => s.GetByProject(projectId)).Returns(Array.Empty<Sprint>());

    // Act
    var cut = Render<ProjectDetail>(parameters => parameters
        .Add(p => p.ProjectId, projectId));

    // Wait for initial render
    await cut.WaitForAssertionAsync(() =>
    {
        cut.Markup.Should().Contain("Sprints");
    }, timeout: TimeSpan.FromSeconds(5));

    // Click Sprints tab
    var sprintsTab = cut.FindAll("button.view-tab")
        .FirstOrDefault(b => b.TextContent.Contains("Sprints"));
    if (sprintsTab != null)
    {
        await cut.InvokeAsync(() => sprintsTab.Click());
    }

    // Assert
    await cut.WaitForAssertionAsync(() =>
    {
        cut.Markup.Should().Contain("No Sprints");
    }, timeout: TimeSpan.FromSeconds(5));
}

[Fact]
public async Task ProjectDetailPage_RendersSprintCards_WhenSprintsExist()
{
    // Arrange
    var projectId = Guid.NewGuid();
    var project = new Project
    {
        Id = projectId,
        Name = "Test Project",
        Description = "Test Description",
        Version = 1,
        CreatedAt = DateTime.UtcNow,
        UpdatedAt = DateTime.UtcNow,
        CreatedBy = Guid.NewGuid(),
        UpdatedBy = Guid.NewGuid()
    };
    var sprints = new[]
    {
        new Sprint
        {
            Id = Guid.NewGuid(),
            ProjectId = projectId,
            Name = "Sprint 1",
            Status = SprintStatus.Planned,
            StartDate = DateTime.Today,
            EndDate = DateTime.Today.AddDays(14),
            Version = 1,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow,
            CreatedBy = Guid.NewGuid(),
            UpdatedBy = Guid.NewGuid()
        },
        new Sprint
        {
            Id = Guid.NewGuid(),
            ProjectId = projectId,
            Name = "Sprint 2",
            Status = SprintStatus.Planned,
            StartDate = DateTime.Today.AddDays(14),
            EndDate = DateTime.Today.AddDays(28),
            Version = 1,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow,
            CreatedBy = Guid.NewGuid(),
            UpdatedBy = Guid.NewGuid()
        }
    };

    _projectStoreMock.Setup(s => s.GetById(projectId)).Returns(project);
    _workItemStoreMock.Setup(s => s.GetByProject(projectId)).Returns(Array.Empty<WorkItem>());
    _sprintStoreMock.Setup(s => s.GetByProject(projectId)).Returns(sprints);

    // Act
    var cut = Render<ProjectDetail>(parameters => parameters
        .Add(p => p.ProjectId, projectId));

    // Wait for render and click Sprints tab
    await cut.WaitForAssertionAsync(() =>
    {
        cut.Markup.Should().Contain("Sprints");
    }, timeout: TimeSpan.FromSeconds(5));

    var sprintsTab = cut.FindAll("button.view-tab")
        .FirstOrDefault(b => b.TextContent.Contains("Sprints"));
    if (sprintsTab != null)
    {
        await cut.InvokeAsync(() => sprintsTab.Click());
    }

    // Assert - SprintCards should be rendered
    await cut.WaitForAssertionAsync(() =>
    {
        var sprintCards = cut.FindComponents<SprintCard>();
        sprintCards.Should().HaveCount(2);
    }, timeout: TimeSpan.FromSeconds(5));
}

#endregion
```

#### 4.3 Add Comment Tests

Add after the Sprint tests:

```csharp
#region WorkItemDetail Comments Tests

[Fact]
public async Task WorkItemDetailPage_RendersCommentsSection()
{
    // Arrange
    var workItemId = Guid.NewGuid();
    var projectId = Guid.NewGuid();
    var workItem = new WorkItem
    {
        Id = workItemId,
        ProjectId = projectId,
        Title = "Test Task",
        ItemType = WorkItemType.Task,
        Status = "todo",
        Priority = "medium",
        Position = 1,
        Version = 1,
        CreatedAt = DateTime.UtcNow,
        UpdatedAt = DateTime.UtcNow,
        CreatedBy = Guid.NewGuid(),
        UpdatedBy = Guid.NewGuid()
    };

    _workItemStoreMock.Setup(s => s.GetById(workItemId)).Returns(workItem);
    _workItemStoreMock.Setup(s => s.GetChildren(workItemId)).Returns(Array.Empty<WorkItem>());
    _commentStoreMock.Setup(c => c.GetComments(workItemId)).Returns(new List<Comment>());

    // Act
    var cut = Render<WorkItemDetail>(parameters => parameters
        .Add(p => p.WorkItemId, workItemId));

    // Assert
    await cut.WaitForAssertionAsync(() =>
    {
        cut.Markup.Should().Contain("Comments");
        cut.FindComponents<CommentList>().Should().HaveCount(1);
    }, timeout: TimeSpan.FromSeconds(5));
}

#endregion
```

**Verification**: `just test-frontend`

---

### Step 5: Run Full Test Suite

```bash
# Build everything
just check-frontend

# Run all tests
just test-frontend

# Expected: 390 tests passing (4 new integration tests added)
# - Core: 37 tests
# - Services: 76 tests
# - Components: 277 tests (includes 4 new)
```

---

## Session 51.2 Completion Checklist ✅

After completing all steps:

- [x] `just build-frontend` passes
- [x] `just test-frontend` passes (390 tests: 37 Core + 76 Services + 277 Components)
- [x] ProjectDetail has "Sprints" tab
- [x] WorkItemDetail has "Comments" section
- [x] Home page shows active sprint count
- [x] 4 new integration tests pass

### Files Modified (4) ✅

| File | Change | Lines |
|------|--------|-------|
| `ProjectManagement.Wasm/Pages/ProjectDetail.razor` | Add Sprints tab with full CRUD | +300 |
| `ProjectManagement.Wasm/Pages/WorkItemDetail.razor` | Add Comments section | +33 |
| `ProjectManagement.Wasm/Pages/Home.razor` | Fix active sprints count | +21 |
| `ProjectManagement.Components.Tests/Pages/PageIntegrationTests.cs` | Add 4 integration tests | +212 |

---

## Key Concepts Explained

### Tab Navigation Pattern

```razor
<button class="view-tab @(_activeView == "sprints" ? "active" : "")"
        @onclick="@(() => _activeView = "sprints")">
```

Blazor tab navigation uses:
1. A state variable (`_activeView`) to track the current tab
2. Conditional CSS classes for styling (`active` class)
3. Click handlers that update the state variable
4. Conditional rendering based on `_activeView` value

### Component Composition

```razor
<CommentList WorkItemId="@WorkItemId"
             CurrentUserId="@_currentUserId"
             UserNameResolver="@ResolveUserName" />
```

The `CommentList` component is self-contained:
- It injects `ICommentStore` directly
- It handles its own loading states
- It manages comment CRUD operations
- The parent page just passes configuration props

### Event Subscription Lifecycle

```csharp
// In OnInitializedAsync
AppState.Sprints.OnChanged += OnSprintsChanged;

// In Dispose
AppState.Sprints.OnChanged -= OnSprintsChanged;
```

Always pair subscriptions with unsubscriptions to prevent:
- Memory leaks (dangling references)
- Multiple handler invocations
- Errors on disposed components

---

## Completion Summary ✅

**Session 51.2 Delivers:**

- Sprint management tab in ProjectDetail ✅
  - View all sprints with progress bars
  - Create, edit, delete sprints
  - Start and complete sprints
  - Loading and empty states
- Comment thread in WorkItemDetail ✅
  - View, add, edit, delete comments
  - Author-only edit/delete permissions
- Active sprint count on Home dashboard ✅
- 4 new integration tests ✅

**Additional Fixes During Implementation:**
- Fixed comment polling loop bug (removed `comments.OnChanged` from triggering `AppState.OnStateChanged`)
- Fixed `SprintDialog` crash (removed incorrect `<RadzenDialog>` wrapper)
- Fixed `WorkItemDetail` loading state to prevent `CommentList` remounting loop

---

## Final Verification ✅

After completing Session 51.2:

```bash
# Full check
just check  # ✅ All builds clean

# All tests
just test  # ✅ 390 tests passing

# Manual testing
just dev

# Test workflow:
# 1. Go to Home - verify Active Sprints shows count ✅
# 2. Click a project - verify "Sprints" tab exists ✅
# 3. Click Sprints tab - see empty state or sprint cards ✅
# 4. Create a sprint - fill form, save ✅
# 5. Start the sprint - click Start button ✅
# 6. Click a work item - verify Comments section ✅
# 7. Add a comment - type text, submit ✅
# 8. Complete the sprint ✅
# 9. Return to Home - verify count updated ✅
```

**Completion Date**: 2026-01-27
**Total Lines Changed**: +566 (-58)
