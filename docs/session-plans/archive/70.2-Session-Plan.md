# Session 70.2: Frontend Polish - Toast Notifications & Activity UI

**Parent Plan**: `70-Session-Plan.md`
**Prerequisite**: Session 70.1 complete
**Target**: ~40-45k tokens
**Status**: ‚è≥ Pending

---

## Scope

This session implements user-facing polish with notifications and activity history UI:

1. **Toast Notification Service** (Part 1) - Queue management, severity levels, accessibility
2. **Operation Spinner Component** (Part 2) - Loading states with ARIA
3. **Activity Log Models** (Part 3) - C# models matching backend proto
4. **Proto Converters** (Part 4) - ActivityLog serialization/deserialization
5. **WebSocket Client Methods** (Part 5) - Activity query and real-time subscriptions
6. **Activity Feed Components** (Part 6) - Main feed, item rendering, skeleton loaders

---

## Prerequisites Check

Before starting, verify:

```bash
just check-backend       # Backend from 70.1 compiles
just test-backend        # All backend tests pass
just restore-frontend    # NuGet packages restored
just build-frontend      # Frontend compiles
```

Ensure proto messages exist:
- `GetActivityLogRequest`, `ActivityLogList`, `ActivityLogEntry`
- Backend handler `handle_get_activity_log` implemented

---

## Implementation Order

### Part 1: Toast Notification Service

#### Step 1.1: Create Toast Service Interface

**Create**: `frontend/ProjectManagement.Services/Notifications/IToastService.cs`

```csharp
namespace ProjectManagement.Services.Notifications;

/// <summary>
/// Toast notification service for user feedback
/// </summary>
public interface IToastService
{
    /// <summary>
    /// Show a success toast (default: 3 seconds)
    /// </summary>
    void ShowSuccess(string message, string? title = null, int? durationMs = null);

    /// <summary>
    /// Show an error toast (default: 5 seconds, bypasses queue limit)
    /// </summary>
    void ShowError(string message, string? title = null, int? durationMs = null);

    /// <summary>
    /// Show a warning toast (default: 4 seconds)
    /// </summary>
    void ShowWarning(string message, string? title = null, int? durationMs = null);

    /// <summary>
    /// Show an info toast (default: 3 seconds)
    /// </summary>
    void ShowInfo(string message, string? title = null, int? durationMs = null);

    /// <summary>
    /// Show a toast with an action button (e.g., "Undo")
    /// </summary>
    void ShowWithAction(
        string message,
        string actionText,
        Func<Task> onAction,
        int durationMs = 5000);

    /// <summary>
    /// Clear all active toasts
    /// </summary>
    void Clear();

    /// <summary>
    /// Number of currently visible toasts (for testing)
    /// </summary>
    int ActiveCount { get; }
}
```

**Verification**: `just build-cs-services`

---

#### Step 1.2: Implement Toast Service

**Create**: `frontend/ProjectManagement.Services/Notifications/ToastService.cs`

```csharp
using Microsoft.Extensions.Logging;
using Radzen;

namespace ProjectManagement.Services.Notifications;

/// <summary>
/// Production-grade toast service with queue management
/// </summary>
public sealed class ToastService : IToastService, IDisposable
{
    private readonly NotificationService _radzen;
    private readonly ILogger<ToastService> _logger;
    private readonly object _lock = new();

    // Default durations by severity (configurable)
    public static class Defaults
    {
        public const int SuccessDurationMs = 3000;
        public const int ErrorDurationMs = 5000;
        public const int WarningDurationMs = 4000;
        public const int InfoDurationMs = 3000;
        public const int MaxConcurrentToasts = 3;
    }

    private int _activeCount;
    public int ActiveCount => _activeCount;

    public ToastService(NotificationService radzen, ILogger<ToastService> logger)
    {
        _radzen = radzen ?? throw new ArgumentNullException(nameof(radzen));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    public void ShowSuccess(string message, string? title = null, int? durationMs = null)
    {
        ArgumentNullException.ThrowIfNull(message);
        Show(NotificationSeverity.Success, message, title ?? "Success", durationMs ?? Defaults.SuccessDurationMs);
    }

    public void ShowError(string message, string? title = null, int? durationMs = null)
    {
        ArgumentNullException.ThrowIfNull(message);

        // Errors always show, don't count against limit (important feedback)
        _logger.LogWarning("User error displayed: {Message}", message);

        _radzen.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            Summary = title ?? "Error",
            Detail = message,
            Duration = durationMs ?? Defaults.ErrorDurationMs,
            CloseOnClick = true,
        });
    }

    public void ShowWarning(string message, string? title = null, int? durationMs = null)
    {
        ArgumentNullException.ThrowIfNull(message);
        Show(NotificationSeverity.Warning, message, title ?? "Warning", durationMs ?? Defaults.WarningDurationMs);
    }

    public void ShowInfo(string message, string? title = null, int? durationMs = null)
    {
        ArgumentNullException.ThrowIfNull(message);
        Show(NotificationSeverity.Info, message, title ?? "Info", durationMs ?? Defaults.InfoDurationMs);
    }

    private void Show(NotificationSeverity severity, string message, string title, int durationMs)
    {
        lock (_lock)
        {
            if (_activeCount >= Defaults.MaxConcurrentToasts)
            {
                _logger.LogDebug("Toast suppressed (queue full): {Message}", message);
                return;
            }
            _activeCount++;
        }

        _radzen.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = title,
            Detail = message,
            Duration = durationMs,
            CloseOnClick = true,
        });

        // Schedule decrement after duration
        _ = DecrementAfterDelay(durationMs);
    }

    private async Task DecrementAfterDelay(int delayMs)
    {
        await Task.Delay(delayMs).ConfigureAwait(false);
        lock (_lock)
        {
            _activeCount = Math.Max(0, _activeCount - 1);
        }
    }

    public void ShowWithAction(string message, string actionText, Func<Task> onAction, int durationMs = 5000)
    {
        // Radzen doesn't support action buttons natively
        // This would require a custom component
        throw new NotImplementedException("Use ActionToast component directly for action buttons");
    }

    public void Clear()
    {
        // Radzen doesn't expose a clear method, but we reset our counter
        lock (_lock)
        {
            _activeCount = 0;
        }
    }

    public void Dispose()
    {
        Clear();
    }
}
```

**Verification**: `just build-cs-services`

---

#### Step 1.3: Create Toast Service Tests

**Create**: `frontend/ProjectManagement.Services.Tests/Notifications/ToastServiceTests.cs`

```csharp
using FluentAssertions;
using Microsoft.Extensions.Logging.Abstractions;
using Moq;
using ProjectManagement.Services.Notifications;
using Radzen;
using Xunit;

namespace ProjectManagement.Services.Tests.Notifications;

public class ToastServiceTests
{
    private readonly Mock<NotificationService> _mockRadzen;
    private readonly ToastService _sut;

    public ToastServiceTests()
    {
        _mockRadzen = new Mock<NotificationService>();
        _sut = new ToastService(_mockRadzen.Object, NullLogger<ToastService>.Instance);
    }

    [Fact]
    public void ShowSuccess_RendersCorrectSeverity()
    {
        // Act
        _sut.ShowSuccess("Operation succeeded");

        // Assert
        _mockRadzen.Verify(
            r => r.Notify(It.Is<NotificationMessage>(m =>
                m.Severity == NotificationSeverity.Success &&
                m.Detail == "Operation succeeded")),
            Times.Once);
    }

    [Fact]
    public void ShowError_BypassesQueueLimit()
    {
        // Arrange - Fill queue to limit
        for (int i = 0; i < ToastService.Defaults.MaxConcurrentToasts; i++)
        {
            _sut.ShowInfo($"Message {i}");
        }

        // Act - Error should still show
        _sut.ShowError("Critical error");

        // Assert - 4 notifications total (3 info + 1 error)
        _mockRadzen.Verify(
            r => r.Notify(It.IsAny<NotificationMessage>()),
            Times.Exactly(4));
    }

    [Fact]
    public void ShowInfo_RespectsQueueLimit()
    {
        // Arrange - Fill queue to limit
        for (int i = 0; i < ToastService.Defaults.MaxConcurrentToasts; i++)
        {
            _sut.ShowInfo($"Message {i}");
        }

        // Act - Next info should be suppressed
        _sut.ShowInfo("This should be suppressed");

        // Assert - Only MaxConcurrentToasts notifications
        _mockRadzen.Verify(
            r => r.Notify(It.IsAny<NotificationMessage>()),
            Times.Exactly(ToastService.Defaults.MaxConcurrentToasts));
    }

    [Fact]
    public async Task ActiveCount_DecrementsAfterDuration()
    {
        // Arrange
        const int durationMs = 100;

        // Act
        _sut.ShowSuccess("Test", durationMs: durationMs);

        // Assert - Initially active
        _sut.ActiveCount.Should().Be(1);

        // Wait for duration + buffer
        await Task.Delay(durationMs + 50);

        // Assert - Decremented after duration
        _sut.ActiveCount.Should().Be(0);
    }

    [Fact]
    public void Clear_ResetsActiveCount()
    {
        // Arrange
        _sut.ShowSuccess("Message 1");
        _sut.ShowInfo("Message 2");

        // Act
        _sut.Clear();

        // Assert
        _sut.ActiveCount.Should().Be(0);
    }

    [Fact]
    public void Constructor_ThrowsOnNullDependencies()
    {
        // Act & Assert
        var act1 = () => new ToastService(null!, NullLogger<ToastService>.Instance);
        act1.Should().Throw<ArgumentNullException>();

        var act2 = () => new ToastService(_mockRadzen.Object, null!);
        act2.Should().Throw<ArgumentNullException>();
    }
}
```

**Verification**: `just test-cs-services`

---

### Part 2: Operation Spinner Component

#### Step 2.1: Create Spinner Component

**Create**: `frontend/ProjectManagement.Components/Shared/OperationSpinner.razor`

```razor
@implements IDisposable

@* Overlay for blocking operations *@
<div class="operation-spinner @(IsVisible ? "visible" : "")"
     role="progressbar"
     aria-busy="@IsVisible"
     aria-valuetext="@(Message ?? "Loading")"
     aria-label="@(Message ?? "Loading")">
    <div class="spinner-content">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        @if (!string.IsNullOrEmpty(Message))
        {
            <span class="spinner-message" aria-live="polite">@Message</span>
        }
    </div>
</div>

@code {
    /// <summary>
    /// Whether the spinner is visible
    /// </summary>
    [Parameter]
    public bool IsVisible { get; set; }

    /// <summary>
    /// Message to display below spinner
    /// </summary>
    [Parameter]
    public string? Message { get; set; }

    /// <summary>
    /// Optional cancel button callback
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    private bool _previousVisible;

    protected override void OnParametersSet()
    {
        // Announce state changes to screen readers
        if (IsVisible != _previousVisible)
        {
            _previousVisible = IsVisible;
            // State change handled by aria-live in message span
        }
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}
```

**Add CSS** to `frontend/ProjectManagement.Components/wwwroot/css/app.css`:

```css
/* Operation Spinner Overlay */
.operation-spinner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(2px);
}

.operation-spinner.visible {
    display: flex;
}

.spinner-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--rz-spacing-4, 1rem);
    background: var(--rz-base-background-color, white);
    padding: var(--rz-spacing-6, 1.5rem);
    border-radius: var(--rz-border-radius, 4px);
    box-shadow: var(--rz-shadow-8, 0 4px 20px rgba(0,0,0,0.15));
}

.spinner-message {
    font-size: var(--rz-body-font-size, 14px);
    color: var(--rz-text-color, #333);
    text-align: center;
}
```

**Verification**: `just build-cs-components`

---

### Part 3: Activity Log Models

#### Step 3.1: Create Activity Log Model

**Create**: `frontend/ProjectManagement.Core/Models/ActivityLog.cs`

```csharp
namespace ProjectManagement.Core.Models;

/// <summary>
/// Activity log entry tracking changes to entities
/// </summary>
public sealed record ActivityLog : IEntity
{
    public Guid Id { get; init; }

    /// <summary>
    /// Entity type (work_item, sprint, comment, etc.)
    /// </summary>
    public string EntityType { get; init; } = string.Empty;

    /// <summary>
    /// ID of the entity that was changed
    /// </summary>
    public Guid EntityId { get; init; }

    /// <summary>
    /// Action performed (created, updated, deleted)
    /// </summary>
    public string Action { get; init; } = string.Empty;

    /// <summary>
    /// Field that was changed (null for create/delete)
    /// </summary>
    public string? FieldName { get; init; }

    /// <summary>
    /// Previous value (null for create)
    /// </summary>
    public string? OldValue { get; init; }

    /// <summary>
    /// New value (null for delete)
    /// </summary>
    public string? NewValue { get; init; }

    /// <summary>
    /// User who made the change
    /// </summary>
    public Guid UserId { get; init; }

    /// <summary>
    /// When the change occurred
    /// </summary>
    public DateTime Timestamp { get; init; }

    /// <summary>
    /// Optional comment about the change
    /// </summary>
    public string? Comment { get; init; }
}

/// <summary>
/// Paginated list of activity log entries
/// </summary>
public sealed record ActivityLogPage
{
    public IReadOnlyList<ActivityLog> Entries { get; init; } = Array.Empty<ActivityLog>();
    public int TotalCount { get; init; }
    public bool HasMore { get; init; }
}

/// <summary>
/// Request for activity log entries
/// </summary>
public sealed record GetActivityLogRequest
{
    public string EntityType { get; init; } = string.Empty;
    public Guid EntityId { get; init; }
    public int Limit { get; init; } = 50;
    public int Offset { get; init; } = 0;
}
```

**Verification**: `just build-cs-core`

---

### Part 4: Proto Converters

#### Step 4.1: Add Activity Log Converters

**File**: `frontend/ProjectManagement.Core/Converters/ProtoConverter.cs`

Add these methods to the `ProtoConverter` class:

```csharp
// Activity Log Converters

public static Proto.GetActivityLogRequest ToProto(GetActivityLogRequest request)
{
    ArgumentNullException.ThrowIfNull(request);

    return new Proto.GetActivityLogRequest
    {
        EntityType = request.EntityType,
        EntityId = request.EntityId.ToString(),
        Limit = request.Limit,
        Offset = request.Offset,
    };
}

public static ActivityLog FromProto(Proto.ActivityLogEntry proto)
{
    ArgumentNullException.ThrowIfNull(proto);

    return new ActivityLog
    {
        Id = Guid.Parse(proto.Id),
        EntityType = proto.EntityType,
        EntityId = Guid.Parse(proto.EntityId),
        Action = proto.Action,
        FieldName = proto.FieldName,
        OldValue = proto.OldValue,
        NewValue = proto.NewValue,
        UserId = Guid.Parse(proto.UserId),
        Timestamp = DateTimeOffset.FromUnixTimeSeconds(proto.Timestamp).UtcDateTime,
        Comment = proto.Comment,
    };
}

public static ActivityLogPage FromProto(Proto.ActivityLogList proto)
{
    ArgumentNullException.ThrowIfNull(proto);

    var entries = proto.Entries
        .Select(FromProto)
        .ToList()
        .AsReadOnly();

    return new ActivityLogPage
    {
        Entries = entries,
        TotalCount = proto.TotalCount,
        HasMore = proto.HasMore,
    };
}
```

**Add tests** in `frontend/ProjectManagement.Core.Tests/Converters/ProtoConverterTests.cs`:

```csharp
[Fact]
public void GetActivityLogRequest_ToProto_ConvertsCorrectly()
{
    // Arrange
    var entityId = Guid.NewGuid();
    var request = new GetActivityLogRequest
    {
        EntityType = "work_item",
        EntityId = entityId,
        Limit = 20,
        Offset = 10,
    };

    // Act
    var proto = ProtoConverter.ToProto(request);

    // Assert
    proto.EntityType.Should().Be("work_item");
    proto.EntityId.Should().Be(entityId.ToString());
    proto.Limit.Should().Be(20);
    proto.Offset.Should().Be(10);
}

[Fact]
public void ActivityLogEntry_FromProto_ConvertsCorrectly()
{
    // Arrange
    var id = Guid.NewGuid();
    var entityId = Guid.NewGuid();
    var userId = Guid.NewGuid();
    var timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds();

    var proto = new Proto.ActivityLogEntry
    {
        Id = id.ToString(),
        EntityType = "work_item",
        EntityId = entityId.ToString(),
        Action = "updated",
        FieldName = "title",
        OldValue = "Old Title",
        NewValue = "New Title",
        UserId = userId.ToString(),
        Timestamp = timestamp,
        Comment = "Test change",
    };

    // Act
    var model = ProtoConverter.FromProto(proto);

    // Assert
    model.Id.Should().Be(id);
    model.EntityType.Should().Be("work_item");
    model.EntityId.Should().Be(entityId);
    model.Action.Should().Be("updated");
    model.FieldName.Should().Be("title");
    model.OldValue.Should().Be("Old Title");
    model.NewValue.Should().Be("New Title");
    model.UserId.Should().Be(userId);
    model.Timestamp.Should().BeCloseTo(
        DateTimeOffset.FromUnixTimeSeconds(timestamp).UtcDateTime,
        TimeSpan.FromSeconds(1));
}

[Fact]
public void ActivityLogList_FromProto_ConvertsPageCorrectly()
{
    // Arrange
    var proto = new Proto.ActivityLogList
    {
        Entries =
        {
            new Proto.ActivityLogEntry
            {
                Id = Guid.NewGuid().ToString(),
                EntityType = "work_item",
                EntityId = Guid.NewGuid().ToString(),
                Action = "created",
                UserId = Guid.NewGuid().ToString(),
                Timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
            }
        },
        TotalCount = 10,
        HasMore = true,
    };

    // Act
    var page = ProtoConverter.FromProto(proto);

    // Assert
    page.Entries.Should().HaveCount(1);
    page.TotalCount.Should().Be(10);
    page.HasMore.Should().BeTrue();
}
```

**Verification**: `just test-cs-core`

---

### Part 5: WebSocket Client Methods

#### Step 5.1: Add Activity Methods to Interface

**File**: `frontend/ProjectManagement.Core/Interfaces/IWebSocketClient.cs`

Add:

```csharp
/// <summary>
/// Get activity log for an entity with pagination
/// </summary>
Task<ActivityLogPage> GetActivityLogAsync(
    string entityType,
    Guid entityId,
    int limit = 50,
    int offset = 0,
    CancellationToken cancellationToken = default);

/// <summary>
/// Event raised when a new activity log entry is created (real-time)
/// </summary>
event Action<ActivityLog>? OnActivityLogCreated;
```

**Verification**: `just build-cs-core`

---

#### Step 5.2: Implement in WebSocket Client

**File**: `frontend/ProjectManagement.Services/WebSocket/WebSocketClient.cs`

Add event and method:

```csharp
// Event for real-time activity updates
public event Action<ActivityLog>? OnActivityLogCreated;

public async Task<ActivityLogPage> GetActivityLogAsync(
    string entityType,
    Guid entityId,
    int limit = 50,
    int offset = 0,
    CancellationToken cancellationToken = default)
{
    ArgumentException.ThrowIfNullOrEmpty(entityType);

    var request = new GetActivityLogRequest
    {
        EntityType = entityType,
        EntityId = entityId,
        Limit = limit,
        Offset = offset,
    };

    var protoRequest = ProtoConverter.ToProto(request);
    var message = new Proto.WebSocketMessage
    {
        MessageId = Guid.NewGuid().ToString(),
        Timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
        Payload = new Proto.WebSocketMessage.Types.Payload
        {
            GetActivityLogRequest = protoRequest,
        },
    };

    var response = await SendAndWaitAsync(message, cancellationToken).ConfigureAwait(false);

    if (response.Payload.ActivityLogList != null)
    {
        return ProtoConverter.FromProto(response.Payload.ActivityLogList);
    }

    if (response.Payload.Error != null)
    {
        throw new WebSocketException($"Activity log query failed: {response.Payload.Error.Message}");
    }

    throw new WebSocketException("Unexpected response type for GetActivityLog");
}
```

**Add to message handler** (in `ProcessIncomingMessage`):

```csharp
if (message.Payload.ActivityLogCreated != null)
{
    var entry = ProtoConverter.FromProto(message.Payload.ActivityLogCreated.Entry);
    OnActivityLogCreated?.Invoke(entry);
    return;
}
```

**Verification**: `just build-cs-services && just test-cs-services`

---

### Part 6: Activity Feed Components

#### Step 6.1: Create Activity Feed Component

**Create**: `frontend/ProjectManagement.Components/Activity/ActivityFeed.razor`

```razor
@implements IAsyncDisposable
@inject IWebSocketClient Client
@inject ILogger<ActivityFeed> Logger

@* Activity history with infinite scroll and real-time updates *@
<div class="activity-feed"
     role="feed"
     aria-label="Activity history"
     aria-busy="@_loading"
     tabindex="0"
     @onkeydown="HandleKeyDown">

    @if (_error != null)
    {
        <div class="activity-error" role="alert">
            <RadzenIcon Icon="error" />
            <span>@_error</span>
            <RadzenButton Text="Retry" Click="@LoadInitial" Size="ButtonSize.Small" Variant="Variant.Text" />
        </div>
    }
    else if (_loading && _entries.Count == 0)
    {
        <ActivityFeedSkeleton Rows="@PageSize" />
    }
    else if (_entries.Count == 0)
    {
        <div class="empty-state" role="status">
            <RadzenIcon Icon="history" Style="font-size: 48px; opacity: 0.3;" />
            <p>No activity yet</p>
            <small>Changes will appear here</small>
        </div>
    }
    else
    {
        <div class="activity-list" role="list">
            @foreach (var entry in _entries)
            {
                <ActivityItem Entry="@entry" @key="entry.Id" />
            }
        </div>

        @if (_hasMore)
        {
            <div class="load-more-container">
                <LoadingButton Text="Load more"
                               LoadingText="Loading..."
                               OnClick="@LoadMore"
                               IsBusy="@_loadingMore"
                               Disabled="@_loadingMore" />
            </div>
        }
    }
</div>

@code {
    [Parameter, EditorRequired]
    public string EntityType { get; set; } = default!;

    [Parameter, EditorRequired]
    public Guid EntityId { get; set; }

    [Parameter]
    public int PageSize { get; set; } = 20;

    private readonly List<ActivityLog> _entries = new();
    private bool _loading, _loadingMore, _hasMore;
    private string? _error;
    private int _offset;
    private Guid _currentEntityId;
    private bool _disposed;

    protected override async Task OnParametersSetAsync()
    {
        // Reset when entity changes
        if (_currentEntityId != EntityId)
        {
            _currentEntityId = EntityId;
            _entries.Clear();
            _offset = 0;
            _error = null;
            await LoadInitial();
        }
    }

    protected override void OnInitialized()
    {
        // Subscribe to real-time updates
        Client.OnActivityLogCreated += HandleActivityCreated;
    }

    private async Task LoadInitial()
    {
        _loading = true;
        _error = null;
        StateHasChanged();

        try
        {
            var page = await Client.GetActivityLogAsync(EntityType, EntityId, PageSize, 0);
            _entries.Clear();
            _entries.AddRange(page.Entries);
            _hasMore = page.HasMore;
            _offset = PageSize;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load activity for {EntityType} {EntityId}", EntityType, EntityId);
            _error = "Failed to load activity. Click to retry.";
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadMore()
    {
        if (_loadingMore) return; // Debounce

        _loadingMore = true;
        StateHasChanged();

        try
        {
            var page = await Client.GetActivityLogAsync(EntityType, EntityId, PageSize, _offset);
            _entries.AddRange(page.Entries);
            _hasMore = page.HasMore;
            _offset += PageSize;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load more activity");
            // Don't set error - user can retry by clicking again
        }
        finally
        {
            _loadingMore = false;
            StateHasChanged();
        }
    }

    private void HandleActivityCreated(ActivityLog activity)
    {
        // Real-time update: prepend if matches current entity
        if (activity.EntityType == EntityType && activity.EntityId == EntityId)
        {
            _entries.Insert(0, activity);
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        // Keyboard navigation: R to refresh
        if (e.Key is "r" or "R")
        {
            _ = LoadInitial();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_disposed) return;
        _disposed = true;
        Client.OnActivityLogCreated -= HandleActivityCreated;
    }
}
```

---

#### Step 6.2: Create Activity Item Component

**Create**: `frontend/ProjectManagement.Components/Activity/ActivityItem.razor`

```razor
@using System.Globalization

<article class="activity-item"
         role="listitem"
         aria-label="@AriaLabel"
         tabindex="0">
    <div class="activity-icon" aria-hidden="true">
        @switch (Entry.Action)
        {
            case "created":
                <RadzenIcon Icon="add_circle" Style="color: var(--rz-success, #4caf50)" />
                break;
            case "updated":
                <RadzenIcon Icon="edit" Style="color: var(--rz-info, #2196f3)" />
                break;
            case "deleted":
                <RadzenIcon Icon="delete" Style="color: var(--rz-danger, #f44336)" />
                break;
            default:
                <RadzenIcon Icon="history" />
                break;
        }
    </div>

    <div class="activity-content">
        <span class="activity-action">@FormatAction()</span>

        @if (!string.IsNullOrEmpty(Entry.FieldName))
        {
            <div class="activity-change" aria-label="@ChangeAriaLabel">
                <span class="field-name">@Entry.FieldName:</span>
                <span class="old-value" aria-label="Old value">@(Entry.OldValue ?? "(empty)")</span>
                <RadzenIcon Icon="arrow_forward" aria-hidden="true" Style="font-size: 14px;" />
                <span class="new-value" aria-label="New value">@(Entry.NewValue ?? "(empty)")</span>
            </div>
        }

        <time class="activity-timestamp"
              datetime="@Entry.Timestamp.ToString("O")"
              title="@Entry.Timestamp.ToLocalTime().ToString("f")">
            @FormatRelativeTime(Entry.Timestamp)
        </time>
    </div>
</article>

@code {
    [Parameter, EditorRequired]
    public ActivityLog Entry { get; set; } = default!;

    private string AriaLabel =>
        $"{Entry.Action} {Entry.FieldName ?? "item"} {FormatRelativeTime(Entry.Timestamp)}";

    private string ChangeAriaLabel =>
        $"Changed {Entry.FieldName} from {Entry.OldValue ?? "empty"} to {Entry.NewValue ?? "empty"}";

    private string FormatAction() => Entry.Action switch
    {
        "created" => "Created",
        "updated" => $"Updated {Entry.FieldName}",
        "deleted" => "Deleted",
        _ => Entry.Action
    };

    private string FormatRelativeTime(DateTime timestamp)
    {
        var span = DateTime.UtcNow - timestamp;
        return span.TotalSeconds switch
        {
            < 60 => "just now",
            < 3600 => $"{(int)span.TotalMinutes}m ago",
            < 86400 => $"{(int)span.TotalHours}h ago",
            < 604800 => $"{(int)span.TotalDays}d ago",
            _ => timestamp.ToLocalTime().ToString("MMM d", CultureInfo.CurrentCulture)
        };
    }
}
```

---

#### Step 6.3: Create Skeleton Loader

**Create**: `frontend/ProjectManagement.Components/Activity/ActivityFeedSkeleton.razor`

```razor
<div class="activity-skeleton" aria-busy="true" aria-label="Loading activity">
    @for (int i = 0; i < Rows; i++)
    {
        <div class="skeleton-item" @key="i">
            <div class="skeleton-icon"></div>
            <div class="skeleton-content">
                <div class="skeleton-text skeleton-text-title"></div>
                <div class="skeleton-text skeleton-text-subtitle"></div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Rows { get; set; } = 5;
}
```

---

#### Step 6.4: Add Activity Styles

**File**: `frontend/ProjectManagement.Components/wwwroot/css/app.css`

Add:

```css
/* Activity Feed Styles */
.activity-feed {
    padding: var(--rz-spacing-4, 1rem);
    max-height: 500px;
    overflow-y: auto;
    background: var(--rz-base-background-color, white);
    border-radius: var(--rz-border-radius, 4px);
}

.activity-feed:focus {
    outline: 2px solid var(--rz-primary, #2196f3);
    outline-offset: 2px;
}

.activity-error {
    display: flex;
    align-items: center;
    gap: var(--rz-spacing-2, 0.5rem);
    padding: var(--rz-spacing-4, 1rem);
    background: var(--rz-danger-lighter, #ffebee);
    border-radius: var(--rz-border-radius, 4px);
    color: var(--rz-danger, #f44336);
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--rz-spacing-8, 2rem);
    text-align: center;
    color: var(--rz-text-secondary-color, #666);
}

.activity-list {
    display: flex;
    flex-direction: column;
    gap: var(--rz-spacing-2, 0.5rem);
}

.activity-item {
    display: flex;
    gap: var(--rz-spacing-3, 0.75rem);
    padding: var(--rz-spacing-3, 0.75rem);
    border-bottom: 1px solid var(--rz-base-200, #e0e0e0);
    transition: background-color 0.2s;
}

.activity-item:hover {
    background: var(--rz-base-100, #f5f5f5);
}

.activity-item:focus {
    background: var(--rz-base-100, #f5f5f5);
    outline: 2px solid var(--rz-primary, #2196f3);
    outline-offset: -2px;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.activity-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: var(--rz-spacing-1, 0.25rem);
}

.activity-action {
    font-weight: 500;
    color: var(--rz-text-color, #333);
}

.activity-change {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--rz-spacing-2, 0.5rem);
    font-size: var(--rz-body-font-size-sm, 13px);
}

.field-name {
    color: var(--rz-text-secondary-color, #666);
    font-weight: 500;
}

.old-value {
    text-decoration: line-through;
    color: var(--rz-danger, #f44336);
    word-break: break-word;
}

.new-value {
    color: var(--rz-success, #4caf50);
    word-break: break-word;
    font-weight: 500;
}

.activity-timestamp {
    display: block;
    font-size: var(--rz-body-font-size-xs, 12px);
    color: var(--rz-text-tertiary-color, #999);
}

.load-more-container {
    display: flex;
    justify-content: center;
    padding: var(--rz-spacing-4, 1rem) 0;
}

/* Skeleton Loader */
.activity-skeleton {
    display: flex;
    flex-direction: column;
    gap: var(--rz-spacing-2, 0.5rem);
}

.skeleton-item {
    display: flex;
    gap: var(--rz-spacing-3, 0.75rem);
    padding: var(--rz-spacing-3, 0.75rem);
}

.skeleton-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
}

.skeleton-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--rz-spacing-2, 0.5rem);
}

.skeleton-text {
    height: 14px;
    border-radius: 4px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
}

.skeleton-text-title {
    width: 70%;
}

.skeleton-text-subtitle {
    width: 40%;
}

@keyframes skeleton-loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}
```

**Verification**: `just build-cs-components`

---

## Session 70.2 Completion Checklist

After completing all steps:

- [ ] `just build-cs-services` passes
- [ ] `just build-cs-components` passes
- [ ] `just test-cs-services` passes (all toast service tests)
- [ ] `just test-cs-core` passes (all converter tests)
- [ ] Activity feed renders without errors
- [ ] Skeleton loader displays during initial load
- [ ] "Load more" button works with pagination
- [ ] Real-time activity updates prepend to list
- [ ] Keyboard shortcut (R) refreshes feed

### Files Created (8)
- `ProjectManagement.Services/Notifications/IToastService.cs`
- `ProjectManagement.Services/Notifications/ToastService.cs`
- `ProjectManagement.Components/Shared/OperationSpinner.razor`
- `ProjectManagement.Core/Models/ActivityLog.cs`
- `ProjectManagement.Components/Activity/ActivityFeed.razor`
- `ProjectManagement.Components/Activity/ActivityItem.razor`
- `ProjectManagement.Components/Activity/ActivityFeedSkeleton.razor`
- `ProjectManagement.Services.Tests/Notifications/ToastServiceTests.cs`

### Files Modified (4)
- `ProjectManagement.Core/Converters/ProtoConverter.cs`
- `ProjectManagement.Core/Interfaces/IWebSocketClient.cs`
- `ProjectManagement.Services/WebSocket/WebSocketClient.cs`
- `ProjectManagement.Components/wwwroot/css/app.css`

---

## Next Session

**Session 70.3** will implement:
- Store toast integration (all 5 stores)
- Connection status component with latency display
- Activity sidebar in WorkItemDetail page
- Complete user documentation (5 markdown files)
- Project file updates (README, CLAUDE.md)
