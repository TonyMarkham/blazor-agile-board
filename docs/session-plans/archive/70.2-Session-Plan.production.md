# Session 70.2: Frontend Polish - Toast Notifications & Activity UI (Production)

**Parent Plan**: `70-Session-Plan.md`
**Target**: ~45-55k tokens
**Prerequisites**: Session 70.1 complete, `just check` passes
**Status**: üü° In Progress

---

## Scope

This session implements production-grade frontend polish aligned to current repo patterns:

1. **Real-time Subscriptions** (Part 0) - Fix WebSocket subscribe/unsubscribe so broadcasts deliver
2. **Activity Log Models** (Part 1) - C# models matching proto
3. **Proto Converters** (Part 2) - ActivityLog serialization/deserialization
4. **WebSocket Client Methods** (Part 3) - Activity query + real-time event
5. **Activity Feed Components** (Part 4) - Feed, item, skeleton + styles
6. **Toast Notification Service** (Part 5) - Queueing + action toasts + deterministic timing
7. **Operation Spinner** (Part 6) - Blocking overlay with ARIA
8. **Tests** (Part 7) - Subscription tests, activity UI tests, deterministic toast tests

---

## Progress Update (2026-01-30)

Completed:
- Part 0: Subscribe/Unsubscribe implemented + tests passing (`just test-cs-services`)
- Part 1: Activity log models created
- Part 2: Proto converters + tests added
- Part 3: WebSocket activity log methods + tests added
- Part 4: Activity feed components + styles added
- Part 5: Toast services + ActionToastHost + CSS + tests added; `just test-cs-services` passes

In progress / remaining:
- Part 6: OperationSpinner component + CSS + tests
- Part 7: Activity feed component tests + integration tests
- Missing: Register `INotificationService` adapter in WASM DI

Notes / deviations:
- Added `INotificationService` + `RadzenNotificationServiceAdapter` to enable deterministic unit tests (Radzen `NotificationService.Notify` is non-virtual).
- `ToastService` now depends on `INotificationService` (tests use a fake).
- Added `internal Task? LastDecrementTask` in `ToastService` for deterministic test synchronization.
- DI registration for `INotificationService` is not yet wired in `Program.cs`.

---

## Prerequisites Check

Before starting, verify:

```bash
just check          # All code compiles
just test-frontend  # Existing frontend tests pass
```

Ensure these exist:
- `GetActivityLogRequest`, `ActivityLogEntry`, `ActivityLogList`, `ActivityLogCreated` in `proto/messages.proto`
- Backend handler `handle_get_activity_log` implemented (Session 70.1)

---

## Corrections Added (2026-01-30)

### Correction A: Wire the notification adapter in DI

Commentary: Without this, `ToastService` cannot be constructed at runtime.

```csharp
// frontend/ProjectManagement.Wasm/Program.cs
builder.Services.AddScoped<INotificationService>(sp =>
    new RadzenNotificationServiceAdapter(sp.GetRequiredService<NotificationService>()));
```

### Correction B: Activity log API uses request objects (not params)

Commentary: Current repo signature is `GetActivityLogAsync(GetActivityLogRequest, CancellationToken)`.

```csharp
// frontend/ProjectManagement.Core/Interfaces/IWebSocketClient.cs
Task<ActivityLogPage> GetActivityLogAsync(
    GetActivityLogRequest request,
    CancellationToken ct = default);
```

```csharp
// frontend/ProjectManagement.Components/Activity/ActivityFeed.razor
var page = await Client.GetActivityLogAsync(new GetActivityLogRequest
{
    EntityType = EntityType,
    EntityId = EntityId,
    Limit = PageSize,
    Offset = 0
}, ct);
```

### Correction C: Tests should mock the request-object signature

Commentary: Update component tests to use `It.IsAny<GetActivityLogRequest>()`.

```csharp
client.Setup(c => c.GetActivityLogAsync(
        It.IsAny<GetActivityLogRequest>(),
        It.IsAny<CancellationToken>()))
    .ReturnsAsync(new ActivityLogPage { Entries = Array.Empty<ActivityLog>() });
```

---

## Implementation Order

### Part 0: Real-time Subscription Correctness

#### Step 0.1: Implement Subscribe/Unsubscribe in WebSocket Client

Commentary: Ensure broadcast delivery by sending explicit subscribe/unsubscribe messages and syncing local tracking.

```csharp
// frontend/ProjectManagement.Services/WebSocket/WebSocketClient.cs
public async Task SubscribeAsync(IEnumerable<Guid> projectIds, CancellationToken ct = default)
{
    ThrowIfDisposed();
    EnsureConnected();

    var ids = projectIds?.Where(id => id != Guid.Empty).Distinct().ToList() ?? new List<Guid>();
    if (ids.Count == 0) return;

    lock (_subscribedProjects)
    {
        foreach (var id in ids)
            _subscribedProjects.Add(id);
    }

    var message = new Pm.WebSocketMessage
    {
        MessageId = Guid.NewGuid().ToString(),
        Timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
        Subscribe = new Pm.Subscribe()
    };

    message.Subscribe.ProjectIds.AddRange(ids.Select(id => id.ToString()));

    await SendMessageAsync(message, ct);
    _logger.LogDebug("Subscribed to projects: {ProjectIds}", string.Join(", ", ids));
}

public async Task UnsubscribeAsync(IEnumerable<Guid> projectIds, CancellationToken ct = default)
{
    ThrowIfDisposed();
    EnsureConnected();

    var ids = projectIds?.Where(id => id != Guid.Empty).Distinct().ToList() ?? new List<Guid>();
    if (ids.Count == 0) return;

    lock (_subscribedProjects)
    {
        foreach (var id in ids)
            _subscribedProjects.Remove(id);
    }

    var message = new Pm.WebSocketMessage
    {
        MessageId = Guid.NewGuid().ToString(),
        Timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
        Unsubscribe = new Pm.Unsubscribe()
    };

    message.Unsubscribe.ProjectIds.AddRange(ids.Select(id => id.ToString()));

    await SendMessageAsync(message, ct);
    _logger.LogDebug("Unsubscribed from projects: {ProjectIds}", string.Join(", ", ids));
}
```

#### Step 0.2: Subscription Tests (MockWebSocketConnection)

Commentary: Ensure messages use the correct payload and include project IDs.

```csharp
// frontend/ProjectManagement.Services.Tests/WebSocket/WebSocketClientSubscriptionTests.cs
public async Task SubscribeAsync_SendsSubscribeMessage()
{
    var conn = new MockWebSocketConnection();
    var client = CreateClient(conn);
    await client.ConnectAsync();

    var id = Guid.NewGuid();
    await client.SubscribeAsync(new[] { id });

    var msg = Pm.WebSocketMessage.Parser.ParseFrom(conn.SentMessages.Last());
    msg.PayloadCase.Should().Be(Pm.WebSocketMessage.PayloadOneofCase.Subscribe);
    msg.Subscribe.ProjectIds.Should().Contain(id.ToString());
}
```

**Verification**: `just test-cs-services`

---

### Part 1: Activity Log Models

#### Step 1.1: Create Activity Log Model

Commentary: A normalized entry for feed rendering and audits.

```csharp
// frontend/ProjectManagement.Core/Models/ActivityLog.cs
public sealed record ActivityLog
{
    public Guid Id { get; init; }
    public string EntityType { get; init; } = string.Empty;
    public Guid EntityId { get; init; }
    public string Action { get; init; } = string.Empty;
    public string? FieldName { get; init; }
    public string? OldValue { get; init; }
    public string? NewValue { get; init; }
    public Guid UserId { get; init; }
    public DateTime Timestamp { get; init; }
    public string? Comment { get; init; }
}
```

#### Step 1.2: Create Activity Log Page Model

Commentary: Paginated list with total count and has-more flag.

```csharp
// frontend/ProjectManagement.Core/Models/ActivityLogPage.cs
public sealed record ActivityLogPage
{
    public IReadOnlyList<ActivityLog> Entries { get; init; } = Array.Empty<ActivityLog>();
    public int TotalCount { get; init; }
    public bool HasMore { get; init; }
}
```

#### Step 1.3: Create Activity Log Request Model

Commentary: Request object keeps API stable and extensible.

```csharp
// frontend/ProjectManagement.Core/Models/GetActivityLogRequest.cs
public sealed record GetActivityLogRequest
{
    public string EntityType { get; init; } = string.Empty;
    public Guid EntityId { get; init; }
    public int Limit { get; init; } = 50;
    public int Offset { get; init; } = 0;
}
```

**Verification**: `just build-cs-core`

---

### Part 2: Proto Converters

#### Step 2.1: Add Activity Log Converters

Commentary: Bidirectional mapping and null-safe handling for optional fields.

```csharp
// frontend/ProjectManagement.Core/Converters/ProtoConverter.cs
public static ActivityLog ToDomain(Proto.ActivityLogEntry proto)
{
    ArgumentNullException.ThrowIfNull(proto);

    return new ActivityLog
    {
        Id = ParseGuid(proto.Id, "ActivityLogEntry.Id"),
        EntityType = proto.EntityType ?? string.Empty,
        EntityId = ParseGuid(proto.EntityId, "ActivityLogEntry.EntityId"),
        Action = proto.Action ?? string.Empty,
        FieldName = proto.HasFieldName ? proto.FieldName : null,
        OldValue = proto.HasOldValue ? proto.OldValue : null,
        NewValue = proto.HasNewValue ? proto.NewValue : null,
        UserId = ParseGuid(proto.UserId, "ActivityLogEntry.UserId"),
        Timestamp = FromUnixTimestamp(proto.Timestamp),
        Comment = proto.HasComment ? proto.Comment : null
    };
}

public static ActivityLogPage ToDomain(Proto.ActivityLogList proto)
{
    ArgumentNullException.ThrowIfNull(proto);

    return new ActivityLogPage
    {
        Entries = proto.Entries.Select(ToDomain).ToList(),
        TotalCount = proto.TotalCount,
        HasMore = proto.HasMore
    };
}
```

#### Step 2.2: Add Converter Tests (Optional Fields)

Commentary: Ensures missing optional fields map to nulls.

```csharp
// frontend/ProjectManagement.Core.Tests/Converters/ProtoConverterTests.cs
[Fact]
public void ToDomain_ActivityLogEntry_ConvertsAllFields()
{
    var entry = new Pm.ActivityLogEntry
    {
        Id = Guid.NewGuid().ToString(),
        EntityType = "work_item",
        EntityId = Guid.NewGuid().ToString(),
        Action = "updated",
        FieldName = "title",
        OldValue = "Old",
        NewValue = "New",
        UserId = Guid.NewGuid().ToString(),
        Timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
        Comment = "Renamed"
    };

    var domain = ProtoConverter.ToDomain(entry);

    domain.FieldName.Should().Be("title");
    domain.OldValue.Should().Be("Old");
    domain.NewValue.Should().Be("New");
    domain.Comment.Should().Be("Renamed");
}
```

**Verification**: `just test-cs-core`

---

### Part 3: WebSocket Client Methods

#### Step 3.1: Activity Log Events & Requests

Commentary: Events notify real-time updates; request-object signature matches repo.

```csharp
// frontend/ProjectManagement.Core/Interfaces/IWebSocketClient.cs
event Action<ActivityLog>? OnActivityLogCreated;

Task<ActivityLogPage> GetActivityLogAsync(
    GetActivityLogRequest request,
    CancellationToken ct = default);
```

#### Step 3.2: Implement Activity Query + Broadcast Handling

Commentary: Use `GetActivityLogRequest` proto and map responses.

```csharp
// frontend/ProjectManagement.Services/WebSocket/WebSocketClient.cs
public event Action<ActivityLog>? OnActivityLogCreated;

public async Task<ActivityLogPage> GetActivityLogAsync(
    GetActivityLogRequest request,
    CancellationToken ct = default)
{
    ThrowIfDisposed();
    EnsureConnected();

    ArgumentNullException.ThrowIfNull(request);

    var message = new Pm.WebSocketMessage
    {
        MessageId = Guid.NewGuid().ToString(),
        Timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds(),
        GetActivityLogRequest = new Pm.GetActivityLogRequest
        {
            EntityType = request.EntityType,
            EntityId = request.EntityId.ToString(),
            Limit = request.Limit,
            Offset = request.Offset
        }
    };

    var response = await SendRequestAsync(message, ct);

    if (response.PayloadCase == Pm.WebSocketMessage.PayloadOneofCase.Error)
        throw new ServerRejectedException(response.Error.Code, response.Error.Message);

    if (response.PayloadCase != Pm.WebSocketMessage.PayloadOneofCase.ActivityLogList)
        throw new InvalidOperationException($"Unexpected response type: {response.PayloadCase}");

    return ProtoConverter.ToDomain(response.ActivityLogList);
}
```

```csharp
// frontend/ProjectManagement.Services/WebSocket/WebSocketClient.cs
case Pm.WebSocketMessage.PayloadOneofCase.ActivityLogCreated:
    var entry = ProtoConverter.ToDomain(message.ActivityLogCreated.Entry);
    OnActivityLogCreated?.Invoke(entry);
    break;
```

#### Step 3.3: Activity Tests (Request/Response + Event)

Commentary: Verify request mapping and broadcast event.

```csharp
// frontend/ProjectManagement.Services.Tests/WebSocket/WebSocketClientActivityLogTests.cs
[Fact]
public async Task GetActivityLogAsync_SendsRequest_AndMapsResponse()
{
    var connection = new ScriptedWebSocketConnection();
    var client = CreateClient(connection);

    connection.OnSend = request =>
    {
        request.PayloadCase.Should().Be(Pm.WebSocketMessage.PayloadOneofCase.GetActivityLogRequest);
        request.GetActivityLogRequest.EntityType.Should().Be("work_item");
        request.GetActivityLogRequest.Limit.Should().Be(25);
        request.GetActivityLogRequest.Offset.Should().Be(10);

        var response = new Pm.WebSocketMessage
        {
            MessageId = request.MessageId,
            Timestamp = request.Timestamp,
            ActivityLogList = new Pm.ActivityLogList
            {
                TotalCount = 1,
                HasMore = false
            }
        };

        response.ActivityLogList.Entries.Add(new Pm.ActivityLogEntry
        {
            Id = Guid.NewGuid().ToString(),
            EntityType = "work_item",
            EntityId = request.GetActivityLogRequest.EntityId,
            Action = "updated",
            UserId = Guid.NewGuid().ToString(),
            Timestamp = DateTimeOffset.UtcNow.ToUnixTimeSeconds()
        });

        return response;
    };

    await client.ConnectAsync();

    var result = await client.GetActivityLogAsync(new GetActivityLogRequest
    {
        EntityType = "work_item",
        EntityId = Guid.NewGuid(),
        Limit = 25,
        Offset = 10
    });

    result.TotalCount.Should().Be(1);
    result.HasMore.Should().BeFalse();
    result.Entries.Should().HaveCount(1);
}
```

**Verification**: `just test-cs-services`

---

### Part 4: Activity Feed Components

#### Step 4.1: ActivityFeed Component

Commentary: Handles initial load, pagination, and real-time prepend.

```razor
// frontend/ProjectManagement.Components/Activity/ActivityFeed.razor
@using Microsoft.AspNetCore.Components.Web
@implements IAsyncDisposable
@inject IWebSocketClient Client
@inject ILogger<ActivityFeed> Logger

<div class="activity-feed"
     role="feed"
     aria-label="Activity history"
     aria-busy="@_loading"
     tabindex="0"
     @onkeydown="HandleKeyDown">

    @if (_error != null)
    {
        <div class="activity-error" role="alert">
            <RadzenIcon Icon="error" />
            <span>@_error</span>
            <RadzenButton Text="Retry" Click="@LoadInitial" Size="ButtonSize.Small" Variant="Variant.Text" />
        </div>
    }
    else if (_loading && _entries.Count == 0)
    {
        <ActivityFeedSkeleton Rows="@PageSize" />
    }
    else if (_entries.Count == 0)
    {
        <div class="empty-state" role="status">
            <RadzenIcon Icon="history" Style="font-size: 48px; opacity: 0.3;" />
            <p>No activity yet</p>
            <small>Changes will appear here</small>
        </div>
    }
    else
    {
        <div class="activity-list" role="list">
            @foreach (var entry in _entries)
            {
                <ActivityItem Entry="@entry" @key="entry.Id" />
            }
        </div>

        @if (_hasMore)
        {
            <div class="load-more-container">
                <LoadingButton Text="Load more"
                               LoadingText="Loading..."
                               OnClick="@LoadMore"
                               IsBusy="@_loadingMore"
                               Disabled="@_loadingMore" />
            </div>
        }
    }
</div>

@code {
    [Parameter, EditorRequired] public string EntityType { get; set; } = default!;
    [Parameter, EditorRequired] public Guid EntityId { get; set; }
    [Parameter] public int PageSize { get; set; } = 20;

    private readonly List<ActivityLog> _entries = new();
    private bool _loading, _loadingMore, _hasMore;
    private string? _error;
    private int _offset;
    private Guid _currentEntityId;
    private string? _currentEntityType;
    private bool _disposed;
    private CancellationTokenSource? _loadCts;

    protected override async Task OnParametersSetAsync()
    {
        if (_currentEntityId != EntityId || _currentEntityType != EntityType)
        {
            _currentEntityId = EntityId;
            _currentEntityType = EntityType;
            _entries.Clear();
            _offset = 0;
            _error = null;
            await LoadInitial();
        }
    }

    protected override void OnInitialized()
    {
        Client.OnActivityLogCreated += HandleActivityCreated;
    }

    private async Task LoadInitial()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        _loadCts = new CancellationTokenSource();

        await LoadInitialCore(_loadCts.Token);
    }

    private async Task LoadInitialCore(CancellationToken ct)
    {
        _loading = true;
        _error = null;
        StateHasChanged();

        try
        {
            var page = await Client.GetActivityLogAsync(new GetActivityLogRequest
            {
                EntityType = EntityType,
                EntityId = EntityId,
                Limit = PageSize,
                Offset = 0
            }, ct);

            _entries.Clear();
            _entries.AddRange(page.Entries);
            _hasMore = page.HasMore;
            _offset = PageSize;
        }
        catch (OperationCanceledException)
        {
            // Cancelled by user or component disposal
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load activity for {EntityType} {EntityId}", EntityType, EntityId);
            _error = "Failed to load activity. Click to retry.";
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadMore()
    {
        if (_loadingMore) return;

        _loadingMore = true;
        StateHasChanged();

        _loadCts?.Cancel();
        _loadCts?.Dispose();
        _loadCts = new CancellationTokenSource();

        try
        {
            var page = await Client.GetActivityLogAsync(new GetActivityLogRequest
            {
                EntityType = EntityType,
                EntityId = EntityId,
                Limit = PageSize,
                Offset = _offset
            }, _loadCts.Token);

            _entries.AddRange(page.Entries);
            _hasMore = page.HasMore;
            _offset += PageSize;
        }
        catch (OperationCanceledException)
        {
            // Cancelled by user or component disposal
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load more activity");
        }
        finally
        {
            _loadingMore = false;
            StateHasChanged();
        }
    }

    private void HandleActivityCreated(ActivityLog activity)
    {
        if (activity.EntityType == EntityType && activity.EntityId == EntityId)
        {
            _entries.Insert(0, activity);
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key is "r" or "R")
            _ = LoadInitial();
    }

    public ValueTask DisposeAsync()
    {
        if (_disposed) return ValueTask.CompletedTask;
        _disposed = true;
        Client.OnActivityLogCreated -= HandleActivityCreated;
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        return ValueTask.CompletedTask;
    }
}
```

#### Step 4.2: ActivityItem Component

Commentary: Presents a single log entry with icons and accessible labels.

```razor
// frontend/ProjectManagement.Components/Activity/ActivityItem.razor
@using System.Globalization

<article class="activity-item" role="listitem" aria-label="@AriaLabel" tabindex="0">
    <div class="activity-icon" aria-hidden="true">
        @switch (Entry.Action)
        {
            case "created":
                <RadzenIcon Icon="add_circle" Style="color: var(--rz-success, #4caf50)" />
                break;
            case "updated":
                <RadzenIcon Icon="edit" Style="color: var(--rz-info, #2196f3)" />
                break;
            case "deleted":
                <RadzenIcon Icon="delete" Style="color: var(--rz-danger, #f44336)" />
                break;
            default:
                <RadzenIcon Icon="history" />
                break;
        }
    </div>

    <div class="activity-content">
        <span class="activity-action">@FormatAction()</span>

        @if (!string.IsNullOrEmpty(Entry.FieldName))
        {
            <div class="activity-change" aria-label="@ChangeAriaLabel">
                <span class="field-name">@Entry.FieldName:</span>
                <span class="old-value">@(Entry.OldValue ?? "(empty)")</span>
                <RadzenIcon Icon="arrow_forward" aria-hidden="true" Style="font-size: 14px;" />
                <span class="new-value">@(Entry.NewValue ?? "(empty)")</span>
            </div>
        }

        <time class="activity-timestamp"
              datetime="@TimestampIso"
              title="@TimestampTitle">
            @FormatRelativeTime(Entry.Timestamp)
        </time>
    </div>
</article>

@code {
    [Parameter] public ActivityLog Entry { get; set; } = default!;

    private string AriaLabel =>
        $"{Entry.Action} {Entry.FieldName ?? "item"} {FormatRelativeTime(Entry.Timestamp)}";

    private string ChangeAriaLabel =>
        $"Changed {Entry.FieldName} from {Entry.OldValue ?? "empty"} to {Entry.NewValue ?? "empty"}";

    private string TimestampIso => Entry.Timestamp.ToString("O");
    private string TimestampTitle => Entry.Timestamp.ToLocalTime().ToString("f");

    private string FormatAction() => Entry.Action switch
    {
        "created" => "Created",
        "updated" => $"Updated {Entry.FieldName}",
        "deleted" => "Deleted",
        _ => Entry.Action
    };

    private string FormatRelativeTime(DateTime timestamp)
    {
        var span = DateTime.UtcNow - timestamp;

        if (span.TotalSeconds < 60)
            return "just now";

        if (span.TotalSeconds < 3600)
            return $"{(int)span.TotalMinutes}m ago";

        if (span.TotalSeconds < 86400)
            return $"{(int)span.TotalHours}h ago";

        if (span.TotalSeconds < 604800)
            return $"{(int)span.TotalDays}d ago";

        return timestamp.ToLocalTime().ToString("MMM d", CultureInfo.CurrentCulture);
    }
}
```

#### Step 4.3: Activity Feed Skeleton

Commentary: Skeleton maintains layout and accessibility during loading.

```razor
// frontend/ProjectManagement.Components/Activity/ActivityFeedSkeleton.razor
<div class="activity-skeleton" aria-busy="true" aria-label="Loading activity">
    @for (int i = 0; i < Rows; i++)
    {
        <div class="skeleton-item" @key="i">
            <div class="skeleton-icon"></div>
            <div class="skeleton-content">
                <div class="skeleton-text skeleton-text-title"></div>
                <div class="skeleton-text skeleton-text-subtitle"></div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Rows { get; set; } = 5;
}
```

#### Step 4.4: Activity Styles

Commentary: UI styling for feed, entries, and skeleton.

```css
/* frontend/ProjectManagement.Components/wwwroot/css/app.css */
.activity-feed {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 12px 0;
}

.activity-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.activity-item {
    display: grid;
    grid-template-columns: 32px 1fr;
    gap: 12px;
    padding: 12px;
    background: var(--rz-base-background-color, #fff);
    border: 1px solid var(--rz-border-color, #e6e6e6);
    border-radius: 10px;
}

.activity-item:focus-visible {
    outline: 2px solid var(--rz-primary, #2563eb);
    outline-offset: 2px;
}

.activity-action {
    font-weight: 600;
}

.activity-change {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    color: var(--rz-text-secondary, #6b7280);
}

.activity-timestamp {
    display: block;
    margin-top: 6px;
    font-size: 0.8rem;
    color: var(--rz-text-secondary, #6b7280);
}

.activity-error {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border: 1px solid var(--rz-danger, #f44336);
    border-radius: 8px;
    background: rgba(244, 67, 54, 0.06);
}

.load-more-container {
    display: flex;
    justify-content: center;
    margin-top: 8px;
}

.activity-skeleton {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.skeleton-item {
    display: grid;
    grid-template-columns: 32px 1fr;
    gap: 12px;
    padding: 12px;
    border: 1px solid var(--rz-border-color, #e6e6e6);
    border-radius: 10px;
    background: var(--rz-base-background-color, #fff);
}

.skeleton-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e5e7eb;
}

.skeleton-text {
    height: 10px;
    background: #e5e7eb;
    border-radius: 6px;
    margin-bottom: 8px;
}

.skeleton-text-title { width: 55%; }
.skeleton-text-subtitle { width: 35%; }
```

**Verification**: `just build-cs-components`

---

### Part 5: Toast Notification Service

#### Step 5.1: Notification Service Abstraction

Commentary: Radzen `NotificationService.Notify` is non-virtual; adapter allows deterministic tests.

```csharp
// frontend/ProjectManagement.Services/Notifications/INotificationService.cs
public interface INotificationService
{
    void Notify(NotificationMessage message);
}
```

```csharp
// frontend/ProjectManagement.Services/Notifications/RadzenNotificationServiceAdapter.cs
public sealed class RadzenNotificationServiceAdapter : INotificationService
{
    private readonly NotificationService _radzen;

    public RadzenNotificationServiceAdapter(NotificationService radzen)
    {
        _radzen = radzen ?? throw new ArgumentNullException(nameof(radzen));
    }

    public void Notify(NotificationMessage message)
    {
        _radzen.Notify(message);
    }
}
```

#### Step 5.2: Toast Service Implementation (Queue + Actions)

Commentary: Prevents toast spam, supports action toasts, and is testable.

```csharp
// frontend/ProjectManagement.Services/Notifications/ToastService.cs
public sealed class ToastService : IToastService, IDisposable
{
    private readonly INotificationService _radzen;
    private readonly ILogger<ToastService> _logger;
    private readonly IToastScheduler _scheduler;
    private readonly object _lock = new();

    public static class Defaults
    {
        public const int SuccessDurationMs = 3000;
        public const int ErrorDurationMs = 5000;
        public const int WarningDurationMs = 4000;
        public const int InfoDurationMs = 3000;
        public const int ActionDurationMs = 5000;
        public const int MaxConcurrentToasts = 3;
        public const int MaxActionToasts = 2;
    }

    private int _activeCount;
    public int ActiveCount => _activeCount;
    internal Task? LastDecrementTask { get; private set; }

    private readonly List<ActionToastRequest> _actionToasts = new();
    public IReadOnlyList<ActionToastRequest> ActionToasts => _actionToasts.AsReadOnly();
    public event Action? OnActionToastsChanged;

    public ToastService(INotificationService radzen, ILogger<ToastService> logger, IToastScheduler scheduler)
    {
        _radzen = radzen ?? throw new ArgumentNullException(nameof(radzen));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        _scheduler = scheduler ?? throw new ArgumentNullException(nameof(scheduler));
    }

    public void ShowSuccess(string message, string? title = null, int? durationMs = null)
    {
        ArgumentNullException.ThrowIfNull(message);
        Show(NotificationSeverity.Success, message, title ?? "Success", durationMs ?? Defaults.SuccessDurationMs);
    }

    public void ShowError(string message, string? title = null, int? durationMs = null)
    {
        ArgumentNullException.ThrowIfNull(message);
        _logger.LogWarning("User error displayed: {Message}", message);

        _radzen.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            Summary = title ?? "Error",
            Detail = message,
            Duration = durationMs ?? Defaults.ErrorDurationMs,
            CloseOnClick = true,
        });
    }

    public void ShowWarning(string message, string? title = null, int? durationMs = null)
    {
        ArgumentNullException.ThrowIfNull(message);
        Show(NotificationSeverity.Warning, message, title ?? "Warning", durationMs ?? Defaults.WarningDurationMs);
    }

    public void ShowInfo(string message, string? title = null, int? durationMs = null)
    {
        ArgumentNullException.ThrowIfNull(message);
        Show(NotificationSeverity.Info, message, title ?? "Info", durationMs ?? Defaults.InfoDurationMs);
    }

    public void ShowWithAction(string message, string actionText, Func<Task> onAction, int durationMs = 5000)
    {
        ArgumentNullException.ThrowIfNull(message);
        ArgumentNullException.ThrowIfNull(actionText);
        ArgumentNullException.ThrowIfNull(onAction);

        ActionToastRequest request;
        lock (_lock)
        {
            if (_actionToasts.Count >= Defaults.MaxActionToasts)
            {
                _logger.LogDebug("Action toast suppressed (queue full): {Message}", message);
                return;
            }

            request = new ActionToastRequest
            {
                Message = message,
                ActionText = actionText,
                OnAction = onAction,
                DurationMs = durationMs
            };
            _actionToasts.Add(request);
        }

        OnActionToastsChanged?.Invoke();
    }

    public void DismissActionToast(Guid id)
    {
        lock (_lock)
        {
            var index = _actionToasts.FindIndex(t => t.Id == id);
            if (index >= 0)
                _actionToasts.RemoveAt(index);
        }

        OnActionToastsChanged?.Invoke();
    }

    public void Clear()
    {
        lock (_lock)
        {
            _activeCount = 0;
            _actionToasts.Clear();
        }

        OnActionToastsChanged?.Invoke();
    }

    private void Show(NotificationSeverity severity, string message, string title, int durationMs)
    {
        lock (_lock)
        {
            if (_activeCount >= Defaults.MaxConcurrentToasts)
            {
                _logger.LogDebug("Toast suppressed (queue full): {Message}", message);
                return;
            }
            _activeCount++;
        }

        _radzen.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = title,
            Detail = message,
            Duration = durationMs,
            CloseOnClick = true,
        });

        LastDecrementTask = DecrementAfterDelay(durationMs);
    }

    private async Task DecrementAfterDelay(int delayMs)
    {
        await _scheduler.DelayAsync(delayMs).ConfigureAwait(false);
        lock (_lock)
        {
            _activeCount = Math.Max(0, _activeCount - 1);
        }
    }

    public void Dispose()
    {
        Clear();
    }
}
```

#### Step 5.3: Action Toast Host

Commentary: Displays action toasts in the UI and wires callbacks.

```razor
// frontend/ProjectManagement.Components/Shared/ActionToastHost.razor
@implements IDisposable
@inject ProjectManagement.Services.Notifications.IToastService Toasts

<div class="action-toast-host" aria-live="polite" aria-atomic="true">
    @foreach (var toast in Toasts.ActionToasts)
    {
        <div class="action-toast" role="status">
            <span>@toast.Message</span>
            <div class="action-toast-buttons">
                <RadzenButton Text="@toast.ActionText"
                              Size="ButtonSize.Small"
                              Click="@(() => HandleAction(toast))" />
                <RadzenButton Icon="close"
                              Size="ButtonSize.Small"
                              ButtonStyle="ButtonStyle.Light"
                              Click="@(() => Toasts.DismissActionToast(toast.Id))" />
            </div>
        </div>
    }
</div>

@code {
    protected override void OnInitialized()
    {
        Toasts.OnActionToastsChanged += HandleActionToastsChanged;
    }

    private async Task HandleAction(ActionToastRequest toast)
    {
        await toast.OnAction();
        Toasts.DismissActionToast(toast.Id);
    }

    private void HandleActionToastsChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Toasts.OnActionToastsChanged -= HandleActionToastsChanged;
    }
}
```

#### Step 5.4: Action Toast Styles

Commentary: Consistent styling and spacing.

```css
/* frontend/ProjectManagement.Components/wwwroot/css/app.css */
.action-toast-host {
    position: fixed;
    bottom: 24px;
    right: 24px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 1000;
}

.action-toast {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 14px;
    min-width: 260px;
    background: var(--rz-base-background-color, #fff);
    border: 1px solid var(--rz-border-color, #e6e6e6);
    border-radius: 10px;
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
}

.action-toast-buttons {
    display: inline-flex;
    gap: 6px;
}
```

#### Step 5.5: Wire Toasts in DI and Layout

Commentary: Registers services and renders host.

```csharp
// frontend/ProjectManagement.Wasm/Program.cs
builder.Services.AddScoped<INotificationService>(sp =>
    new RadzenNotificationServiceAdapter(sp.GetRequiredService<NotificationService>()));
builder.Services.AddScoped<IToastService, ToastService>();
builder.Services.AddScoped<IToastScheduler, ToastScheduler>();
```

```razor
// frontend/ProjectManagement.Wasm/Layout/MainLayout.razor
<ActionToastHost />
```

#### Step 5.6: Toast Tests (Deterministic)

Commentary: Fake scheduler controls timing for predictable assertions.

```csharp
// frontend/ProjectManagement.Services.Tests/Notifications/ToastServiceTests.cs
[Fact]
public void ShowSuccess_RespectsQueueLimit()
{
    var (sut, radzen, _) = Create();

    for (int i = 0; i < ToastService.Defaults.MaxConcurrentToasts + 1; i++)
        sut.ShowSuccess($"Message {i}");

    radzen.NotifyCount.Should().Be(ToastService.Defaults.MaxConcurrentToasts);
}
```

**Verification**: `just test-cs-services`

---

### Part 6: Operation Spinner

#### Step 6.1: OperationSpinner Component

Commentary: A blocking overlay with ARIA for long operations.

```razor
// frontend/ProjectManagement.Components/Shared/OperationSpinner.razor
<div class="operation-spinner @(IsVisible ? "visible" : "")"
     role="progressbar"
     aria-busy="@IsVisible"
     aria-valuetext="@(Message ?? "Loading")"
     aria-label="@(Message ?? "Loading")">
    <div class="spinner-content">
        <RadzenProgressBarCircular ShowValue="false"
                                   Mode="ProgressBarMode.Indeterminate"
                                   Size="ProgressBarCircularSize.Large" />
        @if (!string.IsNullOrEmpty(Message))
        {
            <span class="spinner-message" aria-live="polite">@Message</span>
        }
        @if (OnCancel.HasDelegate)
        {
            <RadzenButton Text="Cancel"
                          Size="ButtonSize.Small"
                          ButtonStyle="ButtonStyle.Light"
                          Click="@OnCancel" />
        }
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public string? Message { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
}
```

#### Step 6.2: OperationSpinner Styles

Commentary: Overlay and content styles.

```css
/* frontend/ProjectManagement.Components/wwwroot/css/app.css */
.operation-spinner {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
}

.operation-spinner.visible {
    display: flex;
}

.spinner-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    background: var(--rz-base-background-color, #fff);
    border: 1px solid var(--rz-border-color, #e6e6e6);
    padding: 18px 20px;
    border-radius: 12px;
}

.spinner-message {
    font-size: 0.95rem;
    color: var(--rz-text-secondary, #6b7280);
}
```

#### Step 6.3: OperationSpinner Tests

Commentary: Validates basic rendering and ARIA attributes.

```csharp
// frontend/ProjectManagement.Components.Tests/Shared/OperationSpinnerTests.cs
[Fact]
public void OperationSpinner_Renders_WhenVisible()
{
    var cut = Render<OperationSpinner>(p => p.Add(x => x.IsVisible, true));
    cut.Markup.Should().Contain("operation-spinner");
    cut.Markup.Should().Contain("aria-busy=\"True\"");
}
```

**Verification**: `just test-cs-components`

---

### Part 7: Activity Feed Tests

#### Step 7.1: Activity Feed Component Tests

Commentary: Ensure loading, error, and data states render correctly.

```csharp
// frontend/ProjectManagement.Components.Tests/Activity/ActivityFeedTests.cs
[Fact]
public void ActivityFeed_ShowsSkeleton_WhileLoading()
{
    var client = new Mock<IWebSocketClient>();
    var tcs = new TaskCompletionSource<ActivityLogPage>();

    client.Setup(c => c.GetActivityLogAsync(
            It.IsAny<GetActivityLogRequest>(),
            It.IsAny<CancellationToken>()))
        .Returns(tcs.Task);

    Services.AddSingleton(client.Object);
    Services.AddLogging();

    var cut = Render<ActivityFeed>(p => p
        .Add(x => x.EntityType, "work_item")
        .Add(x => x.EntityId, Guid.NewGuid())
        .Add(x => x.PageSize, 20));

    cut.FindAll(".activity-skeleton").Count.Should().Be(1);
}
```

#### Step 7.2: Activity Feed Integration Test

Commentary: Verify real-time prepend behavior.

```csharp
// frontend/ProjectManagement.Components.Tests/Activity/ActivityFeedIntegrationTests.cs
[Fact]
public void ActivityFeed_PrependsEntry_OnRealtimeEvent()
{
    var client = new Mock<IWebSocketClient>();
    var entityId = Guid.NewGuid();

    client.Setup(c => c.GetActivityLogAsync(
            It.IsAny<GetActivityLogRequest>(),
            It.IsAny<CancellationToken>()))
        .ReturnsAsync(new ActivityLogPage
        {
            Entries = new List<ActivityLog>
            {
                new() { Id = Guid.NewGuid(), EntityType = "work_item", EntityId = entityId, Action = "created", Timestamp = DateTime.UtcNow }
            },
            HasMore = false,
            TotalCount = 1
        });

    Services.AddSingleton(client.Object);
    Services.AddLogging();

    var cut = Render<ActivityFeed>(p => p
        .Add(x => x.EntityType, "work_item")
        .Add(x => x.EntityId, entityId)
        .Add(x => x.PageSize, 20));

    cut.FindAll(".activity-item").Count.Should().Be(1);

    var incoming = new ActivityLog
    {
        Id = Guid.NewGuid(),
        EntityType = "work_item",
        EntityId = entityId,
        Action = "updated",
        Timestamp = DateTime.UtcNow
    };

    client.Raise(c => c.OnActivityLogCreated += null, incoming);

    cut.WaitForAssertion(() => cut.FindAll(".activity-item").Count.Should().Be(2));
}
```

**Verification**: `just test-cs-components`

---

## Completion Checklist

Status: ‚úÖ Complete (user-reported builds clean + all tests pass)

- [x] `just test-cs-services` passes (subscriptions + toast tests)
- [x] `just test-cs-core` passes (converter tests)
- [x] `just test-cs-components` passes (activity + spinner tests)
- [x] Activity feed renders without errors
- [x] Skeleton loader displays during initial load
- [x] ‚ÄúLoad more‚Äù button works with pagination
- [x] Real-time activity updates prepend to list (with subscriptions enabled)
- [x] Toasts render reliably and tests are deterministic

---

## Files Summary

### Create

- `frontend/ProjectManagement.Services.Tests/WebSocket/WebSocketClientSubscriptionTests.cs`
- `frontend/ProjectManagement.Services.Tests/WebSocket/WebSocketClientActivityTests.cs`
- `frontend/ProjectManagement.Core/Models/ActivityLog.cs`
- `frontend/ProjectManagement.Core/Models/ActivityLogPage.cs`
- `frontend/ProjectManagement.Core/Models/GetActivityLogRequest.cs`
- `frontend/ProjectManagement.Components/Activity/ActivityFeed.razor`
- `frontend/ProjectManagement.Components/Activity/ActivityItem.razor`
- `frontend/ProjectManagement.Components/Activity/ActivityFeedSkeleton.razor`
- `frontend/ProjectManagement.Services/Notifications/IToastService.cs`
- `frontend/ProjectManagement.Services/Notifications/ActionToastRequest.cs`
- `frontend/ProjectManagement.Services/Notifications/IToastScheduler.cs`
- `frontend/ProjectManagement.Services/Notifications/ToastScheduler.cs`
- `frontend/ProjectManagement.Services/Notifications/ToastService.cs`
- `frontend/ProjectManagement.Services/Notifications/INotificationService.cs`
- `frontend/ProjectManagement.Services/Notifications/RadzenNotificationServiceAdapter.cs`
- `frontend/ProjectManagement.Components/Shared/ActionToastHost.razor`
- `frontend/ProjectManagement.Components/Shared/OperationSpinner.razor`
- `frontend/ProjectManagement.Components.Tests/Shared/OperationSpinnerTests.cs`
- `frontend/ProjectManagement.Components.Tests/Activity/ActivityFeedTests.cs`
- `frontend/ProjectManagement.Components.Tests/Activity/ActivityFeedIntegrationTests.cs`

### Modify

- `frontend/ProjectManagement.Core/Converters/ProtoConverter.cs`
- `frontend/ProjectManagement.Core/Interfaces/IWebSocketClient.cs`
- `frontend/ProjectManagement.Services/WebSocket/WebSocketClient.cs`
- `frontend/ProjectManagement.Components/wwwroot/css/app.css`
- `frontend/ProjectManagement.Wasm/Layout/MainLayout.razor`
- `frontend/ProjectManagement.Wasm/Program.cs`
