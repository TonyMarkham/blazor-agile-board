# Session 80.3: AddDependencyDialog + A11y + Tests

**Parent Plan**: `80-Session-Plan-Teaching.md`
**Target**: ~40-50k tokens
**Prerequisites**: Session 80.2 complete

---

## Scope

Build the dependency creation dialog with accessible listbox navigation, canonical direction logic, and error handling.

1. **Dialog UI with search, type selection, and results**
2. **Roving tabindex / `aria-activedescendant`**
3. **Backend validation error handling**
4. **Unit tests for filtering and keyboard selection**

---

## Teaching Goals

- Implement accessible listbox patterns.
- Enforce canonical dependency direction.
- Handle validation errors without closing the dialog.

## Gap Resolution (Production-Grade Decisions)

These resolve known gaps and remove assumptions:

1. **ViewModel source**: Inject `ViewModelFactory` directly into `AddDependencyDialog`.
   - Rationale: `AppState` does not expose `ViewModelFactory`, and expanding AppState is out of scope.
2. **Dialog pattern alignment**: Follow existing dialog patterns from `WorkItemDialog.razor`.
   - Rationale: consistent UX and error handling.
3. **A11y approach**: Use `aria-activedescendant` for listbox navigation.
   - Rationale: simpler focus management in Blazor, still fully accessible.

---

## Implementation Order

### Step 1: Create AddDependencyDialog

**File**: `frontend/ProjectManagement.Components/Dependencies/AddDependencyDialog.razor`

**Required injections (explicit):**
- `IDependencyStore` (create + existing links)
- `AppState` (work item store)
- `ViewModelFactory` (build view models)
- `DialogService` (close dialog on success)

Key behaviors:
- Filter within project work items only (`AppState.WorkItems.GetByProject`).
- Use `ViewModelFactory.CreateMany(...)` for display models.
- Exclude current item and existing links.
- Cap results (top 50) unless a backend search exists.
- Debounce search input.
- Build request with canonical direction (Blocks: selected -> current, Relates: current -> selected).

Reference snippet in `docs/session-plans/80-Session-Plan-Initial.md`.

---

### Step 2: Add Accessible Keyboard Navigation

Use `aria-activedescendant` for listbox navigation:
- Arrow keys move active item
- Enter selects active item
- `aria-selected` reflects active state

---

### Step 3: Add Error Handling

Catch validation exceptions from `DependencyStore.CreateAsync`, keep the dialog open,
and surface inline errors. (Toast notifications already occur in the store.)

---

### Step 4: Add Unit Tests

Tests to include:
- Current item is excluded
- Existing dependencies are excluded
- Enter triggers selection
- Active option changes with arrow keys
- Canonical direction request mapping

---

## Completion Checklist

- [ ] Dialog renders with search, type dropdown, and results
- [ ] Accessible listbox interaction works via keyboard
- [ ] Errors are surfaced inline without closing
- [ ] bUnit tests added and pass
- [ ] `just build-cs-components` passes
- [ ] `just test-cs-components` passes

---

## Next Session

**Session 80.4** builds `DependencyManager`, wires the page, and adds the blocked indicator.
