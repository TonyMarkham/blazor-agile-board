  @using ProjectManagement.Core.Models
  @using ProjectManagement.Core.Validation
  @using ProjectManagement.Services.Desktop
  @inject UserIdentityService UserService
  @inject ILogger<UserRegistrationScreen> Logger

  <div class="registration-screen">
      <div class="registration-content" role="form" aria-labelledby="reg-title">
          <div class="app-logo" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="64" height="64">
                  <path fill="currentColor" d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
          </div>

          <h1 id="reg-title" class="title">Welcome to Project Manager</h1>
          <p class="subtitle">Let's set up your workspace</p>

          <div class="form-section">
              <div class="form-group">
                  <label for="name-input" class="form-label">
                      Your Name
                      <span class="optional-badge">(optional)</span>
                  </label>
                  <input
                      id="name-input"
                      type="text"
                      class="form-input @(NameError != null ? "input-error" : "")"
                      placeholder="Enter your name"
                      maxlength="@RegistrationValidator.MaxNameLength"
                      @bind="Name"
                      @bind:event="oninput"
                      @onfocus="ClearNameError"
                      aria-describedby="@(NameError != null ? "name-error" : null)"
                      aria-invalid="@(NameError != null)" />
                  @if (NameError != null)
                  {
                      <p id="name-error" class="field-error" role="alert">@NameError</p>
                  }
              </div>

              <div class="form-group">
                  <label for="email-input" class="form-label">
                      Email
                      <span class="optional-badge">(optional)</span>
                  </label>
                  <input
                      id="email-input"
                      type="email"
                      class="form-input @(EmailError != null ? "input-error" : "")"
                      placeholder="you@example.com"
                      maxlength="@RegistrationValidator.MaxEmailLength"
                      @bind="Email"
                      @bind:event="oninput"
                      @onfocus="ClearEmailError"
                      aria-describedby="@(EmailError != null ? "email-error" : null)"
                      aria-invalid="@(EmailError != null)" />
                  @if (EmailError != null)
                  {
                      <p id="email-error" class="field-error" role="alert">@EmailError</p>
                  }
              </div>

              @if (GeneralError != null)
              {
                  <div class="general-error" role="alert">
                      <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                          <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                      </svg>
                      <span>@GeneralError</span>
                  </div>
              }

              <button
                  type="button"
                  class="btn btn-primary btn-submit"
                  @onclick="OnGetStartedAsync"
                  disabled="@IsCreating"
                  aria-busy="@IsCreating">
                  @if (IsCreating)
                  {
                      <span class="btn-spinner" aria-hidden="true"></span>
                      <span>Creating...</span>
                  }
                  else
                  {
                      <span>Get Started</span>
                      <svg class="btn-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                          <path fill="currentColor" d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
                      </svg>
                  }
              </button>
          </div>

          <p class="privacy-note">
              <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                  <path fill="currentColor" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
              </svg>
              Your information stays on this device and is never sent to external servers.
          </p>
      </div>
  </div>

  @code {
      // Error messages
      private const string ErrorSomethingWentWrong = "Something went wrong. Please try again.";

      // Validation field identifiers
      private const string FieldName = "Name";
      private const string FieldEmail = "email";

      [Parameter] public EventCallback<UserIdentity> OnUserCreated { get; set; }
      [Parameter] public EventCallback<string> OnError { get; set; }

      private string? Name;
      private string? Email;
      private bool IsCreating;
      private string? NameError;
      private string? EmailError;
      private string? GeneralError;

      private void ClearNameError() => NameError = null;
      private void ClearEmailError() => EmailError = null;

      private bool ValidateForm()
      {
          var validation = RegistrationValidator.Validate(Name, Email);

          if (validation.IsValid)
          {
              NameError = null;
              EmailError = null;
              return true;
          }

          foreach (var error in validation.Errors)
          {
              if (error.Field.Equals(FieldName, StringComparison.OrdinalIgnoreCase))
                  NameError = error.Message;
              else if (error.Field.Equals(FieldEmail, StringComparison.OrdinalIgnoreCase))
                  EmailError = error.Message;
          }

          return false;
      }

      private async Task OnGetStartedAsync()
      {
          if (IsCreating) return;

          GeneralError = null;

          if (!ValidateForm())
          {
              return;
          }

          IsCreating = true;
          StateHasChanged();

          try
          {
              var user = await UserService.CreateNewUserAsync(Name, Email);
              Logger.LogInformation("User registered: {UserId}", user.Id);
              await OnUserCreated.InvokeAsync(user);
          }
          catch (ArgumentException ex)
          {
              Logger.LogWarning(ex, "Validation error during registration");
              GeneralError = ex.Message;
          }
          catch (Exception ex)
          {
              Logger.LogError(ex, "Failed to create user");
              GeneralError = ErrorSomethingWentWrong;
              await OnError.InvokeAsync(GeneralError);
          }
          finally
          {
              IsCreating = false;
              StateHasChanged();
          }
      }
  }