@using ProjectManagement.Core.Models
@using ProjectManagement.Core.ViewModels
@inject AppState AppState
@inject ViewModelFactory ViewModelFactory
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@implements IDisposable
@inject ILogger<KanbanBoard> Logger

<div class="kanban-board"
     role="application"
     aria-label="Kanban board"
     aria-describedby="kanban-instructions">

    @* Screen reader instructions *@
    <div id="kanban-instructions" class="visually-hidden">
        Kanban board with @Columns.Count columns. Drag cards between columns to change status. Use arrow keys to navigate between columns when dragging.
    </div>

    @* Live announcements *@
    <div class="visually-hidden" role="status" aria-live="polite" aria-atomic="true">
        @_announcement
    </div>

    @* Filters *@
    <RadzenStack Orientation="Orientation.Horizontal"
                 Gap="1rem"
                 AlignItems="AlignItems.Center"
                 class="mb-3">
        <RadzenDropDown @bind-Value="_typeFilter"
                        TValue="WorkItemType?"
                        Data="@TypeOptions"
                        TextProperty="Text"
                        ValueProperty="Value"
                        Placeholder="All Types"
                        AllowClear="true"
                        Style="width: 140px;"
                        Change="@(_ => ApplyFilters())" />
        <RadzenStack Orientation="Orientation.Horizontal"
                     AlignItems="AlignItems.Center"
                     Gap="0.5rem">
            <RadzenCheckBox @bind-Value="_hideDone" TValue="bool" Change="@(_ => ApplyFilters())" />
            <RadzenText TextStyle="TextStyle.Body2">Hide Done</RadzenText>
        </RadzenStack>
        <div class="flex-grow-1"></div>
        <RadzenText TextStyle="TextStyle.Body2" class="text-muted">
            @_filteredItems.Count items
        </RadzenText>
    </RadzenStack>

    @* Columns with HTML5 Drag-Drop *@
  <div class="kanban-columns">
      @foreach (var column in Columns)
      {
          if (_hideDone && column.Status == "done") continue;

          var status = column.Status;
          var columnItems = _columnItems.GetValueOrDefault(status) ?? new List<WorkItemViewModel>();

          <div class="kanban-column @(status == _dragOverColumn ? "drag-over" : "")"
               role="listbox"
               aria-label="@($"{column.Title} column, {columnItems.Count} items")"
               @ondragover:preventDefault
               @ondragenter="@(() => _dragOverColumn = status)"
               @ondragleave="@(() => { if (_dragOverColumn == status) _dragOverColumn = null; })"
               @ondrop="@(() => HandleDrop(status))">

              @* Column header *@
              <div class="kanban-column-header">
                  <RadzenText TextStyle="TextStyle.Subtitle1" class="m-0">
                      @column.Title
                  </RadzenText>
                  <RadzenBadge BadgeStyle="@GetBadgeStyle(status)"
                               Text="@columnItems.Count.ToString()"
                               IsPill="true" />
              </div>

              @* Column body with virtualized cards *@
              @if (columnItems.Count == 0)
              {
                  <div class="kanban-empty-column">
                      <RadzenIcon Icon="inbox" Style="font-size: 1.5rem; opacity: 0.5;" />
                      <RadzenText TextStyle="TextStyle.Caption" class="text-muted mt-2">
                          No items
                      </RadzenText>
                  </div>
              }
              else
              {
                  <div class="kanban-column-body">
                      @foreach (var item in columnItems)
                      {
                          <div draggable="true"
                               @key="item.Id"
                               @ondragstart="@((DragEventArgs e) => HandleDragStart(e, item.Id))"
                               @ondragend="@(() => _draggedItemId = null)">
                              <KanbanCard Item="@item"
                                          ProjectKey="@_projectKey"
                                          IsConnected="@_isConnected"
                                          OnClick="@HandleCardClick"
                                          OnEdit="@HandleCardEdit" />
                          </div>
                      }
                  </div>
              }
          </div>
      }
  </div>
</div>

@code {
    [Parameter, EditorRequired] public Guid ProjectId { get; set; }

    [Parameter] public EventCallback<WorkItemViewModel> OnWorkItemSelected { get; set; }
    
    // State
    private List<WorkItemViewModel> _allItems = new();
    private List<WorkItemViewModel> _filteredItems = new();
    private Dictionary<string, List<WorkItemViewModel>> _columnItems = new();
    private bool _isConnected = true;
    private string _announcement = "";
    private string? _projectKey;
    private Guid? _draggedItemId;
    private string? _dragOverColumn;
    private Guid _lastProjectId;

    // Filters
    private WorkItemType? _typeFilter;
    private bool _hideDone;

    // Column definitions
    private static readonly List<(string Status, string Title)> Columns = new()
    {
        ("backlog", "Backlog"),
        ("todo", "To Do"),
        ("in_progress", "In Progress"),
        ("review", "Review"),
        ("done", "Done")
    };

    private static readonly List<object> TypeOptions = new()
    {
        new { Text = "Epic", Value = WorkItemType.Epic },
        new { Text = "Story", Value = WorkItemType.Story },
        new { Text = "Task", Value = WorkItemType.Task }
    };

    protected override void OnInitialized()
    {
        _isConnected = AppState.ConnectionState == ConnectionState.Connected;
        _lastProjectId = ProjectId;
        AppState.WorkItems.OnChanged += HandleWorkItemsChanged;
        AppState.OnConnectionStateChanged += HandleConnectionChanged;
        RefreshData();
    }

    protected override void OnParametersSet()
    {
        if (ProjectId != _lastProjectId)
        {
            _lastProjectId = ProjectId;
            RefreshData();
        }
    }

    private void RefreshData()
    {
        _allItems = ViewModelFactory.CreateMany(AppState.WorkItems.GetByProject(ProjectId)).ToList();
        _projectKey = AppState.Projects.GetById(ProjectId)?.Key;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = _allItems.AsEnumerable();

        if (_typeFilter.HasValue)
        {
            query = query.Where(w => w.ItemType == _typeFilter.Value);
        }

        if (_hideDone)
        {
            query = query.Where(w => w.Status != "done");
        }

        _filteredItems = query.ToList();

        _columnItems = _filteredItems
            .GroupBy(item => item.Status)
            .ToDictionary(g => g.Key, g => g.OrderBy(w => w.Position).ToList());
    }

    private void HandleDragStart(DragEventArgs e, Guid itemId)
    {
        _draggedItemId = itemId;
    }

    private async Task HandleDrop(string newStatus)
    {
        _dragOverColumn = null;

        if (_draggedItemId is not { } draggedId || !_isConnected)
            return;

        var item = _filteredItems.FirstOrDefault(i => i.Id == draggedId);
        _draggedItemId = null;

        if (item == null || item.Status == newStatus)
            return;

        var column = Columns.FirstOrDefault(c => c.Status == newStatus);
        if (column == default)
        {
            Logger.LogWarning("Unknown status {Status} during drop", newStatus);
            return;
        }
        var columnTitle = column.Title;

        _announcement = $"Moving {item.Title} to {columnTitle}...";
        StateHasChanged();

        try
        {
            var request = new UpdateWorkItemRequest
            {
                WorkItemId = item.Id,
                ExpectedVersion = item.Version,
                Status = newStatus
            };
            await AppState.WorkItems.UpdateAsync(request);

            _announcement = $"{item.Title} moved to {columnTitle}.";
            NotificationService.Notify(NotificationSeverity.Success, "Moved", $"Moved to {columnTitle}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to move work item {ItemId} to status {Status}", item.Id, newStatus);
            _announcement = $"Failed to move {item.Title}: {ex.Message}";
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }

        StateHasChanged();
    }

    private static BadgeStyle GetBadgeStyle(string status) => status switch
    {
        "backlog" => BadgeStyle.Light,
        "todo" => BadgeStyle.Info,
        "in_progress" => BadgeStyle.Warning,
        "review" => BadgeStyle.Secondary,
        "done" => BadgeStyle.Success,
        _ => BadgeStyle.Light
    };

    private async Task HandleCardClick(WorkItemViewModel item)
    {
        if (OnWorkItemSelected.HasDelegate)
        {
            await OnWorkItemSelected.InvokeAsync(item);
        }
        else
        {
            NavigationManager.NavigateTo($"/workitem/{item.Id}");
        }
    }

    private async Task HandleCardEdit(WorkItemViewModel item)
    {
        var result = await DialogService.OpenAsync<WorkItemDialog>(
            "Edit Work Item",
            new Dictionary<string, object>
            {
                { "WorkItem", item },
                { "ProjectId", item.ProjectId }
            },
            new DialogOptions
            {
                Width = "900px", // Wider default
                Height = "80vh", // 80% of viewport height
                Resizable = true, // ðŸ‘ˆ Adds resize handles
                Draggable = true // Keep it draggable
            });

        if (result is true)
        {
            RefreshData();
        }
    }

    private void HandleWorkItemsChanged()
    {
        InvokeAsync(() =>
        {
            RefreshData();
            StateHasChanged();
        });
    }

    private void HandleConnectionChanged(ConnectionState state)
    {
        _isConnected = state == ConnectionState.Connected;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AppState.WorkItems.OnChanged -= HandleWorkItemsChanged;
        AppState.OnConnectionStateChanged -= HandleConnectionChanged;
    }

}
