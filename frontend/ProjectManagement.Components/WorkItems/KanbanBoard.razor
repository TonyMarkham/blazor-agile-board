@using ProjectManagement.Core.Models
@using ProjectManagement.Core.ViewModels
@inject AppState AppState
@inject ViewModelFactory ViewModelFactory
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@implements IDisposable

<div class="kanban-board"
     role="application"
     aria-label="Kanban board"
     aria-describedby="kanban-instructions">

    @* Screen reader instructions *@
    <div id="kanban-instructions" class="visually-hidden">
        Kanban board with @Columns.Count columns. Drag cards between columns to change status.
    </div>

    @* Live announcements *@
    <div class="visually-hidden" role="status" aria-live="polite" aria-atomic="true">
        @_announcement
    </div>

    @* Filters *@
    <RadzenStack Orientation="Orientation.Horizontal"
                 Gap="1rem"
                 AlignItems="AlignItems.Center"
                 class="mb-3">
        <RadzenDropDown @bind-Value="_typeFilter"
                        TValue="WorkItemType?"
                        Data="@TypeOptions"
                        TextProperty="Text"
                        ValueProperty="Value"
                        Placeholder="All Types"
                        AllowClear="true"
                        Style="width: 140px;"
                        Change="@(_ => ApplyFilters())" />
        <RadzenStack Orientation="Orientation.Horizontal"
                     AlignItems="AlignItems.Center"
                     Gap="0.5rem">
            <RadzenCheckBox @bind-Value="_hideDone" TValue="bool" Change="@(_ => ApplyFilters())" />
            <RadzenText TextStyle="TextStyle.Body2">Hide Done</RadzenText>
        </RadzenStack>
        <div class="flex-grow-1"></div>
        <RadzenText TextStyle="TextStyle.Body2" class="text-muted">
            @_filteredItems.Count items
        </RadzenText>
    </RadzenStack>

    @* Columns with Radzen Drag-Drop *@
    <RadzenDropZoneContainer TItem="WorkItemViewModel"
                             Data="@_filteredItems"
                             ItemSelector="@((item, zone) => item.Status == (zone.Value as string))"
                             Drop="@OnDrop">
        <ChildContent>
            <div class="kanban-columns">
                @foreach (var column in Columns)
                {
                    if (_hideDone && column.Status == "done") continue;

                    <KanbanColumn Status="@column.Status"
                                  Title="@column.Title"
                                  Items="@GetColumnItems(column.Status)"
                                  IsConnected="@_isConnected"
                                  OnCardClick="@HandleCardClick"
                                  OnCardEdit="@HandleCardEdit" />
                }
            </div>
        </ChildContent>
        <Template Context="item">
            <KanbanCard Item="@item"
                        IsConnected="@_isConnected"
                        OnClick="@HandleCardClick"
                        OnEdit="@HandleCardEdit" />
        </Template>
    </RadzenDropZoneContainer>
</div>

@code {
    [Parameter, EditorRequired]
    public Guid ProjectId { get; set; }

    [Parameter]
    public EventCallback<WorkItemViewModel> OnWorkItemSelected { get; set; }

    // State
    private List<WorkItemViewModel> _allItems = new();
    private List<WorkItemViewModel> _filteredItems = new();
    private bool _isConnected = true;
    private string _announcement = "";

    // Filters
    private WorkItemType? _typeFilter;
    private bool _hideDone;

    // Column definitions
    private static readonly List<(string Status, string Title)> Columns = new()
    {
        ("backlog", "Backlog"),
        ("todo", "To Do"),
        ("in_progress", "In Progress"),
        ("review", "Review"),
        ("done", "Done")
    };

    private static readonly List<object> TypeOptions = new()
    {
        new { Text = "Epic", Value = WorkItemType.Epic },
        new { Text = "Story", Value = WorkItemType.Story },
        new { Text = "Task", Value = WorkItemType.Task }
    };

    protected override void OnInitialized()
    {
        _isConnected = AppState.ConnectionState == ConnectionState.Connected;
        AppState.OnStateChanged += HandleStateChanged;
        AppState.OnConnectionStateChanged += HandleConnectionChanged;
        RefreshData();
    }

    protected override void OnParametersSet()
    {
        RefreshData();
    }

    private void RefreshData()
    {
        var items = AppState.WorkItems.GetByProject(ProjectId)
            .Where(w => w.DeletedAt is null);

        _allItems = ViewModelFactory.CreateMany(items).ToList();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        var query = _allItems.AsEnumerable();

        if (_typeFilter.HasValue)
        {
            query = query.Where(w => w.ItemType == _typeFilter.Value);
        }

        if (_hideDone)
        {
            query = query.Where(w => w.Status != "done");
        }

        _filteredItems = query.ToList();
        StateHasChanged();
    }

    private IEnumerable<WorkItemViewModel> GetColumnItems(string status)
    {
        return _filteredItems
            .Where(w => w.Status == status)
            .OrderBy(w => w.Position);
    }

    private async void OnDrop(RadzenDropZoneItemEventArgs<WorkItemViewModel> args)
    {
        if (args.Item == null || args.ToZone?.Value == null || !_isConnected)
            return;

        var newStatus = (string)args.ToZone.Value;
        if (args.Item.Status == newStatus)
            return;

        var columnTitle = Columns.First(c => c.Status == newStatus).Title;
        _announcement = $"Moving {args.Item.Title} to {columnTitle}...";
        StateHasChanged();

        try
        {
            var request = new UpdateWorkItemRequest
            {
                WorkItemId = args.Item.Id,
                ExpectedVersion = args.Item.Version,
                Status = newStatus
            };
            await AppState.WorkItems.UpdateAsync(request);

            _announcement = $"{args.Item.Title} moved to {columnTitle}.";
            NotificationService.Notify(NotificationSeverity.Success, "Moved", $"Moved to {columnTitle}");
        }
        catch (Exception ex)
        {
            _announcement = $"Failed to move {args.Item.Title}: {ex.Message}";
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleCardClick(WorkItemViewModel item)
    {
        if (OnWorkItemSelected.HasDelegate)
        {
            await OnWorkItemSelected.InvokeAsync(item);
        }
        else
        {
            NavigationManager.NavigateTo($"/workitem/{item.Id}");
        }
    }

    private async Task HandleCardEdit(WorkItemViewModel item)
    {
        var result = await DialogService.OpenAsync<WorkItemDialog>(
            "Edit Work Item",
            new Dictionary<string, object>
            {
                { "WorkItem", item },
                { "ProjectId", item.ProjectId }
            },
            new DialogOptions { Width = "600px" });

        if (result is true)
        {
            RefreshData();
        }
    }

    private void HandleStateChanged()
    {
        RefreshData();
        InvokeAsync(StateHasChanged);
    }

    private void HandleConnectionChanged(ConnectionState state)
    {
        _isConnected = state == ConnectionState.Connected;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AppState.OnStateChanged -= HandleStateChanged;
        AppState.OnConnectionStateChanged -= HandleConnectionChanged;
    }
}
